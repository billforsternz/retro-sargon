   1:			;***********************************************************
   2:			;
   3:			;               SARGON
   4:			;
   5:			;       Sargon is a computer chess playing program designed
   6:			; and coded by Dan and Kathe Spracklen.  Copyright 1978. All
   7:			; rights reserved.  No part of this publication may be
   8:			; reproduced without the prior written permission.
   9:			;***********************************************************
  10:			
  11:			;***********************************************************
  12:			; EQUATES
  13:			;***********************************************************
  14:			;
  15:	0001          	PAWN    EQU     1
  16:	0002          	KNIGHT  EQU     2
  17:	0003          	BISHOP  EQU     3
  18:	0004          	ROOK    EQU     4
  19:	0005          	QUEEN   EQU     5
  20:	0006          	KING    EQU     6
  21:	0000          	WHITE   EQU     0
  22:	0080          	BLACK   EQU     80H
  23:	0081          	BPAWN   EQU     BLACK+PAWN
  24:			
  25:			;***********************************************************
  26:			; TABLES SECTION
  27:			;***********************************************************
  28:	0000          	START:
  29:	0080          	        ORG     START+80H
  30:	0100          	TBASE   EQU     START+100H
  31:			;***********************************************************
  32:			; DIRECT  --  Direction Table.  Used to determine the dir-
  33:			;             ection of movement of each piece.
  34:			;***********************************************************
  35:	FF80          	DIRECT EQU      $-TBASE
  36:	0080  090BF5F7	        DB      +09,+11,-11,-09
  37:	0084  0AF601FF	        DB      +10,-10,+01,-01
  38:	0088  EBF40813	        DB      -21,-12,+08,+19
  39:	008C  150CF8ED	        DB      +21,+12,-08,-19
  40:	0090  0A0A0B09	        DB      +10,+10,+11,+09
  41:	0094  F6F6F5F7	        DB      -10,-10,-11,-09
  42:			;***********************************************************
  43:			; DPOINT  --  Direction Table Pointer. Used to determine
  44:			;             where to begin in the direction table for any
  45:			;             given piece.
  46:			;***********************************************************
  47:	FF98          	DPOINT EQU      $-TBASE
  48:	0098  14100800	        DB      20,16,8,0,4,0,0
	      040000
  49:			
  50:			;***********************************************************
  51:			; DCOUNT  --  Direction Table Counter. Used to determine
  52:			;             the number of directions of movement for any
  53:			;             given piece.
  54:			;***********************************************************
  55:	FF9F          	DCOUNT EQU      $-TBASE
  56:	009F  04040804	        DB      4,4,8,4,4,8,8
	      040808
  57:			
  58:			;***********************************************************
  59:			; PVALUE  --  Point Value. Gives the point value of each
  60:			;             piece, or the worth of each piece.
  61:			;***********************************************************
  62:	FFA5          	PVALUE EQU      $-TBASE-1
  63:	00A6  01030305	        DB      1,3,3,5,9,10
	      090A
  64:			
  65:			;***********************************************************
  66:			; PIECES  --  The initial arrangement of the first rank of
  67:			;             pieces on the board. Use to set up the board
  68:			;             for the start of the game.
  69:			;***********************************************************
  70:	FFAC          	PIECES EQU      $-TBASE
  71:	00AC  04020305	        DB      4,2,3,5,6,3,2,4
	      06030204
  72:			
  73:			;***********************************************************
  74:			; BOARD   --  Board Array.  Used to hold the current position
  75:			;             of the board during play. The board itself
  76:			;             looks like:
  77:			;             FFFFFFFFFFFFFFFFFFFF
  78:			;             FFFFFFFFFFFFFFFFFFFF
  79:			;             FF0402030506030204FF
  80:			;             FF0101010101010101FF
  81:			;             FF0000000000000000FF
  82:			;             FF0000000000000000FF
  83:			;             FF0000000000000060FF
  84:			;             FF0000000000000000FF
  85:			;             FF8181818181818181FF
  86:			;             FF8482838586838284FF
  87:			;             FFFFFFFFFFFFFFFFFFFF
  88:			;             FFFFFFFFFFFFFFFFFFFF
  89:			;             The values of FF form the border of the
  90:			;             board, and are used to indicate when a piece
  91:			;             moves off the board. The individual bits of
  92:			;             the other bytes in the board array are as
  93:			;             follows:
  94:			;             Bit 7 -- Color of the piece
  95:			;                     1 -- Black
  96:			;                     0 -- White
  97:			;             Bit 6 -- Not used
  98:			;             Bit 5 -- Not used
  99:			;             Bit 4 --Castle flag for Kings only
 100:			;             Bit 3 -- Piece has moved flag
 101:			;             Bits 2-0 Piece type
 102:			;                     1 -- Pawn
 103:			;                     2 -- Knight
 104:			;                     3 -- Bishop
 105:			;                     4 -- Rook
 106:			;                     5 -- Queen
 107:			;                     6 -- King
 108:			;                     7 -- Not used
 109:			;                     0 -- Empty Square
 110:			;***********************************************************
 111:	FFB4          	BOARD   EQU     $-TBASE
 112:	00B4          	BOARDA  DS      120
 113:			
 114:			;***********************************************************
 115:			; ATKLIST -- Attack List. A two part array, the first
 116:			;            half for white and the second half for black.
 117:			;            It is used to hold the attackers of any given
 118:			;            square in the order of their value.
 119:			;
 120:			; WACT   --  White Attack Count. This is the first
 121:			;            byte of the array and tells how many pieces are
 122:			;            in the white portion of the attack list.
 123:			;
 124:			; BACT   --  Black Attack Count. This is the eighth byte of
 125:			;            the array and does the same for black.
 126:			;***********************************************************
 127:	012C          	WACT    EQU     ATKLST
 128:	0133          	BACT    EQU     ATKLST+7
 129:	012C  00000000	ATKLST  DW      0,0,0,0,0,0,0
	      00000000
	      00000000
	      0000
 130:			
 131:			;***********************************************************
 132:			; PLIST   --  Pinned Piece Array. This is a two part array.
 133:			;             PLISTA contains the pinned piece position.
 134:			;             PLISTD contains the direction from the pinned
 135:			;             piece to the attacker.
 136:			;***********************************************************
 137:	0039          	PLIST   EQU     $-TBASE-1
 138:	0043          	PLISTD  EQU     PLIST+10
 139:	013A  00000000	PLISTA  DW      0,0,0,0,0,0,0,0,0,0
	      00000000
	      00000000
	      00000000
	      00000000
 140:			
 141:			;***********************************************************
 142:			; POSK    --  Position of Kings. A two byte area, the first
 143:			;             byte of which hold the position of the white
 144:			;             king and the second holding the position of
 145:			;             the black king.
 146:			;
 147:			; POSQ    --  Position of Queens. Like POSK,but for queens.
 148:			;***********************************************************
 149:	014E  185F    	POSK    DB      24,95
 150:	0150  0E5E    	POSQ    DB      14,94
 151:	0152  FF      	        DB      -1
 152:			
 153:			;***********************************************************
 154:			; SCORE   --  Score Array. Used during Alpha-Beta pruning to
 155:			;             hold the scores at each ply. It includes two
 156:			;             "dummy" entries for ply -1 and ply 0.
 157:			;***********************************************************
 158:	0153  00000000	SCORE   DW      0,0,0,0,0,0
	      00000000
	      00000000
 159:			
 160:			;***********************************************************
 161:			; PLYIX   --  Ply Table. Contains pairs of pointers, a pair
 162:			;             for each ply. The first pointer points to the
 163:			;             top of the list of possible moves at that ply.
 164:			;             The second pointer points to which move in the
 165:			;             list is the one currently being considered.
 166:			;***********************************************************
 167:	015F  00000000	PLYIX   DW      0,0,0,0,0,0,0,0,0,0
	      00000000
	      00000000
	      00000000
	      00000000
 168:	0173  00000000	        DW      0,0,0,0,0,0,0,0,0,0
	      00000000
	      00000000
	      00000000
	      00000000
 169:			
 170:			;***********************************************************
 171:			; STACK   --  Contains the stack for the program.
 172:			;***********************************************************
 173:	02FF          	        ORG     START+2FFH
 174:	02FF          	STACK:
 175:			
 176:			;***********************************************************
 177:			; TABLE INDICES SECTION
 178:			;
 179:			; M1-M4   --  Working indices used to index into
 180:			;             the board array.
 181:			;
 182:			; T1-T3   --  Working indices used to index into Direction
 183:			;             Count, Direction Value, and Piece Value tables.
 184:			;
 185:			; INDX1   --  General working indices. Used for various
 186:			; INDX2       purposes.
 187:			;
 188:			; NPINS   --  Number of Pins. Count and pointer into the
 189:			;             pinned piece list.
 190:			;
 191:			; MLPTRI  --  Pointer into the ply table which tells
 192:			;             which pair of pointers are in current use.
 193:			;
 194:			; MLPTRJ  --  Pointer into the move list to the move that is
 195:			;             currently being processed.
 196:			;
 197:			; SCRIX   --  Score Index. Pointer to the score table for
 198:			;             the ply being examined.
 199:			;
 200:			; BESTM   --  Pointer into the move list for the move that
 201:			;             is currently considered the best by the
 202:			;             Alpha-Beta pruning process.
 203:			;
 204:			; MLLST   --  Pointer to the previous move placed in the move
 205:			;             list. Used during generation of the move list.
 206:			;
 207:			; MLNXT   --  Pointer to the next available space in the move
 208:			;             list.
 209:			;
 210:			;***********************************************************
 211:	0000          	        ORG     START+0
 212:	0000  0001    	M1      DW      TBASE
 213:	0002  0001    	M2      DW      TBASE
 214:	0004  0001    	M3      DW      TBASE
 215:	0006  0001    	M4      DW      TBASE
 216:	0008  0001    	T1      DW      TBASE
 217:	000A  0001    	T2      DW      TBASE
 218:	000C  0001    	T3      DW      TBASE
 219:	000E  0001    	INDX1   DW      TBASE
 220:	0010  0001    	INDX2   DW      TBASE
 221:	0012  0001    	NPINS   DW      TBASE
 222:	0014  5F01    	MLPTRI  DW      PLYIX
 223:	0016  0000    	MLPTRJ  DW      0
 224:	0018  0000    	SCRIX   DW      0
 225:	001A  0000    	BESTM   DW      0
 226:	001C  0000    	MLLST   DW      0
 227:	001E  0003    	MLNXT   DW      MLIST
 228:			
 229:			;***********************************************************
 230:			; VARIABLES SECTION
 231:			;
 232:			; KOLOR   --  Indicates computer's color. White is 0, and
 233:			;             Black is 80H.
 234:			;
 235:			; COLOR   --  Indicates color of the side with the move.
 236:			;
 237:			; P1-P3   --  Working area to hold the contents of the board
 238:			;             array for a given square.
 239:			;
 240:			; PMATE   --  The move number at which a checkmate is
 241:			;             discovered during look ahead.
 242:			;
 243:			; MOVENO  --  Current move number.
 244:			;
 245:			; PLYMAX  --  Maximum depth of search using Alpha-Beta
 246:			;             pruning.
 247:			;
 248:			; NPLY    --  Current ply number during Alpha-Beta
 249:			;             pruning.
 250:			;
 251:			; CKFLG   --  A non-zero value indicates the king is in check.
 252:			;
 253:			; MATEF   --  A zero value indicates no legal moves.
 254:			;
 255:			; VALM    --  The score of the current move being examined.
 256:			;
 257:			; BRDC    --  A measure of mobility equal to the total number
 258:			;             of squares white can move to minus the number
 259:			;             black can move to.
 260:			;
 261:			; PTSL    --  The maximum number of points which could be lost
 262:			;             through an exchange by the player not on the
 263:			;             move.
 264:			;
 265:			; PTSW1   --  The maximum number of points which could be won
 266:			;             through an exchange by the player not on the
 267:			;             move.
 268:			;
 269:			; PTSW2   --  The second highest number of points which could
 270:			;             be won through a different exchange by the player
 271:			;             not on the move.
 272:			;
 273:			; MTRL    --  A measure of the difference in material
 274:			;             currently on the board. It is the total value of
 275:			;             the white pieces minus the total value of the
 276:			;             black pieces.
 277:			;
 278:			; BC0     --  The value of board control(BRDC) at ply 0.
 279:			;
 280:			; MV0     --  The value of material(MTRL) at ply 0.
 281:			;
 282:			; PTSCK   --  A non-zero value indicates that the piece has
 283:			;             just moved itself into a losing exchange of
 284:			;             material.
 285:			;
 286:			; BMOVES  --  Our very tiny book of openings. Determines
 287:			;             the first move for the computer.
 288:			;
 289:			;***********************************************************
 290:	0020  00      	KOLOR   DB      0
 291:	0021  00      	COLOR   DB      0
 292:	0022  00      	P1      DB      0
 293:	0023  00      	P2      DB      0
 294:	0024  00      	P3      DB      0
 295:	0025  00      	PMATE   DB      0
 296:	0026  00      	MOVENO  DB      0
 297:	0027  02      	PLYMAX  DB      2
 298:	0028  00      	NPLY    DB      0
 299:	0029  00      	CKFLG   DB      0
 300:	002A  00      	MATEF   DB      0
 301:	002B  00      	VALM    DB      0
 302:	002C  00      	BRDC    DB      0
 303:	002D  00      	PTSL    DB      0
 304:	002E  00      	PTSW1   DB      0
 305:	002F  00      	PTSW2   DB      0
 306:	0030  00      	MTRL    DB      0
 307:	0031  00      	BC0     DB      0
 308:	0032  00      	MV0     DB      0
 309:	0033  00      	PTSCK   DB      0
 310:	0034  233710  	BMOVES  DB      35,55,10H
 311:	0037  223610  	        DB      34,54,10H
 312:	003A  554110  	        DB      85,65,10H
 313:	003D  544010  	        DB      84,64,10H
 314:			
 315:			;***********************************************************
 316:			; MOVE LIST SECTION
 317:			;
 318:			; MLIST   --  A 2048 byte storage area for generated moves.
 319:			;             This area must be large enough to hold all
 320:			;             the moves for a single leg of the move tree.
 321:			;
 322:			; MLEND   --  The address of the last available location
 323:			;             in the move list.
 324:			;
 325:			; MLPTR   --  The Move List is a linked list of individual
 326:			;             moves each of which is 6 bytes in length. The
 327:			;             move list pointer(MLPTR) is the link field
 328:			;             within a move.
 329:			;
 330:			; MLFRP   --  The field in the move entry which gives the
 331:			;             board position from which the piece is moving.
 332:			;
 333:			; MLTOP   --  The field in the move entry which gives the
 334:			;             board position to which the piece is moving.
 335:			;
 336:			; MLFLG   --  A field in the move entry which contains flag
 337:			;             information. The meaning of each bit is as
 338:			;             follows:
 339:			;             Bit 7  --  The color of any captured piece
 340:			;                        0 -- White
 341:			;                        1 -- Black
 342:			;             Bit 6  --  Double move flag (set for castling and
 343:			;                        en passant pawn captures)
 344:			;             Bit 5  --  Pawn Promotion flag; set when pawn
 345:			;                        promotes.
 346:			;             Bit 4  --  When set, this flag indicates that
 347:			;                        this is the first move for the
 348:			;                        piece on the move.
 349:			;             Bit 3  --  This flag is set is there is a piece
 350:			;                        captured, and that piece has moved at
 351:			;                        least once.
 352:			;             Bits 2-0   Describe the captured piece.  A
 353:			;                        zero value indicates no capture.
 354:			;
 355:			; MLVAL   --  The field in the move entry which contains the
 356:			;             score assigned to the move.
 357:			;
 358:			;***********************************************************
 359:	0300          	        ORG     START+300H
 360:	0300          	MLIST   DS      2048
 361:	0AF8          	MLEND   EQU     MLIST+2040
 362:	0000          	MLPTR   EQU     0
 363:	0002          	MLFRP   EQU     2
 364:	0003          	MLTOP   EQU     3
 365:	0004          	MLFLG   EQU     4
 366:	0005          	MLVAL   EQU     5
 367:			
 368:			;***********************************************************
 369:			; PROGRAM CODE SECTION
 370:			;***********************************************************
 371:			; BOARD SETUP ROUTINE
 372:			;***********************************************************
 373:			; FUNCTION:   To initialize the board array, setting the
 374:			;             pieces in their initial positions for the
 375:			;             start of the game.
 376:			;
 377:			; CALLED BY:  DRIVER
 378:			;
 379:			; CALLS:      None
 380:			;
 381:			; ARGUMENTS:  None
 382:			;***********************************************************
 383:	0B00  0678    	INITBD: LD      b,120           ; Pre-fill board with -1's
 384:	0B02  21B400  	        LD      hl,BOARDA
 385:	0B05  36FF    	back01: LD      (hl),-1
 386:	0B07  23      	        INC     hl
 387:	0B08  10FB    	        DJNZ    back01
 388:	0B0A  0608    	        LD      b,8
 389:	0B0C  DD21B400	        LD      ix,BOARDA
 390:	0B10  DD7EF8  	IB2:    LD      a,(ix-8)        ; Fill non-border squares
 391:	0B13  DD7715  	        LD      (ix+21),a       ; White pieces
 392:	0B16  CBFF    	        SET     7,a             ; Change to black
 393:	0B18  DD775B  	        LD      (ix+91),a       ; Black pieces
 394:	0B1B  DD361F01	        LD      (ix+31),PAWN    ; White Pawns
 395:	0B1F  DD365181	        LD      (ix+81),BPAWN   ; Black Pawns
 396:	0B23  DD362900	        LD      (ix+41),0       ; Empty squares
 397:	0B27  DD363300	        LD      (ix+51),0
 398:	0B2B  DD363D00	        LD      (ix+61),0
 399:	0B2F  DD364700	        LD      (ix+71),0
 400:	0B33  DD23    	        INC     ix
 401:	0B35  10D9    	        DJNZ    IB2
 402:	0B37  DD214E01	        LD      ix,POSK         ; Init King/Queen position list
 403:	0B3B  DD360019	        LD      (ix+0),25
 404:	0B3F  DD36015F	        LD      (ix+1),95
 405:	0B43  DD360218	        LD      (ix+2),24
 406:	0B47  DD36035E	        LD      (ix+3),94
 407:	0B4B  C9      	        RET
 408:			
 409:			;***********************************************************
 410:			; PATH ROUTINE
 411:			;***********************************************************
 412:			; FUNCTION:   To generate a single possible move for a given
 413:			;             piece along its current path of motion including:
 414:			
 415:			;                Fetching the contents of the board at the new
 416:			;                position, and setting a flag describing the
 417:			;                contents:
 418:			;                          0  --  New position is empty
 419:			;                          1  --  Encountered a piece of the
 420:			;                                 opposite color
 421:			;                          2  --  Encountered a piece of the
 422:			;                                 same color
 423:			;                          3  --  New position is off the
 424:			;                                 board
 425:			;
 426:			; CALLED BY:  MPIECE
 427:			;             ATTACK
 428:			;             PINFND
 429:			;
 430:			; CALLS:      None
 431:			;
 432:			; ARGUMENTS:  Direction from the direction array giving the
 433:			;             constant to be added for the new position.
 434:			;***********************************************************
 435:	0B4C  210200  	PATH:   LD      hl,M2           ; Get previous position
 436:	0B4F  7E      	        LD      a,(hl)
 437:	0B50  81      	        ADD     a,c             ; Add direction constant
 438:	0B51  77      	        LD      (hl),a          ; Save new position
 439:	0B52  DD2A0200	        LD      ix,(M2)         ; Load board index
 440:	0B56  DD7EB4  	        LD      a,(ix+BOARD)    ; Get contents of board
 441:	0B59  FEFF    	        CP      a,-1            ; In border area ?
 442:	0B5B  281A    	        JR      Z,PA2           ; Yes - jump
 443:	0B5D  322300  	        LD      (P2),a          ; Save piece
 444:	0B60  E607    	        AND     a,7             ; Clear flags
 445:	0B62  320A00  	        LD      (T2),a          ; Save piece type
 446:	0B65  C8      	        RET     Z               ; Return if empty
 447:	0B66  3A2300  	        LD      a,(P2)          ; Get piece encountered
 448:	0B69  212200  	        LD      hl,P1           ; Get moving piece address
 449:	0B6C  AE      	        XOR     a,(hl)          ; Compare
 450:	0B6D  CB7F    	        BIT     7,a             ; Do colors match ?
 451:	0B6F  2803    	        JR      Z,PA1           ; Yes - jump
 452:	0B71  3E01    	        LD      a,1             ; Set different color flag
 453:	0B73  C9      	        RET                     ; Return
 454:	0B74  3E02    	PA1:    LD      a,2             ; Set same color flag
 455:	0B76  C9      	        RET                     ; Return
 456:	0B77  3E03    	PA2:    LD      a,3             ; Set off board flag
 457:	0B79  C9      	        RET                     ; Return
 458:			
 459:			;***********************************************************
 460:			; PIECE MOVER ROUTINE
 461:			;***********************************************************
 462:			; FUNCTION:   To generate all the possible legal moves for a
 463:			;             given piece.
 464:			;
 465:			; CALLED BY:  GENMOV
 466:			;
 467:			; CALLS:      PATH
 468:			;             ADMOVE
 469:			;             CASTLE
 470:			;             ENPSNT
 471:			;
 472:			; ARGUMENTS:  The piece to be moved.
 473:			;***********************************************************
 474:	0B7A  AE      	MPIECE: XOR     a,(hl)          ; Piece to move
 475:	0B7B  E687    	        AND     a,87H           ; Clear flag bit
 476:	0B7D  FE81    	        CP      a,BPAWN         ; Is it a black Pawn ?
 477:	0B7F  2001    	        JR      NZ,rel001       ; No-Skip
 478:	0B81  3D      	        DEC     a               ; Decrement for black Pawns
 479:	0B82  E607    	rel001: AND     a,7             ; Get piece type
 480:	0B84  320800  	        LD      (T1),a          ; Save piece type
 481:	0B87  FD2A0800	        LD      iy,(T1)         ; Load index to DCOUNT/DPOINT
 482:	0B8B  FD469F  	        LD      b,(iy+DCOUNT)   ; Get direction count
 483:	0B8E  FD7E98  	        LD      a,(iy+DPOINT)   ; Get direction pointer
 484:	0B91  321000  	        LD      (INDX2),a       ; Save as index to direct
 485:	0B94  FD2A1000	        LD      iy,(INDX2)      ; Load index
 486:	0B98  FD4E80  	MP5:    LD      c,(iy+DIRECT)   ; Get move direction
 487:	0B9B  3A0000  	        LD      a,(M1)          ; From position
 488:	0B9E  320200  	        LD      (M2),a          ; Initialize to position
 489:	0BA1  CD4C0B  	MP10:   CALL    PATH            ; Calculate next position
 490:	0BA4  FE02    	        CP      a,2             ; Ready for new direction ?
 491:	0BA6  301A    	        JR      NC,MP15         ; Yes - Jump
 492:	0BA8  A7      	        AND     a,a             ; Test for empty square
 493:	0BA9  08      	        EX      af,af'          ; Save result
 494:	0BAA  3A0800  	        LD      a,(T1)          ; Get piece moved
 495:	0BAD  FE02    	        CP      a,PAWN+1        ; Is it a Pawn ?
 496:	0BAF  381E    	        JR      C,MP20          ; Yes - Jump
 497:	0BB1  CD100D  	        CALL    ADMOVE          ; Add move to list
 498:	0BB4  08      	        EX      af,af'          ; Empty square ?
 499:	0BB5  200B    	        JR      NZ,MP15         ; No - Jump
 500:	0BB7  3A0800  	        LD      a,(T1)          ; Piece type
 501:	0BBA  FE06    	        CP      a,KING          ; King ?
 502:	0BBC  2804    	        JR      Z,MP15          ; Yes - Jump
 503:	0BBE  FE03    	        CP      a,BISHOP        ; Bishop, Rook, or Queen ?
 504:	0BC0  30DF    	        JR      NC,MP10         ; Yes - Jump
 505:	0BC2  FD23    	MP15:   INC     iy              ; Increment direction index
 506:	0BC4  10D2    	        DJNZ    MP5             ; Decr. count-jump if non-zerc
 507:	0BC6  3A0800  	        LD      a,(T1)          ; Piece type
 508:	0BC9  FE06    	        CP      a,KING          ; King ?
 509:	0BCB  CC920C  	        CALL    Z,CASTLE        ; Yes - Try Castling
 510:	0BCE  C9      	        RET                     ; Return
 511:			; ***** PAWN LOGIC *****
 512:	0BCF  78      	MP20:   LD      a,b             ; Counter for direction
 513:	0BD0  FE03    	        CP      a,3             ; On diagonal moves ?
 514:	0BD2  382E    	        JR      C,MP35          ; Yes - Jump
 515:	0BD4  2823    	        JR      Z,MP30          ; -or-jump if on 2 square move
 516:	0BD6  08      	        EX      af,af'          ; Is forward square empty?
 517:	0BD7  20E9    	        JR      NZ,MP15         ; No - jump
 518:	0BD9  3A0200  	        LD      a,(M2)          ; Get "to" position
 519:	0BDC  FE5B    	        CP      a,91            ; Promote white Pawn ?
 520:	0BDE  3004    	        JR      NC,MP25         ; Yes - Jump
 521:	0BE0  FE1D    	        CP      a,29            ; Promote black Pawn ?
 522:	0BE2  3005    	        JR      NC,MP26         ; No - Jump
 523:	0BE4  212300  	MP25:   LD      hl,P2           ; Flag address
 524:	0BE7  CBEE    	        SET     5,(hl)          ; Set promote flag
 525:	0BE9  CD100D  	MP26:   CALL    ADMOVE          ; Add to move list
 526:	0BEC  FD23    	        INC     iy              ; Adjust to two square move
 527:	0BEE  05      	        DEC     b
 528:	0BEF  212200  	        LD      hl,P1           ; Check Pawn moved flag
 529:	0BF2  CB5E    	        BIT     3,(hl)          ; Has it moved before ?
 530:	0BF4  28AB    	        JR      Z,MP10          ; No - Jump
 531:	0BF6  C3C20B  	        JP      MP15            ; Jump
 532:	0BF9  08      	MP30:   EX      af,af'          ; Is forward square empty ?
 533:	0BFA  20C6    	        JR      NZ,MP15         ; No - Jump
 534:	0BFC  CD100D  	MP31:   CALL    ADMOVE          ; Add to move list
 535:	0BFF  C3C20B  	        JP      MP15            ; Jump
 536:	0C02  08      	MP35:   EX      af,af'          ; Is diagonal square empty ?
 537:	0C03  2812    	        JR      Z,MP36          ; Yes - Jump
 538:	0C05  3A0200  	        LD      a,(M2)          ; Get "to" position
 539:	0C08  FE5B    	        CP      a,91            ; Promote white Pawn ?
 540:	0C0A  3004    	        JR      NC,MP37         ; Yes - Jump
 541:	0C0C  FE1D    	        CP      a,29            ; Black Pawn promotion ?
 542:	0C0E  30EC    	        JR      NC,MP31         ; No- Jump
 543:	0C10  212300  	MP37:   LD      hl,P2           ; Get flag address
 544:	0C13  CBEE    	        SET     5,(hl)          ; Set promote flag
 545:	0C15  18E5    	        JR      MP31            ; Jump
 546:	0C17  CD1D0C  	MP36:   CALL    ENPSNT          ; Try en passant capture
 547:	0C1A  C3C20B  	        JP      MP15            ; Jump
 548:			
 549:			;***********************************************************
 550:			; EN PASSANT ROUTINE
 551:			;***********************************************************
 552:			; FUNCTION:   --  To test for en passant Pawn capture and
 553:			;                 to add it to the move list if it is
 554:			;                 legal.
 555:			;
 556:			; CALLED BY:  --  MPIECE
 557:			;
 558:			; CALLS:      --  ADMOVE
 559:			;                 ADJPTR
 560:			;
 561:			; ARGUMENTS:  --  None
 562:			;***********************************************************
 563:	0C1D  3A0000  	ENPSNT: LD      a,(M1)          ; Set position of Pawn
 564:	0C20  212200  	        LD      hl,P1           ; Check color
 565:	0C23  CB7E    	        BIT     7,(hl)          ; Is it white ?
 566:	0C25  2802    	        JR      Z,rel002        ; Yes - skip
 567:	0C27  C60A    	        ADD     a,10            ; Add 10 for black
 568:	0C29  FE3D    	rel002: CP      a,61            ; On en passant capture rank ?
 569:	0C2B  D8      	        RET     C               ; No - return
 570:	0C2C  FE45    	        CP      a,69            ; On en passant capture rank ?
 571:	0C2E  D0      	        RET     NC              ; No - return
 572:	0C2F  DD2A1600	        LD      ix,(MLPTRJ)     ; Get pointer to previous move
 573:	0C33  DDCB0466	        BIT     4,(ix+MLFLG)    ; First move for that piece ?
 574:	0C37  C8      	        RET     Z               ; No - return
 575:	0C38  DD7E03  	        LD      a,(ix+MLTOP)    ; Get "to" position
 576:	0C3B  320600  	        LD      (M4),a          ; Store as index to board
 577:	0C3E  DD2A0600	        LD      ix,(M4)         ; Load board index
 578:	0C42  DD7EB4  	        LD      a,(ix+BOARD)    ; Get piece moved
 579:	0C45  322400  	        LD      (P3),a          ; Save it
 580:	0C48  E607    	        AND     a,7             ; Get piece type
 581:	0C4A  FE01    	        CP      a,PAWN          ; Is it a Pawn ?
 582:	0C4C  C0      	        RET     NZ              ; No - return
 583:	0C4D  3A0600  	        LD      a,(M4)          ; Get "to" position
 584:	0C50  210200  	        LD      hl,M2           ; Get present "to" position
 585:	0C53  96      	        SUB     a,(hl)          ; Find difference
 586:	0C54  F2590C  	        JP      P,rel003        ; Positive ? Yes - Jump
 587:	0C57  ED44    	        NEG                     ; Else take absolute value
 588:	0C59  FE0A    	rel003: CP      a,10            ; Is difference 10 ?
 589:	0C5B  C0      	        RET     NZ              ; No - return
 590:	0C5C  212300  	        LD      hl,P2           ; Address of flags
 591:	0C5F  CBF6    	        SET     6,(hl)          ; Set double move flag
 592:	0C61  CD100D  	        CALL    ADMOVE          ; Add Pawn move to move list
 593:	0C64  3A0000  	        LD      a,(M1)          ; Save initial Pawn position
 594:	0C67  320400  	        LD      (M3),a
 595:	0C6A  3A0600  	        LD      a,(M4)          ; Set "from" and "to" positions
 596:			                                ; for dummy move
 597:	0C6D  320000  	        LD      (M1),a
 598:	0C70  320200  	        LD      (M2),a
 599:	0C73  3A2400  	        LD      a,(P3)          ; Save captured Pawn
 600:	0C76  322300  	        LD      (P2),a
 601:	0C79  CD100D  	        CALL    ADMOVE          ; Add Pawn capture to move list
 602:	0C7C  3A0400  	        LD      a,(M3)          ; Restore "from" position
 603:	0C7F  320000  	        LD      (M1),a
 604:			
 605:			;***********************************************************
 606:			; ADJUST MOVE LIST POINTER FOR DOUBLE MOVE
 607:			;***********************************************************
 608:			; FUNCTION:   --  To adjust move list pointer to link around
 609:			;                 second move in double move.
 610:			;
 611:			; CALLED BY:  --  ENPSNT
 612:			;                 CASTLE
 613:			;                 (This mini-routine is not really called,
 614:			;                 but is jumped to to save time.)
 615:			;
 616:			; CALLS:      --  None
 617:			;
 618:			; ARGUMENTS:  --  None
 619:			;***********************************************************
 620:	0C82  2A1C00  	ADJPTR: LD      hl,(MLLST)      ; Get list pointer
 621:	0C85  11FAFF  	        LD      de,-6           ; Size of a move entry
 622:	0C88  19      	        ADD     hl,de           ; Back up list pointer
 623:	0C89  221C00  	        LD      (MLLST),hl      ; Save list pointer
 624:	0C8C  3600    	        LD      (hl),0          ; Zero out link, first byte
 625:	0C8E  23      	        INC     hl              ; Next byte
 626:	0C8F  3600    	        LD      (hl),0          ; Zero out link, second byte
 627:	0C91  C9      	        RET                     ; Return
 628:			
 629:			;***********************************************************
 630:			; CASTLE ROUTINE
 631:			;***********************************************************
 632:			; FUNCTION:   --  To determine whether castling is legal
 633:			;                 (Queen side, King side, or both) and add it
 634:			;                 to the move list if it is.
 635:			;
 636:			; CALLED BY:  --  MPIECE
 637:			;
 638:			; CALLS:      --  ATTACK
 639:			;                 ADMOVE
 640:			;                 ADJPTR
 641:			;
 642:			; ARGUMENTS:  --  None
 643:			;***********************************************************
 644:	0C92  3A2200  	CASTLE: LD      a,(P1)          ; Get King
 645:	0C95  CB5F    	        BIT     3,a             ; Has it moved ?
 646:	0C97  C0      	        RET     NZ              ; Yes - return
 647:	0C98  3A2900  	        LD      a,(CKFLG)       ; Fetch Check Flag
 648:	0C9B  A7      	        AND     a,a             ; Is the King in check ?
 649:	0C9C  C0      	        RET     NZ              ; Yes - Return
 650:	0C9D  0103FF  	        LD      bc,0FF03H       ; Initialize King-side values
 651:	0CA0  3A0000  	CA5:    LD      a,(M1)          ; King position
 652:	0CA3  81      	        ADD     a,c             ; Rook position
 653:	0CA4  4F      	        LD      c,a             ; Save
 654:	0CA5  320400  	        LD      (M3),a          ; Store as board index
 655:	0CA8  DD2A0400	        LD      ix,(M3)         ; Load board index
 656:	0CAC  DD7EB4  	        LD      a,(ix+BOARD)    ; Get contents of board
 657:	0CAF  E67F    	        AND     a,7FH           ; Clear color bit
 658:	0CB1  FE04    	        CP      a,ROOK          ; Has Rook ever moved ?
 659:	0CB3  2051    	        JR      NZ,CA20         ; Yes - Jump
 660:	0CB5  79      	        LD      a,c             ; Restore Rook position
 661:	0CB6  181E    	        JR      CA15            ; Jump
 662:	0CB8  DD2A0400	CA10:   LD      ix,(M3)         ; Load board index
 663:	0CBC  DD7EB4  	        LD      a,(ix+BOARD)    ; Get contents of board
 664:	0CBF  A7      	        AND     a,a             ; Empty ?
 665:	0CC0  2044    	        JR      NZ,CA20         ; No - Jump
 666:	0CC2  3A0400  	        LD      a,(M3)          ; Current position
 667:	0CC5  FE16    	        CP      a,22            ; White Queen Knight square ?
 668:	0CC7  280D    	        JR      Z,CA15          ; Yes - Jump
 669:	0CC9  FE5C    	        CP      a,92            ; Black Queen Knight square ?
 670:	0CCB  2809    	        JR      Z,CA15          ; Yes - Jump
 671:	0CCD  CDB90D  	        CALL    ATTACK          ; Look for attack on square
 672:	0CD0  A7      	        AND     a,a             ; Any attackers ?
 673:	0CD1  2033    	        JR      NZ,CA20         ; Yes - Jump
 674:	0CD3  3A0400  	        LD      a,(M3)          ; Current position
 675:	0CD6  80      	CA15:   ADD     a,b             ; Next position
 676:	0CD7  320400  	        LD      (M3),a          ; Save as board index
 677:	0CDA  210000  	        LD      hl,M1           ; King position
 678:	0CDD  BE      	        CP      a,(hl)          ; Reached King ?
 679:	0CDE  20D8    	        JR      NZ,CA10         ; No - jump
 680:	0CE0  90      	        SUB     a,b             ; Determine King's position
 681:	0CE1  90      	        SUB     a,b
 682:	0CE2  320200  	        LD      (M2),a          ; Save it
 683:	0CE5  212300  	        LD      hl,P2           ; Address of flags
 684:	0CE8  3640    	        LD      (hl),40H        ; Set double move flag
 685:	0CEA  CD100D  	        CALL    ADMOVE          ; Put king move in list
 686:	0CED  210000  	        LD      hl,M1           ; Addr of King "from" position
 687:	0CF0  7E      	        LD      a,(hl)          ; Get King's "from" position
 688:	0CF1  71      	        LD      (hl),c          ; Store Rook "from" position
 689:	0CF2  90      	        SUB     a,b             ; Get Rook "to" position
 690:	0CF3  320200  	        LD      (M2),a          ; Store Rook "to" position
 691:	0CF6  AF      	        XOR     a,a             ; Zero
 692:	0CF7  322300  	        LD      (P2),a          ; Zero move flags
 693:	0CFA  CD100D  	        CALL    ADMOVE          ; Put Rook move in list
 694:	0CFD  CD820C  	        CALL    ADJPTR          ; Re-adjust move list pointer
 695:	0D00  3A0400  	        LD      a,(M3)          ; Restore King position
 696:	0D03  320000  	        LD      (M1),a          ; Store
 697:	0D06  78      	CA20:   LD      a,b             ; Scan Index
 698:	0D07  FE01    	        CP      a,1             ; Done ?
 699:	0D09  C8      	        RET     Z               ; Yes - return
 700:	0D0A  01FC01  	        LD      bc,01FCH        ; Set Queen-side initial values
 701:	0D0D  C3A00C  	        JP      CA5             ; Jump
 702:			
 703:			;***********************************************************
 704:			; ADMOVE ROUTINE
 705:			;***********************************************************
 706:			; FUNCTION:   --  To add a move to the move list
 707:			;
 708:			; CALLED BY:  --  MPIECE
 709:			;                 ENPSNT
 710:			;                 CASTLE
 711:			;
 712:			; CALLS:      --  None
 713:			;
 714:			; ARGUMENT:  --  None
 715:			;***********************************************************
 716:	0D10  ED5B1E00	ADMOVE: LD      de,(MLNXT)      ; Addr of next loc in move list
 717:	0D14  21F80A  	        LD      hl,MLEND        ; Address of list end
 718:	0D17  A7      	        AND     a,a             ; Clear carry flag
 719:	0D18  ED52    	        SBC     hl,de           ; Calculate difference
 720:	0D1A  3833    	        JR      C,AM10          ; Jump if out of space
 721:	0D1C  2A1C00  	        LD      hl,(MLLST)      ; Addr of prev. list area
 722:	0D1F  ED531C00	        LD      (MLLST),de      ; Save next as previous
 723:	0D23  73      	        LD      (hl),e          ; Store link address
 724:	0D24  23      	        INC     hl
 725:	0D25  72      	        LD      (hl),d
 726:	0D26  212200  	        LD      hl,P1           ; Address of moved piece
 727:	0D29  CB5E    	        BIT     3,(hl)          ; Has it moved before ?
 728:	0D2B  2005    	        JR      NZ,rel004       ; Yes - jump
 729:	0D2D  212300  	        LD      hl,P2           ; Address of move flags
 730:	0D30  CBE6    	        SET     4,(hl)          ; Set first move flag
 731:	0D32  EB      	rel004: EX      de,hl           ; Address of move area
 732:	0D33  3600    	        LD      (hl),0          ; Store zero in link address
 733:	0D35  23      	        INC     hl
 734:	0D36  3600    	        LD      (hl),0
 735:	0D38  23      	        INC     hl
 736:	0D39  3A0000  	        LD      a,(M1)          ; Store "from" move position
 737:	0D3C  77      	        LD      (hl),a
 738:	0D3D  23      	        INC     hl
 739:	0D3E  3A0200  	        LD      a,(M2)          ; Store "to" move position
 740:	0D41  77      	        LD      (hl),a
 741:	0D42  23      	        INC     hl
 742:	0D43  3A2300  	        LD      a,(P2)          ; Store move flags/capt. piece
 743:	0D46  77      	        LD      (hl),a
 744:	0D47  23      	        INC     hl
 745:	0D48  3600    	        LD      (hl),0          ; Store initial move value
 746:	0D4A  23      	        INC     hl
 747:	0D4B  221E00  	        LD      (MLNXT),hl      ; Save address for next move
 748:	0D4E  C9      	        RET                     ; Return
 749:	0D4F  3600    	AM10:   LD      (hl),0          ; Abort entry on table ovflow
 750:	0D51  23      	        INC     hl
 751:	0D52  3600    	        LD      (hl),0
 752:	0D54  2B      	        DEC     hl
 753:	0D55  C9      	        RET
 754:			
 755:			;***********************************************************
 756:			; GENERATE MOVE ROUTINE
 757:			;***********************************************************
 758:			; FUNCTION:  --  To generate the move set for all of the
 759:			;                pieces of a given color.
 760:			;
 761:			; CALLED BY: --  FNDMOV
 762:			;
 763:			; CALLS:     --  MPIECE
 764:			;                INCHK
 765:			;
 766:			; ARGUMENTS: --  None
 767:			;***********************************************************
 768:	0D56  CD980D  	GENMOV: CALL    INCHK           ; Test for King in check
 769:	0D59  322900  	        LD      (CKFLG),a       ; Save attack count as flag
 770:	0D5C  ED5B1E00	        LD      de,(MLNXT)      ; Addr of next avail list space
 771:	0D60  2A1400  	        LD      hl,(MLPTRI)     ; Ply list pointer index
 772:	0D63  23      	        INC     hl              ; Increment to next ply
 773:	0D64  23      	        INC     hl
 774:	0D65  73      	        LD      (hl),e          ; Save move list pointer
 775:	0D66  23      	        INC     hl
 776:	0D67  72      	        LD      (hl),d
 777:	0D68  23      	        INC     hl
 778:	0D69  221400  	        LD      (MLPTRI),hl     ; Save new index
 779:	0D6C  221C00  	        LD      (MLLST),hl      ; Last pointer for chain init.
 780:	0D6F  3E15    	        LD      a,21            ; First position on board
 781:	0D71  320000  	GM5:    LD      (M1),a          ; Save as index
 782:	0D74  DD2A0000	        LD      ix,(M1)         ; Load board index
 783:	0D78  DD7EB4  	        LD      a,(ix+BOARD)    ; Fetch board contents
 784:	0D7B  A7      	        AND     a,a             ; Is it empty ?
 785:	0D7C  2810    	        JR      Z,GM10          ; Yes - Jump
 786:	0D7E  FEFF    	        CP      a,-1            ; Is it a border square ?
 787:	0D80  280C    	        JR      Z,GM10          ; Yes - Jump
 788:	0D82  322200  	        LD      (P1),a          ; Save piece
 789:	0D85  212100  	        LD      hl,COLOR        ; Address of color of piece
 790:	0D88  AE      	        XOR     a,(hl)          ; Test color of piece
 791:	0D89  CB7F    	        BIT     7,a             ; Match ?
 792:	0D8B  CC7A0B  	        CALL    Z,MPIECE        ; Yes - call Move Piece
 793:	0D8E  3A0000  	GM10:   LD      a,(M1)          ; Fetch current board position
 794:	0D91  3C      	        INC     a               ; Incr to next board position
 795:	0D92  FE63    	        CP      a,99            ; End of board array ?
 796:	0D94  C2710D  	        JP      NZ,GM5          ; No - Jump
 797:	0D97  C9      	        RET                     ; Return
 798:			
 799:			;***********************************************************
 800:			; CHECK ROUTINE
 801:			;***********************************************************
 802:			; FUNCTION:   --  To determine whether or not the
 803:			;                 King is in check.
 804:			;
 805:			; CALLED BY:  --  GENMOV
 806:			;                 FNDMOV
 807:			;                 EVAL
 808:			;
 809:			; CALLS:      --  ATTACK
 810:			;
 811:			; ARGUMENTS:  --  Color of King
 812:			;***********************************************************
 813:	0D98  3A2100  	INCHK:  LD      a,(COLOR)       ; Get color
 814:	0D9B  214E01  	INCHK1: LD      hl,POSK         ; Addr of white King position
 815:	0D9E  A7      	        AND     a,a             ; White ?
 816:	0D9F  2801    	        JR      Z,rel005        ; Yes - Skip
 817:	0DA1  23      	        INC     hl              ; Addr of black King position
 818:	0DA2  7E      	rel005: LD      a,(hl)          ; Fetch King position
 819:	0DA3  320400  	        LD      (M3),a          ; Save
 820:	0DA6  DD2A0400	        LD      ix,(M3)         ; Load board index
 821:	0DAA  DD7EB4  	        LD      a,(ix+BOARD)    ; Fetch board contents
 822:	0DAD  322200  	        LD      (P1),a          ; Save
 823:	0DB0  E607    	        AND     a,7             ; Get piece type
 824:	0DB2  320800  	        LD      (T1),a          ; Save
 825:	0DB5  CDB90D  	        CALL    ATTACK          ; Look for attackers on King
 826:	0DB8  C9      	        RET                     ; Return
 827:			
 828:			;***********************************************************
 829:			; ATTACK ROUTINE
 830:			;***********************************************************
 831:			; FUNCTION:   --  To find all attackers on a given square
 832:			;                 by scanning outward from the square
 833:			;                 until a piece is found that attacks
 834:			;                 that square, or a piece is found that
 835:			;                 doesn't attack that square, or the edge
 836:			;                 of the board is reached.
 837:			;
 838:			;                 In determining which pieces attack
 839:			;                 a square, this routine also takes into
 840:			;                 account the ability of certain pieces to
 841:			;                 attack through another attacking piece. (For
 842:			;                 example a queen lined up behind a bishop
 843:			;                 of her same color along a diagonal.) The
 844:			;                 bishop is then said to be transparent to the
 845:			;                 queen, since both participate in the
 846:			;                 attack.
 847:			;
 848:			;                 In the case where this routine is called
 849:			;                 by CASTLE or INCHK, the routine is
 850:			;                 terminated as soon as an attacker of the
 851:			;                 opposite color is encountered.
 852:			;
 853:			; CALLED BY:  --  POINTS
 854:			;                 PINFND
 855:			;                 CASTLE
 856:			;                 INCHK
 857:			;
 858:			; CALLS:      --  PATH
 859:			;                 ATKSAV
 860:			;
 861:			; ARGUMENTS:  --  None
 862:			;***********************************************************
 863:	0DB9  C5      	ATTACK: PUSH    bc              ; Save Register B
 864:	0DBA  AF      	        XOR     a,a             ; Clear
 865:	0DBB  0610    	        LD      b,16            ; Initial direction count
 866:	0DBD  321000  	        LD      (INDX2),a       ; Initial direction index
 867:	0DC0  FD2A1000	        LD      iy,(INDX2)      ; Load index
 868:	0DC4  FD4E80  	AT5:    LD      c,(iy+DIRECT)   ; Get direction
 869:	0DC7  1600    	        LD      d,0             ; Init. scan count/flags
 870:	0DC9  3A0400  	        LD      a,(M3)          ; Init. board start position
 871:	0DCC  320200  	        LD      (M2),a          ; Save
 872:	0DCF  14      	AT10:   INC     d               ; Increment scan count
 873:	0DD0  CD4C0B  	        CALL    PATH            ; Next position
 874:	0DD3  FE01    	        CP      a,1             ; Piece of a opposite color ?
 875:	0DD5  2813    	        JR      Z,AT14A         ; Yes - jump
 876:	0DD7  FE02    	        CP      a,2             ; Piece of same color ?
 877:	0DD9  2818    	        JR      Z,AT14B         ; Yes - jump
 878:	0DDB  A7      	        AND     a,a             ; Empty position ?
 879:	0DDC  2005    	        JR      NZ,AT12         ; No - jump
 880:	0DDE  78      	        LD      a,b             ; Fetch direction count
 881:	0DDF  FE09    	        CP      a,9             ; On knight scan ?
 882:	0DE1  30EC    	        JR      NC,AT10         ; No - jump
 883:	0DE3  FD23    	AT12:   INC     iy              ; Increment direction index
 884:	0DE5  10DD    	        DJNZ    AT5             ; Done ? No - jump
 885:	0DE7  AF      	        XOR     a,a             ; No attackers
 886:	0DE8  C1      	AT13:   POP     bc              ; Restore register B
 887:	0DE9  C9      	        RET                     ; Return
 888:	0DEA  CB72    	AT14A:  BIT     6,d             ; Same color found already ?
 889:	0DEC  20F5    	        JR      NZ,AT12         ; Yes - jump
 890:	0DEE  CBEA    	        SET     5,d             ; Set opposite color found flag
 891:	0DF0  C3F90D  	        JP      AT14            ; Jump
 892:	0DF3  CB6A    	AT14B:  BIT     5,d             ; Opposite color found already?
 893:	0DF5  20EC    	        JR      NZ,AT12         ; Yes - jump
 894:	0DF7  CBF2    	        SET     6,d             ; Set same color found flag
 895:			
 896:			;
 897:			; ***** DETERMINE IF PIECE ENCOUNTERED ATTACKS SQUARE *****
 898:	0DF9  3A0A00  	AT14:   LD      a,(T2)          ; Fetch piece type encountered
 899:	0DFC  5F      	        LD      e,a             ; Save
 900:	0DFD  78      	        LD      a,b             ; Get direction-counter
 901:	0DFE  FE09    	        CP      a,9             ; Look for Knights ?
 902:	0E00  3845    	        JR      C,AT25          ; Yes - jump
 903:	0E02  7B      	        LD      a,e             ; Get piece type
 904:	0E03  FE05    	        CP      a,QUEEN         ; Is is a Queen ?
 905:	0E05  2004    	        JR      NZ,AT15         ; No - Jump
 906:	0E07  CBFA    	        SET     7,d             ; Set Queen found flag
 907:	0E09  1841    	        JR      AT30            ; Jump
 908:	0E0B  7A      	AT15:   LD      a,d             ; Get flag/scan count
 909:	0E0C  E60F    	        AND     a,0FH           ; Isolate count
 910:	0E0E  FE01    	        CP      a,1             ; On first position ?
 911:	0E10  2005    	        JR      NZ,AT16         ; No - jump
 912:	0E12  7B      	        LD      a,e             ; Get encountered piece type
 913:	0E13  FE06    	        CP      a,KING          ; Is it a King ?
 914:	0E15  2835    	        JR      Z,AT30          ; Yes - jump
 915:	0E17  78      	AT16:   LD      a,b             ; Get direction counter
 916:	0E18  FE0D    	        CP      a,13            ; Scanning files or ranks ?
 917:	0E1A  3824    	        JR      C,AT21          ; Yes - jump
 918:	0E1C  7B      	        LD      a,e             ; Get piece type
 919:	0E1D  FE03    	        CP      a,BISHOP        ; Is it a Bishop ?
 920:	0E1F  282B    	        JR      Z,AT30          ; Yes - jump
 921:	0E21  7A      	        LD      a,d             ; Get flags/scan count
 922:	0E22  E60F    	        AND     a,0FH           ; Isolate count
 923:	0E24  FE01    	        CP      a,1             ; On first position ?
 924:	0E26  20BB    	        JR      NZ,AT12         ; No - jump
 925:	0E28  BB      	        CP      a,e             ; Is it a Pawn ?
 926:	0E29  20B8    	        JR      NZ,AT12         ; No - jump
 927:	0E2B  3A2300  	        LD      a,(P2)          ; Fetch piece including color
 928:	0E2E  CB7F    	        BIT     7,a             ; Is it white ?
 929:	0E30  2807    	        JR      Z,AT20          ; Yes - jump
 930:	0E32  78      	        LD      a,b             ; Get direction counter
 931:	0E33  FE0F    	        CP      a,15            ; On a non-attacking diagonal ?
 932:	0E35  38AC    	        JR      C,AT12          ; Yes - jump
 933:	0E37  1813    	        JR      AT30            ; Jump
 934:	0E39  78      	AT20:   LD      a,b             ; Get direction counter
 935:	0E3A  FE0F    	        CP      a,15            ; On a non-attacking diagonal ?
 936:	0E3C  30A5    	        JR      NC,AT12         ; Yes - jump
 937:	0E3E  180C    	        JR      AT30            ; Jump
 938:	0E40  7B      	AT21:   LD      a,e             ; Get piece type
 939:	0E41  FE04    	        CP      a,ROOK          ; Is is a Rook ?
 940:	0E43  209E    	        JR      NZ,AT12         ; No - jump
 941:	0E45  1805    	        JR      AT30            ; Jump
 942:	0E47  7B      	AT25:   LD      a,e             ; Get piece type
 943:	0E48  FE02    	        CP      a,KNIGHT        ; Is it a Knight ?
 944:	0E4A  2097    	        JR      NZ,AT12         ; No - jump
 945:	0E4C  3A0800  	AT30:   LD      a,(T1)          ; Attacked piece type/flag
 946:	0E4F  FE07    	        CP      a,7             ; Call from POINTS ?
 947:	0E51  2809    	        JR      Z,AT31          ; Yes - jump
 948:	0E53  CB6A    	        BIT     5,d             ; Is attacker opposite color ?
 949:	0E55  2808    	        JR      Z,AT32          ; No - jump
 950:	0E57  3E01    	        LD      a,1             ; Set attacker found flag
 951:	0E59  C3E80D  	        JP      AT13            ; Jump
 952:	0E5C  CD6F0E  	AT31:   CALL    ATKSAV          ; Save attacker in attack list
 953:	0E5F  3A0A00  	AT32:   LD      a,(T2)          ; Attacking piece type
 954:	0E62  FE06    	        CP      a,KING          ; Is it a King,?
 955:	0E64  CAE30D  	        JP      Z,AT12          ; Yes - jump
 956:	0E67  FE02    	        CP      a,KNIGHT        ; Is it a Knight ?
 957:	0E69  CAE30D  	        JP      Z,AT12          ; Yes - jump
 958:	0E6C  C3CF0D  	        JP      AT10            ; Jump
 959:			
 960:			;***********************************************************
 961:			; ATTACK SAVE ROUTINE
 962:			;***********************************************************
 963:			; FUNCTION:   --  To save an attacking piece value in the
 964:			;                 attack list, and to increment the attack
 965:			;                 count for that color piece.
 966:			;
 967:			;                 The pin piece list is checked for the
 968:			;                 attacking piece, and if found there, the
 969:			;                 piece is not included in the attack list.
 970:			;
 971:			; CALLED BY:  --  ATTACK
 972:			;
 973:			; CALLS:      --  PNCK
 974:			;
 975:			; ARGUMENTS:  --  None
 976:			;***********************************************************
 977:	0E6F  C5      	ATKSAV: PUSH    bc              ; Save Regs BC
 978:	0E70  D5      	        PUSH    de              ; Save Regs DE
 979:	0E71  3A1200  	        LD      a,(NPINS)       ; Number of pinned pieces
 980:	0E74  A7      	        AND     a,a             ; Any ?
 981:	0E75  C4B70E  	        CALL    NZ,PNCK         ; yes - check pin list
 982:	0E78  DD2A0A00	        LD      ix,(T2)         ; Init index to value table
 983:	0E7C  212C01  	        LD      hl,ATKLST       ; Init address of attack list
 984:	0E7F  010000  	        LD      bc,0            ; Init increment for white
 985:	0E82  3A2300  	        LD      a,(P2)          ; Attacking piece
 986:	0E85  CB7F    	        BIT     7,a             ; Is it white ?
 987:	0E87  2802    	        JR      Z,rel006        ; Yes - jump
 988:	0E89  0E07    	        LD      c,7             ; Init increment for black
 989:	0E8B  E607    	rel006: AND     a,7             ; Attacking piece type
 990:	0E8D  5F      	        LD      e,a             ; Init increment for type
 991:	0E8E  CB7A    	        BIT     7,d             ; Queen found this scan ?
 992:	0E90  2802    	        JR      Z,rel007        ; No - jump
 993:	0E92  1E05    	        LD      e,QUEEN         ; Use Queen slot in attack list
 994:	0E94  09      	rel007: ADD     hl,bc           ; Attack list address
 995:	0E95  34      	        INC     (hl)            ; Increment list count
 996:	0E96  1600    	        LD      d,0
 997:	0E98  19      	        ADD     hl,de           ; Attack list slot address
 998:	0E99  7E      	        LD      a,(hl)          ; Get data already there
 999:	0E9A  E60F    	        AND     a,0FH           ; Is first slot empty ?
1000:	0E9C  2811    	        JR      Z,AS20          ; Yes - jump
1001:	0E9E  7E      	        LD      a,(hl)          ; Get data again
1002:	0E9F  E6F0    	        AND     a,0F0H          ; Is second slot empty ?
1003:	0EA1  2803    	        JR      Z,AS19          ; Yes - jump
1004:	0EA3  23      	        INC     hl              ; Increment to King slot
1005:	0EA4  1809    	        JR      AS20            ; Jump
1006:	0EA6  ED6F    	AS19:   RLD                     ; Temp save lower in upper
1007:	0EA8  DD7EA5  	        LD      a,(ix+PVALUE)   ; Get new value for attack list
1008:	0EAB  ED67    	        RRD                     ; Put in 2nd attack list slot
1009:	0EAD  1805    	        JR      AS25            ; Jump
1010:	0EAF  DD7EA5  	AS20:   LD      a,(ix+PVALUE)   ; Get new value for attack list
1011:	0EB2  ED6F    	        RLD                     ; Put in 1st attack list slot
1012:	0EB4  D1      	AS25:   POP     de              ; Restore DE regs
1013:	0EB5  C1      	        POP     bc              ; Restore BC regs
1014:	0EB6  C9      	        RET                     ; Return
1015:			
1016:			;***********************************************************
1017:			; PIN CHECK ROUTINE
1018:			;***********************************************************
1019:			; FUNCTION:   --  Checks to see if the attacker is in the
1020:			;                 pinned piece list. If so he is not a valid
1021:			;                 attacker unless the direction in which he
1022:			;                 attacks is the same as the direction along
1023:			;                 which he is pinned. If the piece is
1024:			;                 found to be invalid as an attacker, the
1025:			;                 return to the calling routine is aborted
1026:			;                 and this routine returns directly to ATTACK.
1027:			;
1028:			; CALLED BY:  --  ATKSAV
1029:			;
1030:			; CALLS:      --  None
1031:			;
1032:			; ARGUMENTS:  --  The direction of the attack. The
1033:			;                 pinned piece counnt.
1034:			;***********************************************************
1035:	0EB7  51      	PNCK:   LD      d,c             ; Save attack direction
1036:	0EB8  1E00    	        LD      e,0             ; Clear flag
1037:	0EBA  4F      	        LD      c,a             ; Load pin count for search
1038:	0EBB  0600    	        LD      b,0
1039:	0EBD  3A0200  	        LD      a,(M2)          ; Position of piece
1040:	0EC0  213A01  	        LD      hl,PLISTA       ; Pin list address
1041:	0EC3  EDB1    	PC1:    CPIR                    ; Search list for position
1042:	0EC5  C0      	        RET     NZ              ; Return if not found
1043:	0EC6  08      	        EX      af,af'          ; Save search paramenters
1044:	0EC7  CB43    	        BIT     0,e             ; Is this the first find ?
1045:	0EC9  2015    	        JR      NZ,PC5          ; No - jump
1046:	0ECB  CBC3    	        SET     0,e             ; Set first find flag
1047:	0ECD  E5      	        PUSH    hl              ; Get corresp index to dir list
1048:	0ECE  DDE1    	        POP     ix
1049:	0ED0  DD7E09  	        LD      a,(ix+9)        ; Get direction
1050:	0ED3  BA      	        CP      a,d             ; Same as attacking direction ?
1051:	0ED4  2805    	        JR      Z,PC3           ; Yes - jump
1052:	0ED6  ED44    	        NEG                     ; Opposite direction ?
1053:	0ED8  BA      	        CP      a,d             ; Same as attacking direction ?
1054:	0ED9  2005    	        JR      NZ,PC5          ; No - jump
1055:	0EDB  08      	PC3:    EX      af,af'          ; Restore search parameters
1056:	0EDC  EAC30E  	        JP      PE,PC1          ; Jump if search not complete
1057:	0EDF  C9      	        RET                     ; Return
1058:	0EE0  F1      	PC5:    POP     af              ; Abnormal exit
1059:	0EE1  D1      	        POP     de              ; Restore regs.
1060:	0EE2  C1      	        POP     bc
1061:	0EE3  C9      	        RET                     ; Return to ATTACK
1062:			
1063:			;***********************************************************
1064:			; PIN FIND ROUTINE
1065:			;***********************************************************
1066:			; FUNCTION:   --  To produce a list of all pieces pinned
1067:			;                 against the King or Queen, for both white
1068:			;                 and black.
1069:			;
1070:			; CALLED BY:  --  FNDMOV
1071:			;                 EVAL
1072:			;
1073:			; CALLS:      --  PATH
1074:			;                 ATTACK
1075:			;
1076:			; ARGUMENTS:  --  None
1077:			;***********************************************************
1078:	0EE4  AF      	PINFND: XOR     a,a             ; Zero pin count
1079:	0EE5  321200  	        LD      (NPINS),a
1080:	0EE8  114E01  	        LD      de,POSK         ; Addr of King/Queen pos list
1081:	0EEB  1A      	PF1:    LD      a,(de)          ; Get position of royal piece
1082:	0EEC  A7      	        AND     a,a             ; Is it on board ?
1083:	0EED  CAA70F  	        JP      Z,PF26          ; No- jump
1084:	0EF0  FEFF    	        CP      a,-1            ; At end of list ?
1085:	0EF2  C8      	        RET     Z               ; Yes return
1086:	0EF3  320400  	        LD      (M3),a          ; Save position as board index
1087:	0EF6  DD2A0400	        LD      ix,(M3)         ; Load index to board
1088:	0EFA  DD7EB4  	        LD      a,(ix+BOARD)    ; Get contents of board
1089:	0EFD  322200  	        LD      (P1),a          ; Save
1090:	0F00  0608    	        LD      b,8             ; Init scan direction count
1091:	0F02  AF      	        XOR     a,a
1092:	0F03  321000  	        LD      (INDX2),a       ; Init direction index
1093:	0F06  FD2A1000	        LD      iy,(INDX2)
1094:	0F0A  3A0400  	PF2:    LD      a,(M3)          ; Get King/Queen position
1095:	0F0D  320200  	        LD      (M2),a          ; Save
1096:	0F10  AF      	        XOR     a,a
1097:	0F11  320600  	        LD      (M4),a          ; Clear pinned piece saved pos
1098:	0F14  FD4E80  	        LD      c,(iy+DIRECT)   ; Get direction of scan
1099:	0F17  CD4C0B  	PF5:    CALL    PATH            ; Compute next position
1100:	0F1A  A7      	        AND     a,a             ; Is it empty ?
1101:	0F1B  28FA    	        JR      Z,PF5           ; Yes - jump
1102:	0F1D  FE03    	        CP      a,3             ; Off board ?
1103:	0F1F  CAA30F  	        JP      Z,PF25          ; Yes - jump
1104:	0F22  FE02    	        CP      a,2             ; Piece of same color
1105:	0F24  3A0600  	        LD      a,(M4)          ; Load pinned piece position
1106:	0F27  2824    	        JR      Z,PF15          ; Yes - jump
1107:	0F29  A7      	        AND     a,a             ; Possible pin ?
1108:	0F2A  CAA30F  	        JP      Z,PF25          ; No - jump
1109:	0F2D  3A0A00  	        LD      a,(T2)          ; Piece type encountered
1110:	0F30  FE05    	        CP      a,QUEEN         ; Queen ?
1111:	0F32  CA5A0F  	        JP      Z,PF19          ; Yes - jump
1112:	0F35  6F      	        LD      l,a             ; Save piece type
1113:	0F36  78      	        LD      a,b             ; Direction counter
1114:	0F37  FE05    	        CP      a,5             ; Non-diagonal direction ?
1115:	0F39  3809    	        JR      C,PF10          ; Yes - jump
1116:	0F3B  7D      	        LD      a,l             ; Piece type
1117:	0F3C  FE03    	        CP      a,BISHOP        ; Bishop ?
1118:	0F3E  C2A30F  	        JP      NZ,PF25         ; No - jump
1119:	0F41  C3920F  	        JP      PF20            ; Jump
1120:	0F44  7D      	PF10:   LD      a,l             ; Piece type
1121:	0F45  FE04    	        CP      a,ROOK          ; Rook ?
1122:	0F47  C2A30F  	        JP      NZ,PF25         ; No - jump
1123:	0F4A  C3920F  	        JP      PF20            ; Jump
1124:	0F4D  A7      	PF15:   AND     a,a             ; Possible pin ?
1125:	0F4E  C2A30F  	        JP      NZ,PF25         ; No - jump
1126:	0F51  3A0200  	        LD      a,(M2)          ; Save possible pin position
1127:	0F54  320600  	        LD      (M4),a
1128:	0F57  C3170F  	        JP      PF5             ; Jump
1129:	0F5A  3A2200  	PF19:   LD      a,(P1)          ; Load King or Queen
1130:	0F5D  E607    	        AND     a,7             ; Clear flags
1131:	0F5F  FE05    	        CP      a,QUEEN         ; Queen ?
1132:	0F61  202F    	        JR      NZ,PF20         ; No - jump
1133:	0F63  C5      	        PUSH    bc              ; Save regs.
1134:	0F64  D5      	        PUSH    de
1135:	0F65  FDE5    	        PUSH    iy
1136:	0F67  AF      	        XOR     a,a             ; Zero out attack list
1137:	0F68  060E    	        LD      b,14
1138:	0F6A  212C01  	        LD      hl,ATKLST
1139:	0F6D  77      	back02: LD      (hl),a
1140:	0F6E  23      	        INC     hl
1141:	0F6F  10FC    	        DJNZ    back02
1142:	0F71  3E07    	        LD      a,7             ; Set attack flag
1143:	0F73  320800  	        LD      (T1),a
1144:	0F76  CDB90D  	        CALL    ATTACK          ; Find attackers/defenders
1145:	0F79  212C01  	        LD      hl,WACT         ; White queen attackers
1146:	0F7C  113301  	        LD      de,BACT         ; Black queen attackers
1147:	0F7F  3A2200  	        LD      a,(P1)          ; Get queen
1148:	0F82  CB7F    	        BIT     7,a             ; Is she white ?
1149:	0F84  2801    	        JR      Z,rel008        ; Yes - skip
1150:	0F86  EB      	        EX      de,hl           ; Reverse for black
1151:	0F87  7E      	rel008: LD      a,(hl)          ; Number of defenders
1152:	0F88  EB      	        EX      de,hl           ; Reverse for attackers
1153:	0F89  96      	        SUB     a,(hl)          ; Defenders minus attackers
1154:	0F8A  3D      	        DEC     a               ; Less 1
1155:	0F8B  FDE1    	        POP     iy              ; Restore regs.
1156:	0F8D  D1      	        POP     de
1157:	0F8E  C1      	        POP     bc
1158:	0F8F  F2A30F  	        JP      P,PF25          ; Jump if pin not valid
1159:	0F92  211200  	PF20:   LD      hl,NPINS        ; Address of pinned piece count
1160:	0F95  34      	        INC     (hl)            ; Increment
1161:	0F96  DD2A1200	        LD      ix,(NPINS)      ; Load pin list index
1162:	0F9A  DD7143  	        LD      (ix+PLISTD),c   ; Save direction of pin
1163:	0F9D  3A0600  	        LD      a,(M4)          ; Position of pinned piece
1164:	0FA0  DD7739  	        LD      (ix+PLIST),a    ; Save in list
1165:	0FA3  FD23    	PF25:   INC     iy              ; Increment direction index
1166:	0FA5  1004    	        DJNZ    PF27            ; Done ? No - Jump
1167:	0FA7  13      	PF26:   INC     de              ; Incr King/Queen pos index
1168:	0FA8  C3EB0E  	        JP      PF1             ; Jump
1169:	0FAB  C30A0F  	PF27:   JP      PF2             ; Jump
1170:			
1171:			;***********************************************************
1172:			; EXCHANGE ROUTINE
1173:			;***********************************************************
1174:			; FUNCTION:   --  To determine the exchange value of a
1175:			;                 piece on a given square by examining all
1176:			;                 attackers and defenders of that piece.
1177:			;
1178:			; CALLED BY:  --  POINTS
1179:			;
1180:			; CALLS:      --  NEXTAD
1181:			;
1182:			; ARGUMENTS:  --  None.
1183:			;***********************************************************
1184:	0FAE  D9      	XCHNG:  EXX                     ; Swap regs.
1185:	0FAF  3A2200  	        LD      a,(P1)          ; Piece attacked
1186:	0FB2  212C01  	        LD      hl,WACT         ; Addr of white attkrs/dfndrs
1187:	0FB5  113301  	        LD      de,BACT         ; Addr of black attkrs/dfndrs
1188:	0FB8  CB7F    	        BIT     7,a             ; Is piece white ?
1189:	0FBA  2801    	        JR      Z,rel009        ; Yes - jump
1190:	0FBC  EB      	        EX      de,hl           ; Swap list pointers
1191:	0FBD  46      	rel009: LD      b,(hl)          ; Init list counts
1192:	0FBE  EB      	        EX      de,hl
1193:	0FBF  4E      	        LD      c,(hl)
1194:	0FC0  EB      	        EX      de,hl
1195:	0FC1  D9      	        EXX                     ; Restore regs.
1196:	0FC2  0E00    	        LD      c,0             ; Init attacker/defender flag
1197:	0FC4  1E00    	        LD      e,0             ; Init points lost count
1198:	0FC6  DD2A0C00	        LD      ix,(T3)         ; Load piece value index
1199:	0FCA  DD56A5  	        LD      d,(ix+PVALUE)   ; Get attacked piece value
1200:	0FCD  CB22    	        SLA     d               ; Double it
1201:	0FCF  42      	        LD      b,d             ; Save
1202:	0FD0  CDFC0F  	        CALL    NEXTAD          ; Retrieve first attacker
1203:	0FD3  C8      	        RET     Z               ; Return if none
1204:	0FD4  6F      	XC10:   LD      l,a             ; Save attacker value
1205:	0FD5  CDFC0F  	        CALL    NEXTAD          ; Get next defender
1206:	0FD8  2812    	        JR      Z,XC18          ; Jump if none
1207:	0FDA  08      	        EX      af,af'          ; Save defender value
1208:	0FDB  78      	        LD      a,b             ; Get attacked value
1209:	0FDC  BD      	        CP      a,l             ; Attacked less than attacker ?
1210:	0FDD  300F    	        JR      NC,XC19         ; No - jump
1211:	0FDF  08      	        EX      af,af'          ; -Restore defender
1212:	0FE0  BD      	XC15:   CP      a,l             ; Defender less than attacker ?
1213:	0FE1  D8      	        RET     C               ; Yes - return
1214:	0FE2  CDFC0F  	        CALL    NEXTAD          ; Retrieve next attacker value
1215:	0FE5  C8      	        RET     Z               ; Return if none
1216:	0FE6  6F      	        LD      l,a             ; Save attacker value
1217:	0FE7  CDFC0F  	        CALL    NEXTAD          ; Retrieve next defender value
1218:	0FEA  20F4    	        JR      NZ,XC15         ; Jump if none
1219:	0FEC  08      	XC18:   EX      af,af'          ; Save Defender
1220:	0FED  78      	        LD      a,b             ; Get value of attacked piece
1221:	0FEE  CB41    	XC19:   BIT     0,c             ; Attacker or defender ?
1222:	0FF0  2802    	        JR      Z,rel010        ; Jump if defender
1223:	0FF2  ED44    	        NEG                     ; Negate value for attacker
1224:	0FF4  83      	rel010: ADD     a,e             ; Total points lost
1225:	0FF5  5F      	        LD      e,a             ; Save total
1226:	0FF6  08      	        EX      af,af'          ; Restore previous defender
1227:	0FF7  C8      	        RET     Z               ; Return if none
1228:	0FF8  45      	        LD      b,l             ; Prev attckr becomes defender
1229:	0FF9  C3D40F  	        JP      XC10            ; Jump
1230:			
1231:			;***********************************************************
1232:			; NEXT ATTACKER/DEFENDER ROUTINE
1233:			;***********************************************************
1234:			; FUNCTION:   --  To retrieve the next attacker or defender
1235:			;                 piece value from the attack list, and delete
1236:			;                 that piece from the list.
1237:			;
1238:			; CALLED BY:  --  XCHNG
1239:			;
1240:			; CALLS:      --  None
1241:			;
1242:			; ARGUMENTS:  --  Attack list addresses.
1243:			;                 Side flag
1244:			;                 Attack list counts
1245:			;***********************************************************
1246:	0FFC  0C      	NEXTAD: INC     c               ; Increment side flag
1247:	0FFD  D9      	        EXX                     ; Swap registers
1248:	0FFE  78      	        LD      a,b             ; Swap list counts
1249:	0FFF  41      	        LD      b,c
1250:	1000  4F      	        LD      c,a
1251:	1001  EB      	        EX      de,hl           ; Swap list pointers
1252:	1002  AF      	        XOR     a,a
1253:	1003  B8      	        CP      a,b             ; At end of list ?
1254:	1004  2809    	        JR      Z,NX6           ; Yes - jump
1255:	1006  05      	        DEC     b               ; Decrement list count
1256:	1007  23      	back03: INC     hl              ; Increment list inter
1257:	1008  BE      	        CP      a,(hl)          ; Check next item in list
1258:	1009  28FC    	        JR      Z,back03        ; Jump if empty
1259:	100B  ED67    	        RRD                     ; Get value from list
1260:	100D  87      	        ADD     a,a             ; Double it
1261:	100E  2B      	        DEC     hl              ; Decrement list pointer
1262:	100F  D9      	NX6:    EXX                     ; Restore regs.
1263:	1010  C9      	        RET                     ; Return
1264:			
1265:			;***********************************************************
1266:			; POINT EVALUATION ROUTINE
1267:			;***********************************************************
1268:			;FUNCTION:   --  To perform a static board evaluation and
1269:			;                derive a score for a given board position
1270:			;
1271:			; CALLED BY:  --  FNDMOV
1272:			;                 EVAL
1273:			;
1274:			; CALLS:      --  ATTACK
1275:			;                 XCHNG
1276:			;                 LIMIT
1277:			;
1278:			; ARGUMENTS:  --  None
1279:			;***********************************************************
1280:	1011  AF      	POINTS: XOR     a,a             ; Zero out variables
1281:	1012  323000  	        LD      (MTRL),a
1282:	1015  322C00  	        LD      (BRDC),a
1283:	1018  322D00  	        LD      (PTSL),a
1284:	101B  322E00  	        LD      (PTSW1),a
1285:	101E  322F00  	        LD      (PTSW2),a
1286:	1021  323300  	        LD      (PTSCK),a
1287:	1024  210800  	        LD      hl,T1           ; Set attacker flag
1288:	1027  3607    	        LD      (hl),7
1289:	1029  3E15    	        LD      a,21            ; Init to first square on board
1290:	102B  320400  	PT5:    LD      (M3),a          ; Save as board index
1291:	102E  DD2A0400	        LD      ix,(M3)         ; Load board index
1292:	1032  DD7EB4  	        LD      a,(ix+BOARD)    ; Get piece from board
1293:	1035  FEFF    	        CP      a,-1            ; Off board edge ?
1294:	1037  CAEB10  	        JP      Z,PT25          ; Yes - jump
1295:	103A  212200  	        LD      hl,P1           ; Save piece, if any
1296:	103D  77      	        LD      (hl),a
1297:	103E  E607    	        AND     a,7             ; Save piece type, if any
1298:	1040  320C00  	        LD      (T3),a
1299:	1043  FE02    	        CP      a,KNIGHT        ; Less than a Knight (Pawn) ?
1300:	1045  3839    	        JR      C,PT6X          ; Yes - Jump
1301:	1047  FE04    	        CP      a,ROOK          ; Rook, Queen or King ?
1302:	1049  3824    	        JR      C,PT6B          ; No - jump
1303:	104B  FE06    	        CP      a,KING          ; Is it a King ?
1304:	104D  280A    	        JR      Z,PT6AA         ; Yes - jump
1305:	104F  3A2600  	        LD      a,(MOVENO)      ; Get move number
1306:	1052  FE07    	        CP      a,7             ; Less than 7 ?
1307:	1054  3812    	        JR      C,PT6A          ; Yes - Jump
1308:	1056  C38010  	        JP      PT6X            ; Jump
1309:	1059  CB66    	PT6AA:  BIT     4,(hl)          ; Castled yet ?
1310:	105B  280B    	        JR      Z,PT6A          ; No - jump
1311:	105D  3E06    	        LD      a,+6            ; Bonus for castling
1312:	105F  CB7E    	        BIT     7,(hl)          ; Check piece color
1313:	1061  2818    	        JR      Z,PT6D          ; Jump if white
1314:	1063  3EFA    	        LD      a,-6            ; Bonus for black castling
1315:	1065  C37B10  	        JP      PT6D            ; Jump
1316:	1068  CB5E    	PT6A:   BIT     3,(hl)          ; Has piece moved yet ?
1317:	106A  2814    	        JR      Z,PT6X          ; No - jump
1318:	106C  C37310  	        JP      PT6C            ; Jump
1319:	106F  CB5E    	PT6B:   BIT     3,(hl)          ; Has piece moved yet ?
1320:	1071  200D    	        JR      NZ,PT6X         ; Yes - jump
1321:	1073  3EFE    	PT6C:   LD      a,-2            ; Two point penalty for white
1322:	1075  CB7E    	        BIT     7,(hl)          ; Check piece color
1323:	1077  2802    	        JR      Z,PT6D          ; Jump if white
1324:	1079  3E02    	        LD      a,+2            ; Two point penalty for black
1325:	107B  212C00  	PT6D:   LD      hl,BRDC         ; Get address of board control
1326:	107E  86      	        ADD     a,(hl)          ; Add on penalty/bonus points
1327:	107F  77      	        LD      (hl),a          ; Save
1328:	1080  AF      	PT6X:   XOR     a,a             ; Zero out attack list
1329:	1081  060E    	        LD      b,14
1330:	1083  212C01  	        LD      hl,ATKLST
1331:	1086  77      	back04: LD      (hl),a
1332:	1087  23      	        INC     hl
1333:	1088  10FC    	        DJNZ    back04
1334:	108A  CDB90D  	        CALL    ATTACK          ; Build attack list for square
1335:	108D  213301  	        LD      hl,BACT         ; Get black attacker count addr
1336:	1090  3A2C01  	        LD      a,(WACT)        ; Get white attacker count
1337:	1093  96      	        SUB     a,(hl)          ; Compute count difference
1338:	1094  212C00  	        LD      hl,BRDC         ; Address of board control
1339:	1097  86      	        ADD     a,(hl)          ; Accum board control score
1340:	1098  77      	        LD      (hl),a          ; Save
1341:	1099  3A2200  	        LD      a,(P1)          ; Get piece on current square
1342:	109C  A7      	        AND     a,a             ; Is it empty ?
1343:	109D  CAEB10  	        JP      Z,PT25          ; Yes - jump
1344:	10A0  CDAE0F  	        CALL    XCHNG           ; Evaluate exchange, if any
1345:	10A3  AF      	        XOR     a,a             ; Check for a loss
1346:	10A4  BB      	        CP      a,e             ; Points lost ?
1347:	10A5  2835    	        JR      Z,PT23          ; No - Jump
1348:	10A7  15      	        DEC     d               ; Deduct half a Pawn value
1349:	10A8  3A2200  	        LD      a,(P1)          ; Get piece under attack
1350:	10AB  212100  	        LD      hl,COLOR        ; Color of side just moved
1351:	10AE  AE      	        XOR     a,(hl)          ; Compare with piece
1352:	10AF  CB7F    	        BIT     7,a             ; Do colors match ?
1353:	10B1  7B      	        LD      a,e             ; Points lost
1354:	10B2  2019    	        JR      NZ,PT20         ; Jump if no match
1355:	10B4  212D00  	        LD      hl,PTSL         ; Previous max points lost
1356:	10B7  BE      	        CP      a,(hl)          ; Compare to current value
1357:	10B8  3822    	        JR      C,PT23          ; Jump if greater than
1358:	10BA  73      	        LD      (hl),e          ; Store new value as max lost
1359:	10BB  DD2A1600	        LD      ix,(MLPTRJ)     ; Load pointer to this move
1360:	10BF  3A0400  	        LD      a,(M3)          ; Get position of lost piece
1361:	10C2  DDBE03  	        CP      a,(ix+MLTOP)    ; Is it the one moving ?
1362:	10C5  2015    	        JR      NZ,PT23         ; No - jump
1363:	10C7  323300  	        LD      (PTSCK),a       ; Save position as a flag
1364:	10CA  C3DC10  	        JP      PT23            ; Jump
1365:	10CD  212E00  	PT20:   LD      hl,PTSW1        ; Previous maximum points won
1366:	10D0  BE      	        CP      a,(hl)          ; Compare to current value
1367:	10D1  3802    	        JR      C,rel011        ; Jump if greater than
1368:	10D3  7E      	        LD      a,(hl)          ; Load previous max value
1369:	10D4  73      	        LD      (hl),e          ; Store new value as max won
1370:	10D5  212F00  	rel011: LD      hl,PTSW2        ; Previous 2nd max points won
1371:	10D8  BE      	        CP      a,(hl)          ; Compare to current value
1372:	10D9  3801    	        JR      C,PT23          ; Jump if greater than
1373:	10DB  77      	        LD      (hl),a          ; Store as new 2nd max lost
1374:	10DC  212200  	PT23:   LD      hl,P1           ; Get piece
1375:	10DF  CB7E    	        BIT     7,(hl)          ; Test color
1376:	10E1  7A      	        LD      a,d             ; Value of piece
1377:	10E2  2802    	        JR      Z,rel012        ; Jump if white
1378:	10E4  ED44    	        NEG                     ; Negate for black
1379:	10E6  213000  	rel012: LD      hl,MTRL         ; Get addrs of material total
1380:	10E9  86      	        ADD     a,(hl)          ; Add new value
1381:	10EA  77      	        LD      (hl),a          ; Store
1382:	10EB  3A0400  	PT25:   LD      a,(M3)          ; Get current board position
1383:	10EE  3C      	        INC     a               ; Increment
1384:	10EF  FE63    	        CP      a,99            ; At end of board ?
1385:	10F1  C22B10  	        JP      NZ,PT5          ; No - jump
1386:	10F4  3A3300  	        LD      a,(PTSCK)       ; Moving piece lost flag
1387:	10F7  A7      	        AND     a,a             ; Was it lost ?
1388:	10F8  280A    	        JR      Z,PT25A         ; No - jump
1389:	10FA  3A2F00  	        LD      a,(PTSW2)       ; 2nd max points won
1390:	10FD  322E00  	        LD      (PTSW1),a       ; Store as max points won
1391:	1100  AF      	        XOR     a,a             ; Zero out 2nd max points won
1392:	1101  322F00  	        LD      (PTSW2),a
1393:	1104  3A2D00  	PT25A:  LD      a,(PTSL)        ; Get max points lost
1394:	1107  A7      	        AND     a,a             ; Is it zero ?
1395:	1108  2801    	        JR      Z,rel013        ; Yes - jump
1396:	110A  3D      	        DEC     a               ; Decrement it
1397:	110B  47      	rel013: LD      b,a             ; Save it
1398:	110C  3A2E00  	        LD      a,(PTSW1)       ; Max,points won
1399:	110F  A7      	        AND     a,a             ; Is it zero ?
1400:	1110  2809    	        JR      Z,rel014        ; Yes - jump
1401:	1112  3A2F00  	        LD      a,(PTSW2)       ; 2nd max points won
1402:	1115  A7      	        AND     a,a             ; Is it zero ?
1403:	1116  2803    	        JR      Z,rel014        ; Yes - jump
1404:	1118  3D      	        DEC     a               ; Decrement it
1405:	1119  CB3F    	        SRL     a               ; Divide it by 2
1406:	111B  90      	rel014: SUB     a,b             ; Subtract points lost
1407:	111C  212100  	        LD      hl,COLOR        ; Color of side just moved ???
1408:	111F  CB7E    	        BIT     7,(hl)          ; Is it white ?
1409:	1121  2802    	        JR      Z,rel015        ; Yes - jump
1410:	1123  ED44    	        NEG                     ; Negate for black
1411:	1125  213000  	rel015: LD      hl,MTRL         ; Net material on board
1412:	1128  86      	        ADD     a,(hl)          ; Add exchange adjustments
1413:	1129  213200  	        LD      hl,MV0          ; Material at ply 0
1414:	112C  96      	        SUB     a,(hl)          ; Subtract from current
1415:	112D  47      	        LD      b,a             ; Save
1416:	112E  3E1E    	        LD      a,30            ; Load material limit
1417:	1130  CD6411  	        CALL    LIMIT           ; Limit to plus or minus value
1418:	1133  5F      	        LD      e,a             ; Save limited value
1419:	1134  3A2C00  	        LD      a,(BRDC)        ; Get board control points
1420:	1137  213100  	        LD      hl,BC0          ; Board control at ply zero
1421:	113A  96      	        SUB     a,(hl)          ; Get difference
1422:	113B  47      	        LD      b,a             ; Save
1423:	113C  3A3300  	        LD      a,(PTSCK)       ; Moving piece lost flag
1424:	113F  A7      	        AND     a,a             ; Is it zero ?
1425:	1140  2802    	        JR      Z,rel026        ; Yes - jump
1426:	1142  0600    	        LD      b,0             ; Zero board control points
1427:	1144  3E06    	rel026: LD      a,6             ; Load board control limit
1428:	1146  CD6411  	        CALL    LIMIT           ; Limit to plus or minus value
1429:	1149  57      	        LD      d,a             ; Save limited value
1430:	114A  7B      	        LD      a,e             ; Get material points
1431:	114B  87      	        ADD     a,a             ; Multiply by 4
1432:	114C  87      	        ADD     a,a
1433:	114D  82      	        ADD     a,d             ; Add board control
1434:	114E  212100  	        LD      hl,COLOR        ; Color of side just moved
1435:	1151  CB7E    	        BIT     7,(hl)          ; Is it white ?
1436:	1153  2002    	        JR      NZ,rel016       ; No - jump
1437:	1155  ED44    	        NEG                     ; Negate for white
1438:	1157  C680    	rel016: ADD     a,80H           ; Rescale score (neutral = 80H)
1439:	1159  322B00  	        LD      (VALM),a        ; Save score
1440:	115C  DD2A1600	        LD      ix,(MLPTRJ)     ; Load move list pointer
1441:	1160  DD7705  	        LD      (ix+MLVAL),a    ; Save score in move list
1442:	1163  C9      	        RET                     ; Return
1443:			
1444:			;***********************************************************
1445:			; LIMIT ROUTINE
1446:			;***********************************************************
1447:			; FUNCTION:   --  To limit the magnitude of a given value
1448:			;                 to another given value.
1449:			;
1450:			; CALLED BY:  --  POINTS
1451:			;
1452:			; CALLS:      --  None
1453:			;
1454:			; ARGUMENTS:  --  Input  - Value, to be limited in the B
1455:			;                          register.
1456:			;                        - Value to limit to in the A register
1457:			;                 Output - Limited value in the A register.
1458:			;***********************************************************
1459:	1164  CB78    	LIMIT:  BIT     7,b             ; Is value negative ?
1460:	1166  CA6F11  	        JP      Z,LIM10         ; No - jump
1461:	1169  ED44    	        NEG                     ; Make positive
1462:	116B  B8      	        CP      a,b             ; Compare to limit
1463:	116C  D0      	        RET     NC              ; Return if outside limit
1464:	116D  78      	        LD      a,b             ; Output value as is
1465:	116E  C9      	        RET                     ; Return
1466:	116F  B8      	LIM10:  CP      a,b             ; Compare to limit
1467:	1170  D8      	        RET     C               ; Return if outside limit
1468:	1171  78      	        LD      a,b             ; Output value as is
1469:	1172  C9      	        RET                     ; Return
1470:			
1471:			;***********************************************************
1472:			; MOVE ROUTINE
1473:			;***********************************************************
1474:			; FUNCTION:   --  To execute a move from the move list on the
1475:			;                 board array.
1476:			;
1477:			; CALLED BY:  --  CPTRMV
1478:			;                 PLYRMV
1479:			;                 EVAL
1480:			;                 FNDMOV
1481:			;                 VALMOV
1482:			;
1483:			; CALLS:      --  None
1484:			;
1485:			; ARGUMENTS:  --  None
1486:			;***********************************************************
1487:	1173  2A1600  	MOVE:   LD      hl,(MLPTRJ)     ; Load move list pointer
1488:	1176  23      	        INC     hl              ; Increment past link bytes
1489:	1177  23      	        INC     hl
1490:	1178  7E      	MV1:    LD      a,(hl)          ; "From" position
1491:	1179  320000  	        LD      (M1),a          ; Save
1492:	117C  23      	        INC     hl              ; Increment pointer
1493:	117D  7E      	        LD      a,(hl)          ; "To" position
1494:	117E  320200  	        LD      (M2),a          ; Save
1495:	1181  23      	        INC     hl              ; Increment pointer
1496:	1182  56      	        LD      d,(hl)          ; Get captured piece/flags
1497:	1183  DD2A0000	        LD      ix,(M1)         ; Load "from" pos board index
1498:	1187  DD5EB4  	        LD      e,(ix+BOARD)    ; Get piece moved
1499:	118A  CB6A    	        BIT     5,d             ; Test Pawn promotion flag
1500:	118C  202D    	        JR      NZ,MV15         ; Jump if set
1501:	118E  7B      	        LD      a,e             ; Piece moved
1502:	118F  E607    	        AND     a,7             ; Clear flag bits
1503:	1191  FE05    	        CP      a,QUEEN         ; Is it a queen ?
1504:	1193  282B    	        JR      Z,MV20          ; Yes - jump
1505:	1195  FE06    	        CP      a,KING          ; Is it a king ?
1506:	1197  2836    	        JR      Z,MV30          ; Yes - jump
1507:	1199  FD2A0200	MV5:    LD      iy,(M2)         ; Load "to" pos board index
1508:	119D  CBDB    	        SET     3,e             ; Set piece moved flag
1509:	119F  FD73B4  	        LD      (iy+BOARD),e    ; Insert piece at new position
1510:	11A2  DD36B400	        LD      (ix+BOARD),0    ; Empty previous position
1511:	11A6  CB72    	        BIT     6,d             ; Double move ?
1512:	11A8  2031    	        JR      NZ,MV40         ; Yes - jump
1513:	11AA  7A      	        LD      a,d             ; Get captured piece, if any
1514:	11AB  E607    	        AND     a,7
1515:	11AD  FE05    	        CP      a,QUEEN         ; Was it a queen ?
1516:	11AF  C0      	        RET     NZ              ; No - return
1517:	11B0  215001  	        LD      hl,POSQ         ; Addr of saved Queen position
1518:	11B3  CB7A    	        BIT     7,d             ; Is Queen white ?
1519:	11B5  2801    	        JR      Z,MV10          ; Yes - jump
1520:	11B7  23      	        INC     hl              ; Increment to black Queen pos
1521:	11B8  AF      	MV10:   XOR     a,a             ; Set saved position to zero
1522:	11B9  77      	        LD      (hl),a
1523:	11BA  C9      	        RET                     ; Return
1524:	11BB  CBD3    	MV15:   SET     2,e             ; Change Pawn to a Queen
1525:	11BD  C39911  	        JP      MV5             ; Jump
1526:	11C0  215001  	MV20:   LD      hl,POSQ         ; Addr of saved Queen position
1527:	11C3  CB7B    	MV21:   BIT     7,e             ; Is Queen white ?
1528:	11C5  2801    	        JR      Z,MV22          ; Yes - jump
1529:	11C7  23      	        INC     hl              ; Increment to black Queen pos
1530:	11C8  3A0200  	MV22:   LD      a,(M2)          ; Get new Queen position
1531:	11CB  77      	        LD      (hl),a          ; Save
1532:	11CC  C39911  	        JP      MV5             ; Jump
1533:	11CF  214E01  	MV30:   LD      hl,POSK         ; Get saved King position
1534:	11D2  CB72    	        BIT     6,d             ; Castling ?
1535:	11D4  28ED    	        JR      Z,MV21          ; No - jump
1536:	11D6  CBE3    	        SET     4,e             ; Set King castled flag
1537:	11D8  C3C311  	        JP      MV21            ; Jump
1538:	11DB  2A1600  	MV40:   LD      hl,(MLPTRJ)     ; Get move list pointer
1539:	11DE  110800  	        LD      de,8            ; Increment to next move
1540:	11E1  19      	        ADD     hl,de
1541:	11E2  C37811  	        JP      MV1             ; Jump (2nd part of dbl move)
1542:			
1543:			;***********************************************************
1544:			; UN-MOVE ROUTINE
1545:			;***********************************************************
1546:			; FUNCTION:   --  To reverse the process of the move routine,
1547:			;                 thereby restoring the board array to its
1548:			;                 previous position.
1549:			;
1550:			; CALLED BY:  --  VALMOV
1551:			;                 EVAL
1552:			;                 FNDMOV
1553:			;                 ASCEND
1554:			;
1555:			; CALLS:      --  None
1556:			;
1557:			; ARGUMENTS:  --  None
1558:			;***********************************************************
1559:	11E5  2A1600  	UNMOVE: LD      hl,(MLPTRJ)     ; Load move list pointer
1560:	11E8  23      	        INC     hl              ; Increment past link bytes
1561:	11E9  23      	        INC     hl
1562:	11EA  7E      	UM1:    LD      a,(hl)          ; Get "from" position
1563:	11EB  320000  	        LD      (M1),a          ; Save
1564:	11EE  23      	        INC     hl              ; Increment pointer
1565:	11EF  7E      	        LD      a,(hl)          ; Get "to" position
1566:	11F0  320200  	        LD      (M2),a          ; Save
1567:	11F3  23      	        INC     hl              ; Increment pointer
1568:	11F4  56      	        LD      d,(hl)          ; Get captured piece/flags
1569:	11F5  DD2A0200	        LD      ix,(M2)         ; Load "to" pos board index
1570:	11F9  DD5EB4  	        LD      e,(ix+BOARD)    ; Get piece moved
1571:	11FC  CB6A    	        BIT     5,d             ; Was it a Pawn promotion ?
1572:	11FE  2033    	        JR      NZ,UM15         ; Yes - jump
1573:	1200  7B      	        LD      a,e             ; Get piece moved
1574:	1201  E607    	        AND     a,7             ; Clear flag bits
1575:	1203  FE05    	        CP      a,QUEEN         ; Was it a Queen ?
1576:	1205  2836    	        JR      Z,UM20          ; Yes - jump
1577:	1207  FE06    	        CP      a,KING          ; Was it a King ?
1578:	1209  2841    	        JR      Z,UM30          ; Yes - jump
1579:	120B  CB62    	UM5:    BIT     4,d             ; Is this 1st move for piece ?
1580:	120D  2029    	        JR      NZ,UM16         ; Yes - jump
1581:	120F  FD2A0000	UM6:    LD      iy,(M1)         ; Load "from" pos board index
1582:	1213  FD73B4  	        LD      (iy+BOARD),e    ; Return to previous board pos
1583:	1216  7A      	        LD      a,d             ; Get captured piece, if any
1584:	1217  E68F    	        AND     a,8FH           ; Clear flags
1585:	1219  DD77B4  	        LD      (ix+BOARD),a    ; Return to board
1586:	121C  CB72    	        BIT     6,d             ; Was it a double move ?
1587:	121E  2038    	        JR      NZ,UM40         ; Yes - jump
1588:	1220  7A      	        LD      a,d             ; Get captured piece, if any
1589:	1221  E607    	        AND     a,7             ; Clear flag bits
1590:	1223  FE05    	        CP      a,QUEEN         ; Was it a Queen ?
1591:	1225  C0      	        RET     NZ              ; No - return
1592:	1226  215001  	        LD      hl,POSQ         ; Address of saved Queen pos
1593:	1229  CB7A    	        BIT     7,d             ; Is Queen white ?
1594:	122B  2801    	        JR      Z,UM10          ; Yes - jump
1595:	122D  23      	        INC     hl              ; Increment to black Queen pos
1596:	122E  3A0200  	UM10:   LD      a,(M2)          ; Queen's previous position
1597:	1231  77      	        LD      (hl),a          ; Save
1598:	1232  C9      	        RET                     ; Return
1599:	1233  CB93    	UM15:   RES     2,e             ; Restore Queen to Pawn
1600:	1235  C30B12  	        JP      UM5             ; Jump
1601:	1238  CB9B    	UM16:   RES     3,e             ; Clear piece moved flag
1602:	123A  C30F12  	        JP      UM6             ; Jump
1603:	123D  215001  	UM20:   LD      hl,POSQ         ; Addr of saved Queen position
1604:	1240  CB7B    	UM21:   BIT     7,e             ; Is Queen white ?
1605:	1242  2801    	        JR      Z,UM22          ; Yes - jump
1606:	1244  23      	        INC     hl              ; Increment to black Queen pos
1607:	1245  3A0000  	UM22:   LD      a,(M1)          ; Get previous position
1608:	1248  77      	        LD      (hl),a          ; Save
1609:	1249  C30B12  	        JP      UM5             ; Jump
1610:	124C  214E01  	UM30:   LD      hl,POSK         ; Address of saved King pos
1611:	124F  CB72    	        BIT     6,d             ; Was it a castle ?
1612:	1251  28ED    	        JR      Z,UM21          ; No - jump
1613:	1253  CBA3    	        RES     4,e             ; Clear castled flag
1614:	1255  C34012  	        JP      UM21            ; Jump
1615:	1258  2A1600  	UM40:   LD      hl,(MLPTRJ)     ; Load move list pointer
1616:	125B  110800  	        LD      de,8            ; Increment to next move
1617:	125E  19      	        ADD     hl,de
1618:	125F  C3EA11  	        JP      UM1             ; Jump (2nd part of dbl move)
1619:			
1620:			;***********************************************************
1621:			; SORT ROUTINE
1622:			;***********************************************************
1623:			; FUNCTION:   --  To sort the move list in order of
1624:			;                 increasing move value scores.
1625:			;
1626:			; CALLED BY:  --  FNDMOV
1627:			;
1628:			; CALLS:      --  EVAL
1629:			;
1630:			; ARGUMENTS:  --  None
1631:			;***********************************************************
1632:	1262  ED4B1400	SORTM:  LD      bc,(MLPTRI)     ; Move list begin pointer
1633:	1266  110000  	        LD      de,0            ; Initialize working pointers
1634:	1269  60      	SR5:    LD      h,b
1635:	126A  69      	        LD      l,c
1636:	126B  4E      	        LD      c,(hl)          ; Link to next move
1637:	126C  23      	        INC     hl
1638:	126D  46      	        LD      b,(hl)
1639:	126E  72      	        LD      (hl),d          ; Store to link in list
1640:	126F  2B      	        DEC     hl
1641:	1270  73      	        LD      (hl),e
1642:	1271  AF      	        XOR     a,a             ; End of list ?
1643:	1272  B8      	        CP      a,b
1644:	1273  C8      	        RET     Z               ; Yes - return
1645:	1274  ED431600	SR10:   LD      (MLPTRJ),bc     ; Save list pointer
1646:	1278  CD9E12  	        CALL    EVAL            ; Evaluate move
1647:	127B  2A1400  	        LD      hl,(MLPTRI)     ; Begining of move list
1648:	127E  ED4B1600	        LD      bc,(MLPTRJ)     ; Restore list pointer
1649:	1282  5E      	SR15:   LD      e,(hl)          ; Next move for compare
1650:	1283  23      	        INC     hl
1651:	1284  56      	        LD      d,(hl)
1652:	1285  AF      	        XOR     a,a             ; At end of list ?
1653:	1286  BA      	        CP      a,d
1654:	1287  280B    	        JR      Z,SR25          ; Yes - jump
1655:	1289  D5      	        PUSH    de              ; Transfer move pointer
1656:	128A  DDE1    	        POP     ix
1657:	128C  3A2B00  	        LD      a,(VALM)        ; Get new move value
1658:	128F  DDBE05  	        CP      a,(ix+MLVAL)    ; Less than list value ?
1659:	1292  3006    	        JR      NC,SR30         ; No - jump
1660:	1294  70      	SR25:   LD      (hl),b          ; Link new move into list
1661:	1295  2B      	        DEC     hl
1662:	1296  71      	        LD      (hl),c
1663:	1297  C36912  	        JP      SR5             ; Jump
1664:	129A  EB      	SR30:   EX      de,hl           ; Swap pointers
1665:	129B  C38212  	        JP      SR15            ; Jump
1666:			
1667:			;***********************************************************
1668:			; EVALUATION ROUTINE
1669:			;***********************************************************
1670:			; FUNCTION:   --  To evaluate a given move in the move list.
1671:			;                 It first makes the move on the board, then if
1672:			;                 the move is legal, it evaluates it, and then
1673:			;                 restores the board position.
1674:			;
1675:			; CALLED BY:  --  SORT
1676:			;
1677:			; CALLS:      --  MOVE
1678:			;                 INCHK
1679:			;                 PINFND
1680:			;                 POINTS
1681:			;                 UNMOVE
1682:			;
1683:			; ARGUMENTS:  --  None
1684:			;***********************************************************
1685:	129E  CD7311  	EVAL:   CALL    MOVE            ; Make move on the board array
1686:	12A1  CD980D  	        CALL    INCHK           ; Determine if move is legal
1687:	12A4  A7      	        AND     a,a             ; Legal move ?
1688:	12A5  2807    	        JR      Z,EV5           ; Yes - jump
1689:	12A7  AF      	        XOR     a,a             ; Score of zero
1690:	12A8  322B00  	        LD      (VALM),a        ; For illegal move
1691:	12AB  C3B412  	        JP      EV10            ; Jump
1692:	12AE  CDE40E  	EV5:    CALL    PINFND          ; Compile pinned list
1693:	12B1  CD1110  	        CALL    POINTS          ; Assign points to move
1694:	12B4  CDE511  	EV10:   CALL    UNMOVE          ; Restore board array
1695:	12B7  C9      	        RET                     ; Return
1696:			
1697:			;***********************************************************
1698:			; FIND MOVE ROUTINE
1699:			;***********************************************************
1700:			; FUNCTION:   --  To determine the computer's best move by
1701:			;                 performing a depth first tree search using
1702:			;                 the techniques of alpha-beta pruning.
1703:			;
1704:			; CALLED BY:  --  CPTRMV
1705:			;
1706:			; CALLS:      --  PINFND
1707:			;                 POINTS
1708:			;                 GENMOV
1709:			;                 SORTM
1710:			;                 ASCEND
1711:			;                 UNMOVE
1712:			;
1713:			; ARGUMENTS:  --  None
1714:			;***********************************************************
1715:	12B8  3A2600  	FNDMOV: LD      a,(MOVENO)      ; Current move number
1716:	12BB  FE01    	        CP      a,1             ; First move ?
1717:	12BD  CC3E14  	        CALL    Z,BOOK          ; Yes - execute book opening
1718:	12C0  AF      	        XOR     a,a             ; Initialize ply number to zero
1719:	12C1  322800  	        LD      (NPLY),a
1720:	12C4  210000  	        LD      hl,0            ; Initialize best move to zero
1721:	12C7  221A00  	        LD      (BESTM),hl
1722:	12CA  210003  	        LD      hl,MLIST        ; Initialize ply list pointers
1723:	12CD  221E00  	        LD      (MLNXT),hl
1724:	12D0  215D01  	        LD      hl,PLYIX-2
1725:	12D3  221400  	        LD      (MLPTRI),hl
1726:	12D6  3A2000  	        LD      a,(KOLOR)       ; Initialize color
1727:	12D9  322100  	        LD      (COLOR),a
1728:	12DC  215301  	        LD      hl,SCORE        ; Initialize score index
1729:	12DF  221800  	        LD      (SCRIX),hl
1730:	12E2  3A2700  	        LD      a,(PLYMAX)      ; Get max ply number
1731:	12E5  C602    	        ADD     a,2             ; Add 2
1732:	12E7  47      	        LD      b,a             ; Save as counter
1733:	12E8  AF      	        XOR     a,a             ; Zero out score table
1734:	12E9  77      	back05: LD      (hl),a
1735:	12EA  23      	        INC     hl
1736:	12EB  10FC    	        DJNZ    back05
1737:	12ED  323100  	        LD      (BC0),a         ; Zero ply 0 board control
1738:	12F0  323200  	        LD      (MV0),a         ; Zero ply 0 material
1739:	12F3  CDE40E  	        CALL    PINFND          ; Compile pin list
1740:	12F6  CD1110  	        CALL    POINTS          ; Evaluate board at ply 0
1741:	12F9  3A2C00  	        LD      a,(BRDC)        ; Get board control points
1742:	12FC  323100  	        LD      (BC0),a         ; Save
1743:	12FF  3A3000  	        LD      a,(MTRL)        ; Get material count
1744:	1302  323200  	        LD      (MV0),a         ; Save
1745:	1305  212800  	FM5:    LD      hl,NPLY         ; Address of ply counter
1746:	1308  34      	        INC     (hl)            ; Increment ply count
1747:	1309  AF      	        XOR     a,a             ; Initialize mate flag
1748:	130A  322A00  	        LD      (MATEF),a
1749:	130D  CD560D  	        CALL    GENMOV          ; Generate list of moves
1750:	1310  3A2800  	        LD      a,(NPLY)        ; Current ply counter
1751:	1313  212700  	        LD      hl,PLYMAX       ; Address of maximum ply number
1752:	1316  BE      	        CP      a,(hl)          ; At max ply ?
1753:	1317  DC6212  	        CALL    C,SORTM         ; No - call sort
1754:	131A  2A1400  	        LD      hl,(MLPTRI)     ; Load ply index pointer
1755:	131D  221600  	        LD      (MLPTRJ),hl     ; Save as last move pointer
1756:	1320  2A1600  	FM15:   LD      hl,(MLPTRJ)     ; Load last move pointer
1757:	1323  5E      	        LD      e,(hl)          ; Get next move pointer
1758:	1324  23      	        INC     hl
1759:	1325  56      	        LD      d,(hl)
1760:	1326  7A      	        LD      a,d
1761:	1327  A7      	        AND     a,a             ; End of move list ?
1762:	1328  2863    	        JR      Z,FM25          ; Yes - jump
1763:	132A  ED531600	        LD      (MLPTRJ),de     ; Save current move pointer
1764:	132E  2A1400  	        LD      hl,(MLPTRI)     ; Save in ply pointer list
1765:	1331  73      	        LD      (hl),e
1766:	1332  23      	        INC     hl
1767:	1333  72      	        LD      (hl),d
1768:	1334  3A2800  	        LD      a,(NPLY)        ; Current ply counter
1769:	1337  212700  	        LD      hl,PLYMAX       ; Maximum ply number ?
1770:	133A  BE      	        CP      a,(hl)          ; Compare
1771:	133B  3826    	        JR      C,FM18          ; Jump if not max
1772:	133D  CD7311  	        CALL    MOVE            ; Execute move on board array
1773:	1340  CD980D  	        CALL    INCHK           ; Check for legal move
1774:	1343  A7      	        AND     a,a             ; Is move legal
1775:	1344  2806    	        JR      Z,rel017        ; Yes - jump
1776:	1346  CDE511  	        CALL    UNMOVE          ; Restore board position
1777:	1349  C32013  	        JP      FM15            ; Jump
1778:	134C  3A2800  	rel017: LD      a,(NPLY)        ; Get ply counter
1779:	134F  212700  	        LD      hl,PLYMAX       ; Max ply number
1780:	1352  BE      	        CP      a,(hl)          ; Beyond max ply ?
1781:	1353  2065    	        JR      NZ,FM35         ; Yes - jump
1782:	1355  3A2100  	        LD      a,(COLOR)       ; Get current color
1783:	1358  EE80    	        XOR     a,80H           ; Get opposite color
1784:	135A  CD9B0D  	        CALL    INCHK1          ; Determine if King is in check
1785:	135D  A7      	        AND     a,a             ; In check ?
1786:	135E  285A    	        JR      Z,FM35          ; No - jump
1787:	1360  C37013  	        JP      FM19            ; Jump (One more ply for check)
1788:	1363  DD2A1600	FM18:   LD      ix,(MLPTRJ)     ; Load move pointer
1789:	1367  DD7E05  	        LD      a,(ix+MLVAL)    ; Get move score
1790:	136A  A7      	        AND     a,a             ; Is it zero (illegal move) ?
1791:	136B  28B3    	        JR      Z,FM15          ; Yes - jump
1792:	136D  CD7311  	        CALL    MOVE            ; Execute move on board array
1793:	1370  212100  	FM19:   LD      hl,COLOR        ; Toggle color
1794:	1373  3E80    	        LD      a,80H
1795:	1375  AE      	        XOR     a,(hl)
1796:	1376  77      	        LD      (hl),a          ; Save new color
1797:	1377  CB7F    	        BIT     7,a             ; Is it white ?
1798:	1379  2004    	        JR      NZ,rel018       ; No - jump
1799:	137B  212600  	        LD      hl,MOVENO       ; Increment move number
1800:	137E  34      	        INC     (hl)
1801:	137F  2A1800  	rel018: LD      hl,(SCRIX)      ; Load score table pointer
1802:	1382  7E      	        LD      a,(hl)          ; Get score two plys above
1803:	1383  23      	        INC     hl              ; Increment to current ply
1804:	1384  23      	        INC     hl
1805:	1385  77      	        LD      (hl),a          ; Save score as initial value
1806:	1386  2B      	        DEC     hl              ; Decrement pointer
1807:	1387  221800  	        LD      (SCRIX),hl      ; Save it
1808:	138A  C30513  	        JP      FM5             ; Jump
1809:	138D  3A2A00  	FM25:   LD      a,(MATEF)       ; Get mate flag
1810:	1390  A7      	        AND     a,a             ; Checkmate or stalemate ?
1811:	1391  2013    	        JR      NZ,FM30         ; No - jump
1812:	1393  3A2900  	        LD      a,(CKFLG)       ; Get check flag
1813:	1396  A7      	        AND     a,a             ; Was King in check ?
1814:	1397  3E80    	        LD      a,80H           ; Pre-set stalemate score
1815:	1399  282B    	        JR      Z,FM36          ; No - jump (stalemate)
1816:	139B  3A2600  	        LD      a,(MOVENO)      ; Get move number
1817:	139E  322500  	        LD      (PMATE),a       ; Save
1818:	13A1  3EFF    	        LD      a,0FFH          ; Pre-set checkmate score
1819:	13A3  C3C613  	        JP      FM36            ; Jump
1820:	13A6  3A2800  	FM30:   LD      a,(NPLY)        ; Get ply counter
1821:	13A9  FE01    	        CP      a,1             ; At top of tree ?
1822:	13AB  C8      	        RET     Z               ; Yes - return
1823:	13AC  CD0A14  	        CALL    ASCEND          ; Ascend one ply in tree
1824:	13AF  2A1800  	        LD      hl,(SCRIX)      ; Load score table pointer
1825:	13B2  23      	        INC     hl              ; Increment to current ply
1826:	13B3  23      	        INC     hl
1827:	13B4  7E      	        LD      a,(hl)          ; Get score
1828:	13B5  2B      	        DEC     hl              ; Restore pointer
1829:	13B6  2B      	        DEC     hl
1830:	13B7  C3CE13  	        JP      FM37            ; Jump
1831:	13BA  CDE40E  	FM35:   CALL    PINFND          ; Compile pin list
1832:	13BD  CD1110  	        CALL    POINTS          ; Evaluate move
1833:	13C0  CDE511  	        CALL    UNMOVE          ; Restore board position
1834:	13C3  3A2B00  	        LD      a,(VALM)        ; Get value of move
1835:	13C6  212A00  	FM36:   LD      hl,MATEF        ; Set mate flag
1836:	13C9  CBC6    	        SET     0,(hl)
1837:	13CB  2A1800  	        LD      hl,(SCRIX)      ; Load score table pointer
1838:	13CE  BE      	FM37:   CP      a,(hl)          ; Compare to score 2 ply above
1839:	13CF  3833    	        JR      C,FM40          ; Jump if less
1840:	13D1  2831    	        JR      Z,FM40          ; Jump if equal
1841:	13D3  ED44    	        NEG                     ; Negate score
1842:	13D5  23      	        INC     hl              ; Incr score table pointer
1843:	13D6  BE      	        CP      a,(hl)          ; Compare to score 1 ply above
1844:	13D7  DA2013  	        JP      C,FM15          ; Jump if less than
1845:	13DA  CA2013  	        JP      Z,FM15          ; Jump if equal
1846:	13DD  77      	        LD      (hl),a          ; Save as new score 1 ply above
1847:	13DE  3A2800  	        LD      a,(NPLY)        ; Get current ply counter
1848:	13E1  FE01    	        CP      a,1             ; At top of tree ?
1849:	13E3  C22013  	        JP      NZ,FM15         ; No - jump
1850:	13E6  2A1600  	        LD      hl,(MLPTRJ)     ; Load current move pointer
1851:	13E9  221A00  	        LD      (BESTM),hl      ; Save as best move pointer
1852:	13EC  3A5401  	        LD      a,(SCORE+1)     ; Get best move score
1853:	13EF  FEFF    	        CP      a,0FFH          ; Was it a checkmate ?
1854:	13F1  C22013  	        JP      NZ,FM15         ; No - jump
1855:	13F4  212700  	        LD      hl,PLYMAX       ; Get maximum ply number
1856:	13F7  35      	        DEC     (hl)            ; Subtract 2
1857:	13F8  35      	        DEC     (hl)
1858:	13F9  3A2000  	        LD      a,(KOLOR)       ; Get computer's color
1859:	13FC  CB7F    	        BIT     7,a             ; Is it white ?
1860:	13FE  C8      	        RET     Z               ; Yes - return
1861:	13FF  212500  	        LD      hl,PMATE        ; Checkmate move number
1862:	1402  35      	        DEC     (hl)            ; Decrement
1863:	1403  C9      	        RET                     ; Return
1864:	1404  CD0A14  	FM40:   CALL    ASCEND          ; Ascend one ply in tree
1865:	1407  C32013  	        JP      FM15            ; Jump
1866:			
1867:			;***********************************************************
1868:			; ASCEND TREE ROUTINE
1869:			;***********************************************************
1870:			; FUNCTION:  --  To adjust all necessary parameters to
1871:			;                ascend one ply in the tree.
1872:			;
1873:			; CALLED BY: --  FNDMOV
1874:			;
1875:			; CALLS:     --  UNMOVE
1876:			;
1877:			; ARGUMENTS: --  None
1878:			;***********************************************************
1879:	140A  212100  	ASCEND: LD      hl,COLOR        ; Toggle color
1880:	140D  3E80    	        LD      a,80H
1881:	140F  AE      	        XOR     a,(hl)
1882:	1410  77      	        LD      (hl),a          ; Save new color
1883:	1411  CB7F    	        BIT     7,a             ; Is it white ?
1884:	1413  2804    	        JR      Z,rel019        ; Yes - jump
1885:	1415  212600  	        LD      hl,MOVENO       ; Decrement move number
1886:	1418  35      	        DEC     (hl)
1887:	1419  2A1800  	rel019: LD      hl,(SCRIX)      ; Load score table index
1888:	141C  2B      	        DEC     hl              ; Decrement
1889:	141D  221800  	        LD      (SCRIX),hl      ; Save
1890:	1420  212800  	        LD      hl,NPLY         ; Decrement ply counter
1891:	1423  35      	        DEC     (hl)
1892:	1424  2A1400  	        LD      hl,(MLPTRI)     ; Load ply list pointer
1893:	1427  2B      	        DEC     hl              ; Load pointer to move list top
1894:	1428  56      	        LD      d,(hl)
1895:	1429  2B      	        DEC     hl
1896:	142A  5E      	        LD      e,(hl)
1897:	142B  ED531E00	        LD      (MLNXT),de      ; Update move list avail ptr
1898:	142F  2B      	        DEC     hl              ; Get ptr to next move to undo
1899:	1430  56      	        LD      d,(hl)
1900:	1431  2B      	        DEC     hl
1901:	1432  5E      	        LD      e,(hl)
1902:	1433  221400  	        LD      (MLPTRI),hl     ; Save new ply list pointer
1903:	1436  ED531600	        LD      (MLPTRJ),de     ; Save next move pointer
1904:	143A  CDE511  	        CALL    UNMOVE          ; Restore board to previous ply
1905:	143D  C9      	        RET                     ; Return
1906:			
1907:			;***********************************************************
1908:			; ONE MOVE BOOK OPENING
1909:			; **********************************************************
1910:			; FUNCTION:   --  To provide an opening book of a single
1911:			;                 move.
1912:			;
1913:			; CALLED BY:  --  FNDMOV
1914:			;
1915:			; CALLS:      --  None
1916:			;
1917:			; ARGUMENTS:  --  None
1918:			;***********************************************************
1919:	143E  F1      	BOOK:   POP     af              ; Abort return to FNDMOV
1920:	143F  215401  	        LD      hl,SCORE+1      ; Zero out score
1921:	1442  3600    	        LD      (hl),0          ; Zero out score table
1922:	1444  213200  	        LD      hl,BMOVES-2     ; Init best move ptr to book
1923:	1447  221A00  	        LD      (BESTM),hl
1924:	144A  211A00  	        LD      hl,BESTM        ; Initialize address of pointer
1925:	144D  3A2000  	        LD      a,(KOLOR)       ; Get computer's color
1926:	1450  A7      	        AND     a,a             ; Is it white ?
1927:	1451  2009    	        JR      NZ,BM5          ; No - jump
1928:	1453  ED5F    	        LD      a,r             ; Load refresh reg (random no)
1929:	1455  CB47    	        BIT     0,a             ; Test random bit
1930:	1457  C8      	        RET     Z               ; Return if zero (P-K4)
1931:	1458  34      	        INC     (hl)            ; P-Q4
1932:	1459  34      	        INC     (hl)
1933:	145A  34      	        INC     (hl)
1934:	145B  C9      	        RET                     ; Return
1935:	145C  34      	BM5:    INC     (hl)            ; Increment to black moves
1936:	145D  34      	        INC     (hl)
1937:	145E  34      	        INC     (hl)
1938:	145F  34      	        INC     (hl)
1939:	1460  34      	        INC     (hl)
1940:	1461  34      	        INC     (hl)
1941:	1462  DD2A1600	        LD      ix,(MLPTRJ)     ; Pointer to opponents 1st move
1942:	1466  DD7E02  	        LD      a,(ix+MLFRP)    ; Get "from" position
1943:	1469  FE16    	        CP      a,22            ; Is it a Queen Knight move ?
1944:	146B  280C    	        JR      Z,BM9           ; Yes - Jump
1945:	146D  FE1B    	        CP      a,27            ; Is it a King Knight move ?
1946:	146F  2808    	        JR      Z,BM9           ; Yes - jump
1947:	1471  FE22    	        CP      a,34            ; Is it a Queen Pawn ?
1948:	1473  2804    	        JR      Z,BM9           ; Yes - jump
1949:	1475  D8      	        RET     C               ; If Queen side Pawn opening -
1950:			                                ; return (P-K4)
1951:	1476  FE23    	        CP      a,35            ; Is it a King Pawn ?
1952:	1478  C8      	        RET     Z               ; Yes - return (P-K4)
1953:	1479  34      	BM9:    INC     (hl)            ; (P-Q4)
1954:	147A  34      	        INC     (hl)
1955:	147B  34      	        INC     (hl)
1956:	147C  C9      	        RET                     ; Return to CPTRMV
1957:			
1958:			;*******************************************************
1959:			; GRAPHICS DATA BASE
1960:			;*******************************************************
1961:			; DESCRIPTION:  The Graphics Data Base contains the
1962:			;               necessary stored data to produce the piece
1963:			;               on the board. Only the center 4 x 4 blocks are
1964:			;               stored and only for a Black Piece on a White
1965:			;               square. A White piece on a black square is
1966:			;               produced by complementing each block, and a
1967:			;               piece on its own color square is produced
1968:			;               by moving in a kernel of 6 blocks.
1969:			;*******************************************************
1970:	0180          	        ORG     START+384
1971:	0200          	BLBASE  EQU     START+512
1972:	FF80          	BLOCK   EQU     $-BLBASE
1973:	0180  80808080	        DB      $80,$80,$80,$80     ; Black Pawn on White square
1974:	0184  80A09080	        DB      $80,$A0,$90,$80
1975:	0188  80AF9F80	        DB      $80,$AF,$9F,$80
1976:	018C  80838380	        DB      $80,$83,$83,$80
1977:	0190  80B0B080	        DB      $80,$B0,$B0,$80   ; Black Knight on White square
1978:	0194  BEBFBF95	        DB      $BE,$BF,$BF,$95
1979:	0198  A0BEBF85	        DB      $A0,$BE,$BF,$85
1980:	019C  83838381	        DB      $83,$83,$83,$81
1981:	01A0  80A00080	        DB      $80,$A0,$00,$80    ; Black Bishop on White square
1982:	01A4  A8BFBD80	        DB      $A8,$BF,$BD,$80
1983:	01A8  82AF8780	        DB      $82,$AF,$87,$80
1984:	01AC  82838380	        DB      $82,$83,$83,$80
1985:	01B0  80808080	        DB      $80,$80,$80,$80     ; Black Rook on White square
1986:	01B4  8ABEBD85	        DB      $8A,$BE,$BD,$85
1987:	01B8  80BFBF80	        DB      $80,$BF,$BF,$80
1988:	01BC  82838381	        DB      $82,$83,$83,$81
1989:	01C0  90808090	        DB      $90,$80,$80,$90     ; Black Queen on White square
1990:	01C4  BFB4BE95	        DB      $BF,$B4,$BE,$95
1991:	01C8  8BBF9F81	        DB      $8B,$BF,$9F,$81
1992:	01CC  83838381	        DB      $83,$83,$83,$81
1993:	01D0  80B89080	        DB      $80,$B8,$90,$80    ; Black King on White square
1994:	01D4  BCBAB894	        DB      $BC,$BA,$B8,$94
1995:	01D8  AFBFBF85	        DB      $AF,$BF,$BF,$85
1996:	01DC  83838381	        DB      $83,$83,$83,$81
1997:	01E0  90B0B080	        DB      $90,$B0,$B0,$80   ; Toppled Black King
1998:	01E4  BFBFB780	        DB      $BF,$BF,$B7,$80
1999:	01E8  9FBFBD80	        DB      $9F,$BF,$BD,$80
2000:	01EC  8080889D	        DB      $80,$80,$88,$9D
2001:	FFF0          	KERNEL  EQU     $-BLBASE
2002:	01F0  BF9FAFBF	        DB      $BF,$9F,$AF,$BF,$9A,$A5 ; Pawn Kernel
	      9AA5
2003:	01F6  89AFBF9F	        DB      $89,$AF,$BF,$9F,$B9,$9F ; Knight Kernel
	      B99F
2004:	01FC  97BE96BD	        DB      $97,$BE,$96,$BD,$9B,$B9 ; Bishop Kernel
	      9BB9
2005:	0202  B5A192BF	        DB      $B5,$A1,$92,$BF,$AA,$95 ; Rook Kernel
	      AA95
2006:	0208  A89BB9B6	        DB      $A8,$9B,$B9,$B6,$AF,$A7 ; Queen Kernel
	      AFA7
2007:	020E  A385A79A	        DB      $A3,$85,$A7,$9A,$BF,$9F ; King Kernel
	      BF9F
2008:	0214  A8BF89A2	        DB      $A8,$BF,$89,$A2,$8F,$86 ; Toppled King Kernel
	      8F86
2009:			        
2010:			        
2011:			        
2012:			        
2013:			;*******************************************************
2014:			; STANDARD MESSAGES
2015:			;*******************************************************
2016:	1800          	        ORG     START+1800H
2017:	1800  57454C43	GRTTNG  .ASCII  "WELCOME TO CHESS! CARE FOR A GAME?"
	      4F4D4520
	      544F2043
	      48455353
	      21204341
	      52452046
	      4F522041
	      2047414D
	      453F
2018:	1822  574F554C	ANAMSG  .ASCII  "WOULD YOU LIKE TO ANALYZE A POSITION?"
	      4420594F
	      55204C49
	      4B452054
	      4F20414E
	      414C595A
	      45204120
	      504F5349
	      54494F4E
	      3F
2019:	1847  444F2059	CLRMSG  .ASCII  "DO YOU WANT TO PLAY WHITE(w) OR BLACK(b)?"
	      4F552057
	      414E5420
	      544F2050
	      4C415920
	      57484954
	      45287729
	      204F5220
	      424C4143
	      4B286229
	      3F
2020:	1870  53415247	TITLE1  .ASCII  "SARGON"
	      4F4E
2021:	1876  504C4159	TITLE2  .ASCII  "PLAYER"
	      4552
2022:	187C  20202020	SPACE   .ASCII  "          "    ; For output of blank area
	      20202020
	      2020
2023:	1886  303120  	MVENUM  .ASCII  "01 "
2024:	1889  2020    	TITLE3  db  "  "
2025:	188B  5B835D  	        db  '[',$83,']'          ; Part of TITLE 3 - Underlines
2026:	188E  5B835D  	        db  '[',$83,']'
2027:	1891  5B835D  	        db  '[',$83,']'
2028:	1894  5B835D  	        db  '[',$83,']'
2029:	1897  5B835D  	        db  '[',$83,']'
2030:	189A  5B835D  	        db  '[',$83,']'
2031:	189D  20      	        db  " "
2032:	189E  5B835D  	        db  '[',$83,']'
2033:	18A1  5B835D  	        db  '[',$83,']'
2034:	18A4  5B835D  	        db  '[',$83,']'
2035:	18A7  5B835D  	        db  '[',$83,']'
2036:	18AA  5B835D  	        db  '[',$83,']'
2037:	18AD  5B835D  	        db  '[',$83,']'
2038:	18B0  20      	        db  " "
2039:	18B1  61312D61	MVEMSG  .ASCII  "a1-a1"
	      31
2040:	18B6  302D3020	O_O     .ASCII  "0-0  "
	      20
2041:	18BB  302D302D	O_O_O   .ASCII  "0-0-0"
	      30
2042:	18C0  43484543	CKMSG   .ASCII  "CHECK"
	      4B
2043:	18C5  4D415445	MTMSG   .ASCII  "MATE IN "
	      20494E20
2044:	18CD  32      	MTPL    .ASCII  "2"
2045:	18CE  4B515242	PCS     .ASCII  "KQRBNP"        ; Valid piece characters
	      4E50
2046:	18D4  594F5520	UWIN    .ASCII  "YOU WIN"
	      57494E
2047:	18DB  49205749	IWIN    .ASCII  "I WIN"
	      4E
2048:	18E0  43415245	AGAIN   .ASCII  "CARE FOR ANOTHER GAME?"
	      20464F52
	      20414E4F
	      54484552
	      2047414D
	      453F
2049:	18F6  49532054	CRTNES  .ASCII  "IS THIS RIGHT?"
	      48495320
	      52494748
	      543F
2050:	1904  53454C45	PLYDEP  .ASCII  "SELECT LOOK AHEAD (1-6)"
	      4354204C
	      4F4F4B20
	      41484541
	      44202831
	      2D3629
2051:	191B  20202020	TITLE4  .ASCII  "                "
	      20202020
	      20202020
	      20202020
2052:	192B  57484F53	WSMOVE  .ASCII  "WHOSE MOVE IS IT?"
	      45204D4F
	      56452049
	      53204954
	      3F
2053:	193C  5B1C5D  	BLANKR  db  '[',$1C,']'              ; Control-\
2054:	193F  50785065	P_PEP   .ASCII  "PxPep"
	      70
2055:	1944  494E5641	INVAL1  .ASCII  "INVALID MOVE"
	      4C494420
	      4D4F5645
2056:	1950  54525920	INVAL2  .ASCII  "TRY AGAIN"
	      41474149
	      4E
2057:			
2058:			;*******************************************************
2059:			; VARIABLES
2060:			;*******************************************************
2061:	1959          	BRDPOS  DS      1               ; Index into the board array
2062:	195A          	ANBDPS  DS      1               ; Additional index required for ANALYS
2063:	195B  0002    	INDXER  DW      BLBASE          ; Index into graphics data base
2064:	195D          	NORMAD  DS      2               ; The address of the upper left hand
2065:			                                ; corner of the square on the board
2066:	195F  00      	LINECT  DB      0               ; Current line number
2067:			
2068:			;*******************************************************
2069:			; MACRO DEFINITIONS
2070:			;*******************************************************
2071:			; All input/output to SARGON is handled in the form of
2072:			; macro calls to simplify conversion to alternate systems.
2073:			; All of the input/output macros conform to the Jove monitor
2074:			; of the Jupiter III computer.
2075:			;*******************************************************
2076:			;*** OUTPUT <CR><LF> ***
2077:			CARRET  macro
2078:			        RST    38h
2079:			        DB     92H,1AH
2080:			        DW     0
2081:			        endm
2082:			
2083:			;*** CLEAR SCREEN ***
2084:			CLRSCR  macro
2085:			        RST    38h
2086:			        DB     0B2H,1AH
2087:			        DW     BLANKR,1
2088:			        endm
2089:			
2090:			;*** PRINT ANY LINE (NAME, LENGTH) ***
2091:			PRTLIN  macro NAME,LNGTH
2092:			        RST    38h
2093:			        DB     0B2H,1AH
2094:			        DW     NAME,LNGTH
2095:			        endm
2096:			
2097:			;*** PRINT ANY BLOCK (NAME, LENGTH) ***
2098:			PRTBLK  macro NAME,LNGTH
2099:			        RST    38h
2100:			        DB     0B3H,1AH
2101:			        DW     NAME,LNGTH
2102:			        endm
2103:			
2104:			;*** EXIT TO MONITOR ***
2105:			EXIT    macro
2106:			        RST    38h
2107:			        DB     01FH
2108:			        endm
2109:			
2110:			;***********************************************************
2111:			; MAIN PROGRAM DRIVER
2112:			;***********************************************************
2113:			; FUNCTION:   --  To coordinate the game moves.
2114:			;
2115:			; CALLED BY:  --  None
2116:			;
2117:			; CALLS:      --  INTERR
2118:			;                 INITBD
2119:			;                 DSPBRD
2120:			;                 CPTRMV
2121:			;                 PLYRMV
2122:			;                 TBCPCL
2123:			;                 PGIFND
2124:			;
2125:			; MACRO CALLS:    CLRSCR
2126:			;                 CARRET
2127:			;                 PRTLIN
2128:			;                 PRTBLK
2129:			;
2130:			; ARGUMENTS:      None
2131:			;***********************************************************
2132:	1A00          	        ORG     START+1A00H     ; Above the move logic
2133:	1A00  31FF02  	DRIVER: LD      SP,STACK        ; Set stack pointer
2134:	1A03' FFB21A3C	        CLRSCR                  ; Blank out screen
	      190100
2135:	1A0A' FFB21A00	        PRTLIN  GRTTNG,34       ; Output greeting
	      182200
2136:	1A11  CD431D  	DRIV01: CALL    CHARTR          ; Accept answer
2137:	1A14' FF921A00	        CARRET                  ; New line
	      00
2138:	1A19  FE59    	        CP      a,59H           ; Is it a 'Y' ?
2139:	1A1B  C2B81D  	        JP      NZ,ANALYS       ; Yes - jump
2140:	1A1E  97      	        SUB     a,a             ; Code of White is zero
2141:	1A1F  322100  	        LD      (COLOR),a       ; White always moves first
2142:	1A22  CDB91A  	        CALL    INTERR          ; Players color/search depth
2143:	1A25  CD000B  	        CALL    INITBD          ; Initialize board array
2144:	1A28  3E01    	        LD      a,1             ; Move number is 1 at at start
2145:	1A2A  322600  	        LD      (MOVENO),a      ; Save
2146:	1A2D  325F19  	        LD      (LINECT),a      ; Line number is one at start
2147:	1A30  218618  	        LD      hl,MVENUM       ; Address of ascii move number
2148:	1A33  3630    	        LD      (hl),30H        ; Init to '01 '
2149:	1A35  23      	        INC     hl
2150:	1A36  3631    	        LD      (hl),31H
2151:	1A38  23      	        INC     hl
2152:	1A39  3620    	        LD      (hl),20H
2153:	1A3B  CDDB1E  	        CALL    DSPBRD          ; Set up graphics board
2154:	1A3E' FFB21A1B	        PRTLIN  TITLE4,15       ; Put up player headings
	      190F00
2155:	1A45' FFB21A89	        PRTLIN  TITLE3,15
	      180F00
2156:	1A4C' FFB31A86	DRIV04: PRTBLK  MVENUM,3        ; Display move number
	      180300
2157:	1A53  3A2000  	        LD      a,(KOLOR)       ; Bring in computer's color
2158:	1A56  A7      	        AND     a,a             ; Is it white ?
2159:	1A57  201C    	        JR      NZ,DR08         ; No - jump
2160:	1A59  CD5D1D  	        CALL    PGIFND          ; New page if needed
2161:	1A5C  FE01    	        CP      a,1             ; Was page turned ?
2162:	1A5E  CC261C  	        CALL    Z,TBCPCL        ; Yes - Tab to computers column
2163:	1A61  CD211B  	        CALL    CPTRMV          ; Make and write computers move
2164:	1A64' FFB31A7C	        PRTBLK  SPACE,1         ; Output a space
	      180100
2165:	1A6B  CD711C  	        CALL    PLYRMV          ; Accept and make players move
2166:	1A6E' FF921A00	        CARRET                  ; New line
	      00
2167:	1A73  181A    	        JR      DR0C            ; Jump
2168:	1A75  CD711C  	DR08:   CALL    PLYRMV          ; Accept and make players move
2169:	1A78' FFB31A7C	        PRTBLK  SPACE,1         ; Output a space
	      180100
2170:	1A7F  CD5D1D  	        CALL    PGIFND          ; New page if needed
2171:	1A82  FE01    	        CP      a,1             ; Was page turned ?
2172:	1A84  CC261C  	        CALL    Z,TBCPCL        ; Yes - Tab to computers column
2173:	1A87  CD211B  	        CALL    CPTRMV          ; Make and write computers move
2174:	1A8A' FF921A00	        CARRET                  ; New line
	      00
2175:	1A8F  218818  	DR0C:   LD      hl,MVENUM+2     ; Addr of 3rd char of move
2176:	1A92  3E20    	        LD      a,20H           ; Ascii space
2177:	1A94  BE      	        CP      a,(hl)          ; Is char a space ?
2178:	1A95  3E3A    	        LD      a,3AH           ; Set up test value
2179:	1A97  2806    	        JR      Z,DR10          ; Yes - jump
2180:	1A99  34      	        INC     (hl)            ; Increment value
2181:	1A9A  BE      	        CP      a,(hl)          ; Over Ascii 9 ?
2182:	1A9B  2015    	        JR      NZ,DR14         ; No - jump
2183:	1A9D  3630    	        LD      (hl),30H        ; Set char to zero
2184:	1A9F  2B      	DR10:   DEC     hl              ; 2nd char of Ascii move no.
2185:	1AA0  34      	        INC     (hl)            ; Increment value
2186:	1AA1  BE      	        CP      a,(hl)          ; Over Ascii 9 ?
2187:	1AA2  200E    	        JR      NZ,DR14         ; No - jump
2188:	1AA4  3630    	        LD      (hl),30H        ; Set char to zero
2189:	1AA6  2B      	        DEC     hl              ; 1st char of Ascii move no.
2190:	1AA7  34      	        INC     (hl)            ; Increment value
2191:	1AA8  BE      	        CP      a,(hl)          ; Over Ascii 9 ?
2192:	1AA9  2007    	        JR      NZ,DR14         ; No - jump
2193:	1AAB  3631    	        LD      (hl),31H        ; Make 1st char a one
2194:	1AAD  3E30    	        LD      a,30H           ; Make 3rd char a zero
2195:	1AAF  328818  	        LD      (MVENUM+2),a
2196:	1AB2  212600  	DR14:   LD      hl,MOVENO       ; Hexadecimal move number
2197:	1AB5  34      	        INC     (hl)            ; Increment
2198:	1AB6  C34C1A  	        JP      DRIV04          ; Jump
2199:			
2200:			;***********************************************************
2201:			; INTERROGATION FOR PLY & COLOR
2202:			;***********************************************************
2203:			; FUNCTION:   --  To query the player for his choice of ply
2204:			;                 depth and color.
2205:			;
2206:			; CALLED BY:  --  DRIVER
2207:			;
2208:			; CALLS:      --  CHARTR
2209:			;
2210:			; MACRO CALLS:    PRTLIN
2211:			;                 CARRET
2212:			;
2213:			; ARGUMENTS:  --  None
2214:			;***********************************************************
2215:	1AB9' FFB21A47	INTERR: PRTLIN  CLRMSG,41       ; Request color choice
	      182900
2216:	1AC0  CD431D  	        CALL    CHARTR          ; Accept response
2217:	1AC3' FF921A00	        CARRET                  ; New line
	      00
2218:	1AC8  FE57    	        CP      a,57H           ; Did player request white ?
2219:	1ACA  281C    	        JR      Z,IN04          ; Yes - branch
2220:	1ACC  97      	        SUB     a,a             ; Set computers color to white
2221:	1ACD  322000  	        LD      (KOLOR),a
2222:	1AD0  217018  	        LD      hl,TITLE1       ; Prepare move list titles
2223:	1AD3  111D19  	        LD      de,TITLE4+2
2224:	1AD6  010600  	        LD      bc,6
2225:	1AD9  EDB0    	        LDIR
2226:	1ADB  217618  	        LD      hl,TITLE2
2227:	1ADE  112419  	        LD      de,TITLE4+9
2228:	1AE1  010600  	        LD      bc,6
2229:	1AE4  EDB0    	        LDIR
2230:	1AE6  181B    	        JR      IN08            ; Jump
2231:	1AE8  3E80    	IN04:   LD      a,80H           ; Set computers color to black
2232:	1AEA  322000  	        LD      (KOLOR),a
2233:	1AED  217618  	        LD      hl,TITLE2       ; Prepare move list titles
2234:	1AF0  111D19  	        LD      de,TITLE4+2
2235:	1AF3  010600  	        LD      bc,6
2236:	1AF6  EDB0    	        LDIR
2237:	1AF8  217018  	        LD      hl,TITLE1
2238:	1AFB  112419  	        LD      de,TITLE4+9
2239:	1AFE  010600  	        LD      bc,6
2240:	1B01  EDB0    	        LDIR
2241:	1B03' FFB21A04	IN08:   PRTLIN  PLYDEP,23       ; Request depth of search
	      191700
2242:	1B0A  CD431D  	        CALL    CHARTR          ; Accept response
2243:	1B0D' FF921A00	        CARRET                  ; New line
	      00
2244:	1B12  212700  	        LD      hl,PLYMAX       ; Address of ply depth variabl
2245:	1B15  3602    	        LD      (hl),2          ; Default depth of search
2246:	1B17  FE31    	        CP      a,31H           ; Under minimum of 1 ?
2247:	1B19  F8      	        RET     M               ; Yes - return
2248:	1B1A  FE37    	        CP      a,37H           ; Over maximum of 6 ?
2249:	1B1C  F0      	        RET     P               ; Yes - return
2250:	1B1D  D630    	        SUB     a,30H           ; Subtract Ascii constant
2251:	1B1F  77      	        LD      (hl),a          ; Set desired depth
2252:	1B20  C9      	        RET                     ; Return
2253:			
2254:			;***********************************************************
2255:			; COMPUTER MOVE ROUTINE
2256:			;***********************************************************
2257:			; FUNCTION:   --  To control the search for the computers move
2258:			;                 and the display of that move on the board
2259:			;                 and in the move list.
2260:			;
2261:			; CALLED BY:  --  DRIVER
2262:			;
2263:			; CALLS:      --  FNDMOV
2264:			;                 FCDMAT
2265:			;                 MOVE
2266:			;                 EXECMV
2267:			;                 BITASN
2268:			;                 INCHK
2269:			;
2270:			; MACRO CALLS:    PRTBLK
2271:			;                 CARRET
2272:			;
2273:			; ARGUMENTS:  --  None
2274:			;***********************************************************
2275:	1B21  CDB812  	CPTRMV: CALL    FNDMOV          ; Select best move
2276:	1B24  2A1A00  	        LD      hl,(BESTM)      ; Move list pointer variable
2277:	1B27  221600  	        LD      (MLPTRJ),hl     ; Pointer to move data
2278:	1B2A  3A5401  	        LD      a,(SCORE+1)     ; To check for mates
2279:	1B2D  FE01    	        CP      a,1             ; Mate against computer ?
2280:	1B2F  2005    	        JR      NZ,CP0C         ; No - jump
2281:	1B31  0E01    	        LD      c,1             ; Computer mate flag
2282:	1B33  CDAF1B  	        CALL    FCDMAT          ; Full checkmate ?
2283:	1B36  CD7311  	CP0C:   CALL    MOVE            ; Produce move on board array
2284:	1B39  CD5E20  	        CALL    EXECMV          ; Make move on graphics board
2285:			                                ; and return info about it
2286:	1B3C  78      	        LD      a,b             ; Special move flags
2287:	1B3D  A7      	        AND     a,a             ; Special ?
2288:	1B3E  2017    	        JR      NZ,CP10         ; Yes - jump
2289:	1B40  53      	        LD      d,e             ; "To" position of the move
2290:	1B41  CD621C  	        CALL    BITASN          ; Convert to Ascii
2291:	1B44  22B418  	        LD      (MVEMSG+3),hl   ; Put in move message
2292:	1B47  51      	        LD      d,c             ; "From" position of the move
2293:	1B48  CD621C  	        CALL    BITASN          ; Convert to Ascii
2294:	1B4B  22B118  	        LD      (MVEMSG),hl     ; Put in move message
2295:	1B4E' FFB31AB1	        PRTBLK  MVEMSG,5        ; Output text of move
	      180500
2296:	1B55  1821    	        JR      CP1C            ; Jump
2297:	1B57  CB48    	CP10:   BIT     1,b             ; King side castle ?
2298:	1B59  2809    	        JR      Z,rel020        ; No - jump
2299:	1B5B' FFB31AB6	        PRTBLK  O_O,5           ; Output "O-O"
	      180500
2300:	1B62  1814    	        JR      CP1C            ; Jump
2301:	1B64  CB50    	rel020: BIT     2,b             ; Queen side castle ?
2302:	1B66  2809    	        JR      Z,rel021        ; No - jump
2303:	1B68' FFB31ABB	        PRTBLK  O_O_O,5         ; Output "O-O-O"
	      180500
2304:	1B6F  1807    	        JR      CP1C            ; Jump
2305:	1B71' FFB31A3F	rel021: PRTBLK  P_PEP,5         ; Output "PxPep" - En passant
	      190500
2306:	1B78  3A2100  	CP1C:   LD      a,(COLOR)       ; Should computer call check ?
2307:	1B7B  47      	        LD      b,a
2308:	1B7C  EE80    	        XOR     a,80H           ; Toggle color
2309:	1B7E  322100  	        LD      (COLOR),a
2310:	1B81  CD980D  	        CALL    INCHK           ; Check for check
2311:	1B84  A7      	        AND     a,a             ; Is enemy in check ?
2312:	1B85  78      	        LD      a,b             ; Restore color
2313:	1B86  322100  	        LD      (COLOR),a
2314:	1B89  2818    	        JR      Z,CP24          ; No - return
2315:	1B8B' FF921A00	        CARRET                  ; New line
	      00
2316:	1B90  3A5401  	        LD      a,(SCORE+1)     ; Check for player mated
2317:	1B93  FEFF    	        CP      a,0FFH          ; Forced mate ?
2318:	1B95  C44E1C  	        CALL    NZ,TBCPMV       ; No - Tab to computer column
2319:	1B98' FFB31AC0	        PRTBLK  CKMSG,5         ; Output "check"
	      180500
2320:	1B9F  215F19  	        LD      hl,LINECT       ; Address of screen line count
2321:	1BA2  34      	        INC     (hl)            ; Increment for message
2322:	1BA3  3A5401  	CP24:   LD      a,(SCORE+1)     ; Check again for mates
2323:	1BA6  FEFF    	        CP      a,0FFH          ; Player mated ?
2324:	1BA8  C0      	        RET     NZ              ; No - return
2325:	1BA9  0E00    	        LD      c,0             ; Set player mate flag
2326:	1BAB  CDAF1B  	        CALL    FCDMAT          ; Full checkmate ?
2327:	1BAE  C9      	        RET                     ; Return
2328:			
2329:			;***********************************************************
2330:			; FORCED MATE HANDLING
2331:			;***********************************************************
2332:			; FUNCTION:   --  To examine situations where there exits
2333:			;                 a forced mate and determine whether or
2334:			;                 not the current move is checkmate. If it is,
2335:			;                 a losing player is offered another game,
2336:			;                 while a loss for the computer signals the
2337:			;                 King to tip over in resignation.
2338:			;
2339:			; CALLED BY:  --  CPTRMV
2340:			;
2341:			; CALLS:      --  MATED
2342:			;                 CHARTR
2343:			;                 TBPLMV
2344:			;
2345:			; ARGUMENTS:  --  The only value passed in a register is the
2346:			;                 flag which tells FCDMAT whether the computer
2347:			;                 or the player is mated.
2348:			;***********************************************************
2349:	1BAF  3A2600  	FCDMAT: LD      a,(MOVENO)      ; Current move number
2350:	1BB2  47      	        LD      b,a             ; Save
2351:	1BB3  3A2500  	        LD      a,(PMATE)       ; Move number where mate occurs
2352:	1BB6  90      	        SUB     a,b             ; Number of moves till mate
2353:	1BB7  A7      	        AND     a,a             ; Checkmate ?
2354:	1BB8  2040    	        JR      NZ,FM0C         ; No - jump
2355:	1BBA  CB41    	        BIT     0,c             ; Check flag for who is mated
2356:	1BBC  2818    	        JR      Z,FM04          ; Jump if player
2357:	1BBE' FF921A00	        CARRET                  ; New line
	      00
2358:	1BC3' FFB21AC0	        PRTLIN  CKMSG,9         ; Print "CHECKMATE"
	      180900
2359:	1BCA  CD7C1D  	        CALL    MATED           ; Tip over King
2360:	1BCD' FFB21AD4	        PRTLIN  UWIN,7          ; Output "YOU WIN"
	      180700
2361:	1BD4  180E    	        JR      FM08            ; Jump
2362:	1BD6' FFB21AC5	FM04:   PRTLIN  MTMSG,4         ; Output "MATE"
	      180400
2363:	1BDD' FFB21ADB	        PRTLIN  IWIN,5          ; Output "I WIN"
	      180500
2364:	1BE4  E1      	FM08:   POP     hl              ; Remove return addresses
2365:	1BE5  E1      	        POP     hl
2366:	1BE6  CD431D  	        CALL    CHARTR          ; Input any char to play again
2367:	1BE9' FFB21A3C	FM09:   CLRSCR                  ; Blank screen
	      190100
2368:	1BF0' FFB21AE0	        PRTLIN  AGAIN,22        ; "CARE FOR ANOTHER GAME?"
	      181600
2369:	1BF7  C3111A  	        JP      DRIV01          ; Jump (Rest of game init)
2370:	1BFA  CB41    	FM0C:   BIT     0,c             ; Who has forced mate ?
2371:	1BFC  C0      	        RET     NZ              ; Return if player
2372:	B0FF  1A041917	        CARRET                  ; New line
	      00CD431D
	      FF921A00
	      00212700
	      3602FE31
	      F8FE37F0
	      D63077C9
	      CDB8122A
	      1A002216
	      003A5401
	      FE012005
	      0E01CDAF
	      1BCD7311
	      CD5E2078
	      A7201753
	      CD621C22
	      B41851CD
	      621C22B1
	      18FFB31A
	      B1180500
	      1821CB48
	      2809FFB3
	      1AB61805
	      001814CB
	      502809FF
	      B31ABB18
	      05001807
	      FFB31A3F
	      1905003A
	      210047EE
	      80322100
	      CD980DA7
	      78322100
	      2818FF92
	      1A00003A
	      5401FEFF
	      C44E1CFF
	      B31AC018
	      0500215F
	      19343A54
	      01FEFFC0
	      0E00CDAF
	      1BC93A26
	      00473A25
	      0090
	40CB  2818FF92
	      1A0000FF
	      B21AC018
	      0900CD7C
	      1DFFB21A
	      D4180700
	      180EFFB2
	      1AC51804
	      00FFB21A
	      DB180500
	      E1E1CD43
	      1DFFB21A
	      3C190100
	      FFB21AE0
	      181600C3
	      111ACB41
	      C0
	1A00: 1B
	0001  00000000
	      C63032CD
	      18FFB21A
	      C5180900
	      CD3A1CC9
	      FFB31A86
	      1803003A
2373:	1C02  C630    	        ADD     a,30H           ; Number of moves to Ascii
2374:	1C04  32CD18  	        LD      (MTPL),a        ; Place value in message
2375:	1C07' FFB21AC5	        PRTLIN  MTMSG,9         ; Output "MATE IN x MOVES"
	      180900
2376:	1C0E  CD3A1C  	        CALL    TBPLMV          ; Tab to players column
2377:	1C11  C9      	        RET                     ; Return
2378:			
2379:			;***********************************************************
2380:			; TAB TO PLAYERS COLUMN
2381:			;***********************************************************
2382:			; FUNCTION:   --  To space over in the move listing to the
2383:			;                 column in which the players moves are being
2384:			;                 recorded. This routine also reprints the
2385:			;                 move number.
2386:			;
2387:			; CALLED BY:  --  PLYRMV
2388:			;
2389:			; CALLS:      --  None
2390:			;
2391:			; MACRO CALLS:    PRTBLK
2392:			;
2393:			; ARGUMENTS:  --  None
2394:			;***********************************************************
2395:	1C12' FFB31A86	TBPLCL: PRTBLK  MVENUM,3        ; Reproduce move number
	      180300
2396:	1C19  3A2000  	        LD      a,(KOLOR)       ; Computers color
2397:	1C1C  A7      	        AND     a,a             ; Is computer white ?
2398:	1C1D  C0      	        RET     NZ              ; No - return
2399:	1C1E' FFB31A7C	        PRTBLK  SPACE,6         ; Tab to next column
	      180600
2400:	1C25  C9      	        RET                     ; Return
2401:			
2402:			;***********************************************************
2403:			; TAB TO COMPUTERS COLUMN
2404:			;***********************************************************
2405:			; FUNCTION:   --  To space over in the move listing to the
2406:			;                 column in which the computers moves are
2407:			;                 being recorded. This routine also reprints
2408:			;                 the move number.
2409:			;
2410:			; CALLED BY:  --  DRIVER
2411:			;                 CPTRMV
2412:			;
2413:			; CALLS:      --  None
2414:			;
2415:			; MACRO CALLS:    PRTBLK
2416:			;
2417:			; ARGUMENTS:  --  None
2418:			;***********************************************************
2419:	1C26' FFB31A86	TBCPCL: PRTBLK  MVENUM,3        ; Reproduce move number
	      180300
2420:	1C2D  3A2000  	        LD      a,(KOLOR)       ; Computer's color
2421:	1C30  A7      	        AND     a,a             ; Is computer white ?
2422:	1C31  C8      	        RET     Z               ; Yes - return
2423:	1C32' FFB31A7C	        PRTBLK  SPACE,6         ; Tab to next column
	      180600
2424:	1C39  C9      	        RET                     ; Return
2425:			
2426:			;***********************************************************
2427:			; TAB TO PLAYERS COLUMN W/0 MOVE NO.
2428:			;***********************************************************
2429:			; FUNCTION:   --  Like TBPLCL, except that the move number
2430:			;                 is not reprinted.
2431:			;
2432:			; CALLED BY:  --  FCDMAT
2433:			;***********************************************************
2434:	1C3A' FFB31A7C	TBPLMV: PRTBLK  SPACE,3
	      180300
2435:	1C41  3A2000  	        LD      a,(KOLOR)
2436:	1C44  A7      	        AND     a,a
2437:	1C45  C0      	        RET     NZ
2438:	1C46' FFB31A7C	        PRTBLK  SPACE,6
	      180600
2439:	1C4D  C9      	        RET
2440:			
2441:			;***********************************************************
2442:			; TAB TO COMPUTERS COLUMN W/O MOVE NO.
2443:			;***********************************************************
2444:			; FUNCTION:   --  Like TBCPCL, except that the move number
2445:			;                 is not reprinted.
2446:			;
2447:			; CALLED BY:  --  CPTRMV
2448:			;***********************************************************
2449:	1C4E' FFB31A7C	TBCPMV: PRTBLK  SPACE,3
	      180300
2450:	1C55  3A2000  	        LD      a,(KOLOR)
2451:	1C58  A7      	        AND     a,a
2452:	1C59  C8      	        RET     Z
2453:	1C5A' FFB31A7C	        PRTBLK  SPACE,6
	      180600
2454:	1C61  C9      	        RET
2455:			
2456:			;***********************************************************
2457:			; BOARD INDEX TO ASCII SQUARE NAME
2458:			;***********************************************************
2459:			; FUNCTION:   --  To translate a hexadecimal index in the
2460:			;                 board array into an ascii description
2461:			;                 of the square in algebraic chess notation.
2462:			;
2463:			; CALLED BY:  --  CPTRMV
2464:			;
2465:			; CALLS:      --  DIVIDE
2466:			;
2467:			; ARGUMENTS:  --  Board index input in register D and the
2468:			;                 Ascii square name is output in register
2469:			;                 pair HL.
2470:			;***********************************************************
2471:	1C62  97      	BITASN: SUB     a,a             ; Get ready for division
2472:	1C63  1E0A    	        LD      e,10
2473:	1C65  CD0420  	        CALL    DIVIDE          ; Divide
2474:	1C68  15      	        DEC     d               ; Get rank on 1-8 basis
2475:	1C69  C660    	        ADD     a,60H           ; Convert file to Ascii (a-h)
2476:	1C6B  6F      	        LD      l,a             ; Save
2477:	1C6C  7A      	        LD      a,d             ; Rank
2478:	1C6D  C630    	        ADD     a,30H           ; Convert rank to Ascii (1-8)
2479:	1C6F  67      	        LD      h,a             ; Save
2480:	1C70  C9      	        RET                     ; Return
2481:			
2482:			;***********************************************************
2483:			; PLAYERS MOVE ANALYSIS
2484:			;***********************************************************
2485:			; FUNCTION:   --  To accept and validate the players move
2486:			;                 and produce it on the graphics board. Also
2487:			;                 allows player to resign the game by
2488:			;                 entering a control-R.
2489:			;
2490:			; CALLED BY:  --  DRIVER
2491:			;
2492:			; CALLS:      --  CHARTR
2493:			;                 ASNTBI
2494:			;                 VALMOV
2495:			;                 EXECMV
2496:			;                 PGIFND
2497:			;                 TBPLCL
2498:			;
2499:			; ARGUMENTS:  --  None
2500:			;***********************************************************
2501:	1C71  CD431D  	PLYRMV: CALL    CHARTR          ; Accept "from" file letter
2502:	1C74  FE12    	        CP      a,12H           ; Is it instead a Control-R ?
2503:	1C76  CAE91B  	        JP      Z,FM09          ; Yes - jump
2504:	1C79  67      	        LD      h,a             ; Save
2505:	1C7A  CD431D  	        CALL    CHARTR          ; Accept "from" rank number
2506:	1C7D  6F      	        LD      l,a             ; Save
2507:	1C7E  CDC71C  	        CALL    ASNTBI          ; Convert to a board index
2508:	1C81  90      	        SUB     a,b             ; Gives board index, if valid
2509:	1C82  2822    	        JR      Z,PL08          ; Jump if invalid
2510:	1C84  32B118  	        LD      (MVEMSG),a      ; Move list "from" position
2511:	1C87  CD431D  	        CALL    CHARTR          ; Accept separator & ignore it
2512:	1C8A  CD431D  	        CALL    CHARTR          ; Repeat for "to" position
2513:	1C8D  67      	        LD      h,a
2514:	1C8E  CD431D  	        CALL    CHARTR
2515:	1C91  6F      	        LD      l,a
2516:	1C92  CDC71C  	        CALL    ASNTBI
2517:	1C95  90      	        SUB     a,b
2518:	1C96  280E    	        JR      Z,PL08
2519:	1C98  32B218  	        LD      (MVEMSG+1),a    ; Move list "to" position
2520:	1C9B  CDEC1C  	        CALL    VALMOV          ; Determines if a legal move
2521:	1C9E  A7      	        AND     a,a             ; Legal ?
2522:	1C9F  C2A61C  	        JP      NZ,PL08         ; No - jump
2523:	1CA2  CD5E20  	        CALL    EXECMV          ; Make move on graphics board
2524:	1CA5  C9      	        RET                     ; Return
2525:	1CA6  215F19  	PL08:   LD      hl,LINECT       ; Address of screen line count
2526:	1CA9  34      	        INC     (hl)            ; Increase by 2 for message
2527:	1CAA  34      	        INC     (hl)
2528:	1CAB' FF921A00	        CARRET                  ; New line
	      00
2529:	1CB0  CD5D1D  	        CALL    PGIFND          ; New page if needed
2530:	1CB3' FFB21A44	        PRTLIN  INVAL1,12       ; Output "INVALID MOVE"
	      190C00
2531:	1CBA' FFB21A50	        PRTLIN  INVAL2,9        ; Output "TRY AGAIN"
	      190900
2532:	1CC1  CD121C  	        CALL    TBPLCL          ; Tab to players column
2533:	1CC4  C3711C  	        JP      PLYRMV          ; Jump
2534:			
2535:			;***********************************************************
2536:			; ASCII SQUARE NAME TO BOARD INDEX
2537:			;***********************************************************
2538:			; FUNCTION:   --  To convert an algebraic square name in
2539:			;                 Ascii to a hexadecimal board index.
2540:			;                 This routine also checks the input for
2541:			;                 validity.
2542:			;
2543:			; CALLED BY:  --  PLYRMV
2544:			;
2545:			; CALLS:      --  MLTPLY
2546:			;
2547:			; ARGUMENTS:  --  Accepts the square name in register pair HL
2548:			;                 and outputs the board index in register A.
2549:			;                 Register B = 0 if ok. Register B = Register
2550:			;                 A if invalid.
2551:			;***********************************************************
2552:	1CC7  7D      	ASNTBI: LD      a,l             ; Ascii rank (1 - 8)
2553:	1CC8  D630    	        SUB     a,30H           ; Rank 1 - 8
2554:	1CCA  FE01    	        CP      a,1             ; Check lower bound
2555:	1CCC  FAEA1C  	        JP      M,AT04          ; Jump if invalid
2556:	1CCF  FE09    	        CP      a,9             ; Check upper bound
2557:	1CD1  3017    	        JR      NC,AT04         ; Jump if invalid
2558:	1CD3  3C      	        INC     a               ; Rank 2 - 9
2559:	1CD4  57      	        LD      d,a             ; Ready for multiplication
2560:	1CD5  1E0A    	        LD      e,10
2561:	1CD7  CD1620  	        CALL    MLTPLY          ; Multiply
2562:	1CDA  7C      	        LD      a,h             ; Ascii file letter (a - h)
2563:	1CDB  D640    	        SUB     a,40H           ; File 1 - 8
2564:	1CDD  FE01    	        CP      a,1             ; Check lower bound
2565:	1CDF  FAEA1C  	        JP      M,AT04          ; Jump if invalid
2566:	1CE2  FE09    	        CP      a,9             ; Check upper bound
2567:	1CE4  3004    	        JR      NC,AT04         ; Jump if invalid
2568:	1CE6  82      	        ADD     a,d             ; File+Rank(20-90)=Board index
2569:	1CE7  0600    	        LD      b,0             ; Ok flag
2570:	1CE9  C9      	        RET                     ; Return
2571:	1CEA  47      	AT04:   LD      b,a             ; Invalid flag
2572:	1CEB  C9      	        RET                     ; Return
2573:			
2574:			;***********************************************************
2575:			; VALIDATE MOVE SUBROUTINE
2576:			;***********************************************************
2577:			; FUNCTION:   --  To check a players move for validity.
2578:			;
2579:			; CALLED BY:  --  PLYRMV
2580:			;
2581:			; CALLS:      --  GENMOV
2582:			;                 MOVE
2583:			;                 INCHK
2584:			;                 UNMOVE
2585:			;
2586:			; ARGUMENTS:  --  Returns flag in register A, 0 for valid
2587:			;                 and 1 for invalid move.
2588:			;***********************************************************
2589:	1CEC  2A1600  	VALMOV: LD      hl,(MLPTRJ)     ; Save last move pointer
2590:	1CEF  E5      	        PUSH    hl              ; Save register
2591:	1CF0  3A2000  	        LD      a,(KOLOR)       ; Computers color
2592:	1CF3  EE80    	        XOR     a,80H           ; Toggle color
2593:	1CF5  322100  	        LD      (COLOR),a       ; Store
2594:	1CF8  215D01  	        LD      hl,PLYIX-2      ; Load move list index
2595:	1CFB  221400  	        LD      (MLPTRI),hl
2596:	1CFE  210007  	        LD      hl,MLIST+1024   ; Next available list pointer
2597:	1D01  221E00  	        LD      (MLNXT),hl
2598:	1D04  CD560D  	        CALL    GENMOV          ; Generate opponents moves
2599:	1D07  DD210007	        LD      ix,MLIST+1024   ; Index to start of moves
2600:	1D0B  3AB118  	VA5:    LD      a,(MVEMSG)      ; "From" position
2601:	1D0E  DDBE02  	        CP      a,(ix+MLFRP)    ; Is it in list ?
2602:	1D11  2008    	        JR      NZ,VA6          ; No - jump
2603:	1D13  3AB218  	        LD      a,(MVEMSG+1)    ; "To" position
2604:	1D16  DDBE03  	        CP      a,(ix+MLTOP)    ; Is it in list ?
2605:	1D19  280F    	        JR      Z,VA7           ; Yes - jump
2606:	1D1B  DD5E00  	VA6:    LD      e,(ix+MLPTR)    ; Pointer to next list move
2607:	1D1E  DD5601  	        LD      d,(ix+MLPTR+1)
2608:	1D21  AF      	        XOR     a,a             ; At end of list ?
2609:	1D22  BA      	        CP      a,d
2610:	1D23  2817    	        JR      Z,VA10          ; Yes - jump
2611:	1D25  D5      	        PUSH    de              ; Move to X register
2612:	1D26  DDE1    	        POP     ix
2613:	1D28  18E1    	        JR      VA5             ; Jump
2614:	1D2A  DD221600	VA7:    LD      (MLPTRJ),ix     ; Save opponents move pointer
2615:	1D2E  CD7311  	        CALL    MOVE            ; Make move on board array
2616:	1D31  CD980D  	        CALL    INCHK           ; Was it a legal move ?
2617:	1D34  A7      	        AND     a,a
2618:	1D35  2002    	        JR      NZ,VA9          ; No - jump
2619:	1D37  E1      	VA8:    POP     hl              ; Restore saved register
2620:	1D38  C9      	        RET                     ; Return
2621:	1D39  CDE511  	VA9:    CALL    UNMOVE          ; Un-do move on board array
2622:	1D3C  3E01    	VA10:   LD      a,1             ; Set flag for invalid move
2623:	1D3E  E1      	        POP     hl              ; Restore saved register
2624:	1D3F  221600  	        LD      (MLPTRJ),hl     ; Save move pointer
2625:	1D42  C9      	        RET                     ; Return
2626:			
2627:			;***********************************************************
2628:			; ACCEPT INPUT CHARACTER
2629:			;***********************************************************
2630:			; FUNCTION:   --  Accepts a single character input from the
2631:			;                 console keyboard and places it in the A
2632:			;                 register. The character is also echoed on
2633:			;                 the video screen, unless it is a carriage
2634:			;                 return, line feed, or backspace.
2635:			;                 Lower case alphabetic characters are folded
2636:			;                 to upper case.
2637:			;
2638:			; CALLED BY:  --  DRIVER
2639:			;                 INTERR
2640:			;                 PLYRMV
2641:			;                 ANALYS
2642:			;
2643:			; CALLS:      --  None
2644:			;
2645:			; ARGUMENTS:  --  Character input is output in register A.
2646:			;
2647:			; NOTES:      --  This routine contains a reference to a
2648:			;                 monitor function of the Jove monitor, there-
2649:			;                 for the first few lines of this routine are
2650:			;                 system dependent.
2651:			;***********************************************************
2652:	1D43  FF      	CHARTR: RST     38h             ; Jove monitor single char inpt
2653:	1D44  8100    	        DB      81H,0
2654:	1D46  FE0D    	        CP      a,0DH           ; Carriage return ?
2655:	1D48  C8      	        RET     Z               ; Yes - return
2656:	1D49  FE0A    	        CP      a,0AH           ; Line feed ?
2657:	1D4B  C8      	        RET     Z               ; Yes - return
2658:	1D4C  FE08    	        CP      a,08H           ; Backspace ?
2659:	1D4E  C8      	        RET     Z               ; Yes - return
2660:	1D4F  FF      	        RST     38h             ; Jove monitor single char echo
2661:	1D50  811A    	        DB      81H,1AH
2662:	1D52  E67F    	        AND     a,7FH           ; Mask off parity bit
2663:	1D54  FE7B    	        CP      a,7BH           ; Upper range check (z+l)
2664:	1D56  F0      	        RET     P               ; No need to fold - return
2665:	1D57  FE61    	        CP      a,61H           ; Lower-range check (a)
2666:	1D59  F8      	        RET     M               ; No need to fold - return
2667:	1D5A  D620    	        SUB     a,20H           ; Change to one of A-Z
2668:	1D5C  C9      	        RET                     ; Return
2669:			
2670:			;***********************************************************
2671:			; NEW PAGE IF NEEDED
2672:			;***********************************************************
2673:			; FUNCTION:   --  To clear move list output when the column
2674:			;                 has been filled.
2675:			;
2676:			; CALLED BY:  --  DRIVER
2677:			;                 PLYRMV
2678:			;                 CPTRMV
2679:			;
2680:			; CALLS:     --   DSPBRD
2681:			;
2682:			; ARGUMENTS: --   Returns a 1 in the A register if a new
2683:			;                 page was turned.
2684:			;***********************************************************
2685:	1D5D  215F19  	PGIFND: LD      hl,LINECT       ; Addr of page position counter
2686:	1D60  34      	        INC     (hl)            ; Increment
2687:	1D61  3E1B    	        LD      a,1BH           ; Page bottom ?
2688:	1D63  BE      	        CP      a,(hl)
2689:	1D64  D0      	        RET     NC              ; No - return
2690:	1D65  CDDB1E  	        CALL    DSPBRD          ; Put up new page
2691:	1D68' FFB21A1B	        PRTLIN  TITLE4,15       ; Re-print titles
	      190F00
2692:	1D6F' FFB21A89	        PRTLIN  TITLE3,15
	      180F00
2693:	1D76  3E01    	        LD      a,1             ; Set line count back to 1
2694:	1D78  325F19  	        LD      (LINECT),a
2695:	1D7B  C9      	        RET                     ; Return
2696:			
2697:			;***********************************************************
2698:			; DISPLAY MATED KING
2699:			;***********************************************************
2700:			; FUNCTION:   --  To tip over the computers King when
2701:			;                 mated.
2702:			;
2703:			; CALLED BY:  --  FCDMAT
2704:			;
2705:			; CALLS:      --  CONVRT
2706:			;                 BLNKER
2707:			;                 INSPCE  (Abnormal Call to IP04)
2708:			;
2709:			; ARGUMENTS:  --  None
2710:			;***********************************************************
2711:	1D7C  3A2000  	MATED:  LD      a,(KOLOR)       ; Computers color
2712:	1D7F  A7      	        AND     a,a             ; Is computer white ?
2713:	1D80  2807    	        JR      Z,rel23         ; Yes - skip
2714:	1D82  0E02    	        LD      c,2             ; Set black piece flag
2715:	1D84  3A4F01  	        LD      a,(POSK+1)      ; Position of black King
2716:	1D87  1804    	        JR      MA08            ; Jump
2717:	1D89  4F      	rel23:  LD      c,a             ; Clear black piece flag
2718:	1D8A  3A4E01  	        LD      a,(POSK)        ; Position of white King
2719:	1D8D  325919  	MA08:   LD      (BRDPOS),a      ; Store King position
2720:	1D90  325A19  	        LD      (ANBDPS),a      ; Again
2721:	1D93  CDE01F  	        CALL    CONVRT          ; Getting norm address in HL
2722:	1D96  3E07    	        LD      a,7             ; Piece value of toppled King
2723:	1D98  060A    	        LD      b,10            ; Blink parameter
2724:	1D9A  CD2720  	        CALL    BLNKER          ; Blink King position
2725:	1D9D  FD21AC1D	        LD      iy,MA0C         ; Prepare for abnormal call
2726:	1DA1  FDE5    	        PUSH    iy
2727:	1DA3  E5      	        PUSH    hl
2728:	1DA4  C5      	        PUSH    bc
2729:	1DA5  D5      	        PUSH    de
2730:	1DA6  DDE5    	        PUSH    ix
2731:	1DA8  F5      	        PUSH    af
2732:	1DA9  C3691F  	        JP      IP04            ; Call INSPCE
2733:	1DAC  060A    	MA0C:   LD      b,10            ; Blink again
2734:	1DAE  3A5A19  	        LD      a,(ANBDPS)
2735:	1DB1  325919  	        LD      (BRDPOS),a
2736:	1DB4  CD2720  	        CALL    BLNKER
2737:	1DB7  C9      	        RET                     ; Return
2738:			
2739:			;***********************************************************
2740:			; SET UP POSITION FOR ANALYSIS
2741:			;***********************************************************
2742:			; FUNCTION:   --  To enable user to set up any position
2743:			;                 for analysis, or to continue to play
2744:			;                 the game. The routine blinks the board
2745:			;                 squares in turn and the user has the option
2746:			;                 of leaving the contents unchanged by a
2747:			;                 carriage return, emptying the square by a 0,
2748:			;                 or inputting a piece of his chosing. To
2749:			;                 enter a piece, type in piece-code,color-code,
2750:			;                 moved-code.
2751:			;
2752:			;                 Piece-code is a letter indicating the
2753:			;                 desired piece:
2754:			;                       K  -  King
2755:			;                       Q  -  Queen
2756:			;                       R  -  Rook
2757:			;                       B  -  Bishop
2758:			;                       N  -  Knight
2759:			;                       P  -  Pawn
2760:			;
2761:			;                 Color code is a letter, W for white, or B for
2762:			;                 black.
2763:			;
2764:			;                 Moved-code is a number. 0 indicates the piece has never
2765:			;                 moved. 1 indicates the piece has moved.
2766:			;
2767:			;                 A backspace will back up in the sequence of blinked
2768:			;                 squares. An Escape will terminate the blink cycle and
2769:			;                 verify that the position is correct, then procede
2770:			;                 with game initialization.
2771:			;
2772:			; CALLED BY:  --  DRIVER
2773:			;
2774:			; CALLS:      --  CHARTR
2775:			;                 DPSBRD
2776:			;                 BLNKER
2777:			;                 ROYALT
2778:			;                 PLYRMV
2779:			;                 CPTRMV
2780:			;
2781:			; MACRO CALLS:    PRTLIN
2782:			;                 EXIT
2783:			;                 CLRSCR
2784:			;                 PRTBLK
2785:			;                 CARRET
2786:			;
2787:			; ARGUMENTS:  --  None
2788:			;***********************************************************
2789:	1DB8' FFB21A22	ANALYS: PRTLIN  ANAMSG,37       ; "CARE TO ANALYSE A POSITION?"
	      182500
2790:	1DBF  CD431D  	        CALL    CHARTR          ; Accept answer
2791:	1DC2' FF921A00	        CARRET                  ; New line
	      00
2792:	1DC7  FE4E    	        CP      a,4EH           ; Is answer a "N" ?
2793:	1DC9  2002    	        JR      NZ,AN04         ; No - jump
2794:	1DCB' FF1F    	        EXIT                    ; Return to monitor
2795:	1DCD  CDDB1E  	AN04:   CALL    DSPBRD          ; Current board position
2796:	1DD0  3E15    	        LD      a,21            ; First board index
2797:	1DD2  325A19  	AN08:   LD      (ANBDPS),a      ; Save
2798:	1DD5  325919  	        LD      (BRDPOS),a
2799:	1DD8  CDE01F  	        CALL    CONVRT          ; Norm address into HL register
2800:	1DDB  320000  	        LD      (M1),a          ; Set up board index
2801:	1DDE  DD2A0000	        LD      ix,(M1)
2802:	1DE2  DD7EB4  	        LD      a,(ix+BOARD)    ; Get board contents
2803:	1DE5  FEFF    	        CP      a,0FFH          ; Border square ?
2804:	1DE7  283C    	        JR      Z,AN19          ; Yes - jump
2805:	1DE9  0604    	        LD      b,4H            ; Ready to blink square
2806:	1DEB  CD2720  	        CALL    BLNKER          ; Blink
2807:	1DEE  CD431D  	        CALL    CHARTR          ; Accept input
2808:	1DF1  FE1B    	        CP      a,1BH           ; Is it an escape ?
2809:	1DF3  2849    	        JR      Z,AN1B          ; Yes - jump
2810:	1DF5  FE08    	        CP      a,08H           ; Is it a backspace ?
2811:	1DF7  2836    	        JR      Z,AN1A          ; Yes - jump
2812:	1DF9  FE0D    	        CP      a,0DH           ; Is it a carriage return ?
2813:	1DFB  2828    	        JR      Z,AN19          ; Yes - jump
2814:	1DFD  010700  	        LD      bc,7            ; Number of types of pieces + 1
2815:	1E00  21CE18  	        LD      hl,PCS          ; Address of piece symbol table
2816:	1E03  EDB1    	        CPIR                    ; Search
2817:	1E05  2018    	        JR      NZ,AN18         ; Jump if not found
2818:	1E07  CD431D  	        CALL    CHARTR          ; Accept and ignore separator
2819:	1E0A  CD431D  	        CALL    CHARTR          ; Color of piece
2820:	1E0D  FE42    	        CP      a,42H           ; Is it black ?
2821:	1E0F  2002    	        JR      NZ,rel022       ; No - skip
2822:	1E11  CBF9    	        SET     7,c             ; Black piece indicator
2823:	1E13  CD431D  	rel022: CALL    CHARTR          ; Accept and ignore separator
2824:	1E16  CD431D  	        CALL    CHARTR          ; Moved flag
2825:	1E19  FE31    	        CP      a,31H           ; Has piece moved ?
2826:	1E1B  2002    	        JR      NZ,AN18         ; No - jump
2827:	1E1D  CBD9    	        SET     3,c             ; Set moved indicator
2828:	1E1F  DD71B4  	AN18:   LD      (ix+BOARD),c    ; Insert piece into board array
2829:	1E22  CDDB1E  	        CALL    DSPBRD          ; Update graphics board
2830:	1E25  3A5A19  	AN19:   LD      a,(ANBDPS)      ; Current board position
2831:	1E28  3C      	        INC     a               ; Next
2832:	1E29  FE63    	        CP      a,99            ; Done ?
2833:	1E2B  20A5    	        JR      NZ,AN08         ; No - jump
2834:	1E2D  189E    	        JR      AN04            ; Jump
2835:	1E2F  3A5A19  	AN1A:   LD      a,(ANBDPS)      ; Prepare to go back a square
2836:	1E32  D603    	        SUB     a,3             ; To get around border
2837:	1E34  FE14    	        CP      a,20            ; Off the other end ?
2838:	1E36  D2D21D  	        JP      NC,AN08         ; No - jump
2839:	1E39  3E62    	        LD      a,98            ; Wrap around to top of screen
2840:	1E3B  C3D21D  	AN0B:   JP      AN08            ; Jump
2841:	1E3E' FFB21AF6	AN1B:   PRTLIN  CRTNES,14       ; Ask if correct
	      180E00
2842:	1E45  CD431D  	        CALL    CHARTR          ; Accept answer
2843:	1E48  FE4E    	        CP      a,4EH           ; Is it "N" ?
2844:	1E4A  CACD1D  	        JP      Z,AN04          ; No - jump
2845:	1E4D  CDA41E  	        CALL    ROYALT          ; Update positions of royalty
2846:	1E50' FFB21A3C	        CLRSCR                  ; Blank screen
	      190100
2847:	1E57  CDB91A  	        CALL    INTERR          ; Accept color choice
2848:	1E5A' FFB21A2B	AN1C:   PRTLIN  WSMOVE,17       ; Ask whose move it is
	      191100
2849:	1E61  CD431D  	        CALL    CHARTR          ; Accept response
2850:	1E64  CDDB1E  	        CALL    DSPBRD          ; Display graphics board
2851:	1E67' FFB21A1B	        PRTLIN  TITLE4,15       ; Put up titles
	      190F00
2852:	1E6E' FFB21A89	        PRTLIN  TITLE3,15
	      180F00
2853:	1E75  FE57    	        CP      a,57H           ; Is is whites move ?
2854:	1E77  CA4C1A  	        JP      Z,DRIV04        ; Yes - jump
2855:	1E7A' FFB31A86	        PRTBLK  MVENUM,3        ; Print move number
	      180300
2856:	1E81' FFB31A7C	        PRTBLK  SPACE,6         ; Tab to blacks column
	      180600
2857:	1E88  3A2000  	        LD      a,(KOLOR)       ; Computer's color
2858:	1E8B  A7      	        AND     a,a             ; Is computer white ?
2859:	1E8C  200B    	        JR      NZ,AN20         ; No - jump
2860:	1E8E  CD711C  	        CALL    PLYRMV          ; Get players move
2861:	1E91' FF921A00	        CARRET                  ; New line
	      00
2862:	1E96  C38F1A  	        JP      DR0C            ; Jump
2863:	1E99  CD211B  	AN20:   CALL    CPTRMV          ; Get computers move
2864:	1E9C' FF921A00	        CARRET                  ; New line
	      00
2865:	1EA1  C38F1A  	        JP      DR0C            ; Jump
2866:			
2867:			;***********************************************************
2868:			; UPDATE POSITIONS OF ROYALTY
2869:			;***********************************************************
2870:			; FUNCTION:   --  To update the positions of the Kings
2871:			;                 and Queen after a change of board position
2872:			;                 in ANALYS.
2873:			;
2874:			; CALLED BY:  --  ANALYS
2875:			;
2876:			; CALLS:      --  None
2877:			;
2878:			; ARGUMENTS:  --  None
2879:			;***********************************************************
2880:	1EA4  214E01  	ROYALT: LD      hl,POSK         ; Start of Royalty array
2881:	1EA7  0604    	        LD      b,4             ; Clear all four positions
2882:	1EA9  3600    	back06: LD      (hl),0
2883:	1EAB  23      	        INC     hl
2884:	1EAC  10FB    	        DJNZ    back06
2885:	1EAE  3E15    	        LD      a,21            ; First board position
2886:	1EB0  320000  	RY04:   LD      (M1),a          ; Set up board index
2887:	1EB3  214E01  	        LD      hl,POSK         ; Address of King position
2888:	1EB6  DD2A0000	        LD      ix,(M1)
2889:	1EBA  DD7EB4  	        LD      a,(ix+BOARD)    ; Fetch board contents
2890:	1EBD  CB7F    	        BIT     7,a             ; Test color bit
2891:	1EBF  2801    	        JR      Z,rel023        ; Jump if white
2892:	1EC1  23      	        INC     hl              ; Offset for black
2893:	1EC2  E607    	rel023: AND     a,7             ; Delete flags, leave piece
2894:	1EC4  FE06    	        CP      a,KING          ; King ?
2895:	1EC6  2806    	        JR      Z,RY08          ; Yes - jump
2896:	1EC8  FE05    	        CP      a,QUEEN         ; Queen ?
2897:	1ECA  2006    	        JR      NZ,RY0C         ; No - jump
2898:	1ECC  23      	        INC     hl              ; Queen position
2899:	1ECD  23      	        INC     hl              ; Plus offset
2900:	1ECE  3A0000  	RY08:   LD      a,(M1)          ; Index
2901:	1ED1  77      	        LD      (hl),a          ; Save
2902:	1ED2  3A0000  	RY0C:   LD      a,(M1)          ; Current position
2903:	1ED5  3C      	        INC     a               ; Next position
2904:	1ED6  FE63    	        CP      a,99            ; Done.?
2905:	1ED8  20D6    	        JR      NZ,RY04         ; No - jump
2906:	1EDA  C9      	        RET                     ; Return
2907:			
2908:			;***********************************************************
2909:			; SET UP EMPTY BOARD
2910:			;***********************************************************
2911:			; FUNCTION:   --  Display graphics board and pieces.
2912:			;
2913:			; CALLED BY:  --  DRIVER
2914:			;                 ANALYS
2915:			;                 PGIFND
2916:			;
2917:			; CALLS:      --  CONVRT
2918:			;                 INSPCE
2919:			;
2920:			; ARGUMENTS:  --  None
2921:			;
2922:			; NOTES:      --  This routine makes use of several fixed
2923:			;                 addresses in the video storage area of
2924:			;                 the Jupiter III computer, and is therefor
2925:			;                 system dependent. Each such reference will
2926:			;                 be marked.
2927:			;***********************************************************
2928:	1EDB  C5      	DSPBRD: PUSH    bc              ; Save registers
2929:	1EDC  D5      	        PUSH    de
2930:	1EDD  E5      	        PUSH    hl
2931:	1EDE  F5      	        PUSH    af
2932:	1EDF' FFB21A3C	        CLRSCR                  ; Blank screen
	      190100
2933:	1EE6  2100C0  	        LD      hl,0C000H       ; System Dependent-First video
2934:			                                ; address
2935:	1EE9  3680    	        LD      (hl),80H        ; Start of blank border
2936:	1EEB  1101C0  	        LD      de,0C001H       ; Sys Dep- Next border square
2937:	1EEE  010F00  	        LD      bc,15           ; Number of bytes to be moved
2938:	1EF1  EDB0    	        LDIR                    ; Blank border bar
2939:	1EF3  36AA    	        LD      (hl),0AAH       ; First black border box
2940:	1EF5  2C      	        INC     l               ; Next block address
2941:	1EF6  0606    	        LD      b,6             ; Number to be moved
2942:	1EF8  3680    	DB04:   LD      (hl),80H        ; Create white block
2943:	1EFA  2C      	        INC     l               ; Next block address
2944:	1EFB  10FB    	        DJNZ    DB04            ; Done ? No - jump
2945:	1EFD  0606    	        LD      b,6             ; Number of repeats
2946:	1EFF  36BF    	DB08:   LD      (hl),0BFH       ; Create black box ???
2947:	1F01  2C      	        INC     l               ; Next block address
2948:	1F02  10FB    	        DJNZ    DB08            ; Done ? No - jump
2949:	1F04  EB      	        EX      de,hl           ; Get ready for block move
2950:	1F05  012400  	        LD      bc,36           ; Bytes to be moved
2951:	1F08  EDB0    	        LDIR                    ; Move - completes first bar
2952:	1F0A  2100C0  	        LD      hl,0C000H       ; S D - First addr to be copied
2953:	1F0D  01D000  	        LD      bc,0D0H         ; Number of blocks to move
2954:	1F10  EDB0    	        LDIR                    ; Completes first rank
2955:	1F12  2116C0  	        LD      hl,0C016H       ; S D - Start of copy area
2956:	1F15  010600  	        LD      bc,6            ; Number of blocks to move
2957:	1F18  EDB0    	        LDIR                    ; First black square done
2958:	1F1A  2110C0  	        LD      hl,0C010H       ; S D - Start copy area
2959:	1F1D  012A00  	        LD      bc,42           ; Bytes to be moved
2960:	1F20  EDB0    	        LDIR                    ; Rest of bar done
2961:	1F22  2100C1  	        LD      hl,0C100H       ; S D - Start of copy area
2962:	1F25  01C000  	        LD      bc,0C0H         ; Move three bars
2963:	1F28  EDB0    	        LDIR                    ; Next rank done
2964:	1F2A  2100C0  	        LD      hl,0C000H       ; S D - Copy rest of screen
2965:	1F2D  010006  	        LD      bc,600H         ; Number of blocks
2966:	1F30  EDB0    	        LDIR                    ; Board done
2967:	1F32  3E15    	BSETUP: LD      a,21            ; First board index
2968:	1F34  325919  	BSET04: LD      (BRDPOS),a      ; Ready parameter
2969:	1F37  CDE01F  	        CALL    CONVRT          ; Norm addr into HL register
2970:	1F3A  CD471F  	        CALL    INSPCE          ; Insert that piece onto board
2971:	1F3D  3C      	        INC     a               ; Next square
2972:	1F3E  FE63    	        CP      a,99            ; Done ?
2973:	1F40  38F2    	        JR      C,BSET04        ; No - jump
2974:	1F42  F1      	        POP     af              ; Restore registers
2975:	1F43  E1      	        POP     hl
2976:	1F44  D1      	        POP     de
2977:	1F45  C1      	        POP     bc
2978:	1F46  C9      	        RET
2979:			
2980:			;***********************************************************
2981:			; INSERT PIECE SUBROUTINE
2982:			;***********************************************************
2983:			; FUNCTION:   --  This subroutine places a piece onto a
2984:			;                 given square on the video board. The piece
2985:			;                 inserted is that stored in the board array
2986:			;                 for that square.
2987:			;
2988:			; CALLED BY:  --  DPSPRD
2989:			;                 MATED
2990:			;
2991:			; CALLS:      --  MLTPLY
2992:			;
2993:			; ARGUMENTS:  --  Norm address for the square in register
2994:			;                 pair HL.
2995:			;***********************************************************
2996:	1F47  E5      	INSPCE: PUSH    hl              ; Save registers
2997:	1F48  C5      	        PUSH    bc
2998:	1F49  D5      	        PUSH    de
2999:	1F4A  DDE5    	        PUSH    ix
3000:	1F4C  F5      	        PUSH    af
3001:	1F4D  3A5919  	        LD      a,(BRDPOS)      ; Get board index
3002:	1F50  320000  	        LD      (M1),a          ; Save
3003:	1F53  DD2A0000	        LD      ix,(M1)         ; Index into board array
3004:	1F57  DD7EB4  	        LD      a,(ix+BOARD)    ; Contents of board array
3005:	1F5A  A7      	        AND     a,a             ; Is square empty ?
3006:	1F5B  287C    	        JR      Z,IP2C          ; Yes - jump
3007:	1F5D  FEFF    	        CP      a,0FFH          ; Is it a border square ?
3008:	1F5F  2878    	        JR      Z,IP2C          ; Yes - jump
3009:	1F61  0E00    	        LD      c,0             ; Clear flag register
3010:	1F63  CB7F    	        BIT     7,a             ; Is piece white ?
3011:	1F65  2802    	        JR      Z,IP04          ; Yes - jump
3012:	1F67  0E02    	        LD      c,2             ; Set black piece flag
3013:	1F69  E607    	IP04:   AND     a,7             ; Delete flags, leave piece
3014:	1F6B  3D      	        DEC     a               ; Piece on a 0 - 5 basis
3015:	1F6C  5F      	        LD      e,a             ; Save
3016:	1F6D  1610    	        LD      d,16            ; Multiplier
3017:	1F6F  CD1620  	        CALL    MLTPLY          ; For loc of piece in table
3018:	1F72  7A      	        LD      a,d             ; Displacement into block table
3019:	1F73  325B19  	        LD      (INDXER),a      ; Low order index byte
3020:	1F76  DD2A5B19	        LD      ix,(INDXER)     ; Get entire index
3021:	1F7A  CB46    	        BIT     0,(hl)          ; Is square white ?
3022:	1F7C  2801    	        JR      Z,IP08          ; Yes - jump
3023:	1F7E  0C      	        INC     c               ; Set complement flag
3024:	1F7F  2C      	IP08:   INC     l               ; Address of first alter block
3025:	1F80  E5      	        PUSH    hl              ; Save
3026:	1F81  1600    	        LD      d,0             ; Bar counter
3027:	1F83  0604    	IP0C:   LD      b,4             ; Block counter
3028:	1F85  DD7E80  	IP10:   LD      a,(ix+BLOCK)    ; Bring in source block
3029:	1F88  CB41    	        BIT     0,c             ; Should it be complemented ?
3030:	1F8A  2802    	        JR      Z,IP14          ; No - jump
3031:	1F8C  EE3F    	        XOR     a,3FH           ; Graphics complement
3032:	1F8E  77      	IP14:   LD      (hl),a          ; Store block
3033:	1F8F  2C      	        INC     l               ; Next block
3034:	1F90  DD23    	        INC     ix              ; Next source block
3035:	1F92  10F1    	        DJNZ    IP10            ; Done ? No - jump
3036:	1F94  7D      	        LD      a,l             ; Bar increment
3037:	1F95  C63C    	        ADD     a,3CH
3038:	1F97  6F      	        LD      l,a
3039:	1F98  14      	        INC     d               ; Bar counter
3040:	1F99  CB52    	        BIT     2,d             ; Done ?
3041:	1F9B  28E6    	        JR      Z,IP0C          ; No - jump
3042:	1F9D  E1      	        POP     hl              ; Address of Norm + 1
3043:	1F9E  CB41    	        BIT     0,c             ; Is square white ?
3044:	1FA0  2006    	        JR      NZ,IP18         ; No - jump
3045:	1FA2  CB49    	        BIT     1,c             ; Is piece white ?
3046:	1FA4  2033    	        JR      NZ,IP2C         ; No - jump
3047:	1FA6  1804    	        JR      IP1C            ; Jump
3048:	1FA8  CB49    	IP18:   BIT     1,c             ; Is piece white ?
3049:	1FAA  282D    	        JR      Z,IP2C          ; Yes - jump
3050:	1FAC  1606    	IP1C:   LD      d,6             ; Multiplier
3051:	1FAE  CD1620  	        CALL    MLTPLY          ; Multiply for displacement
3052:	1FB1  7A      	        LD      a,d             ; Kernel table displacement
3053:	1FB2  325B19  	        LD      (INDXER),a      ; Save
3054:	1FB5  DD2A5B19	        LD      ix,(INDXER)     ; Get complete index
3055:	1FB9  7D      	        LD      a,l             ; Start of Kernel
3056:	1FBA  C640    	        ADD     a,40H
3057:	1FBC  6F      	        LD      l,a
3058:	1FBD  1600    	        LD      d,0             ; Bar counter
3059:	1FBF  0603    	IP20:   LD      b,3             ; Block counter
3060:	1FC1  DD7EF0  	IP24:   LD      a,(ix+KERNEL)   ; Kernel block
3061:	1FC4  CB49    	        BIT     1,c             ; Need to complement ?
3062:	1FC6  2002    	        JR      NZ,IP28         ; No - jump
3063:	1FC8  EE3F    	        XOR     a,3FH           ; Graphics complement
3064:	1FCA  77      	IP28:   LD      (hl),a          ; Store block
3065:	1FCB  2C      	        INC     l               ; Next target block
3066:	1FCC  DD23    	        INC     ix              ; Next source block
3067:	1FCE  10F1    	        DJNZ    IP24            ; Done ? No - jump
3068:	1FD0  7D      	        LD      a,l             ; Bar increment
3069:	1FD1  C63D    	        ADD     a,3DH
3070:	1FD3  6F      	        LD      l,a
3071:	1FD4  14      	        INC     d               ; Bar counter
3072:	1FD5  CB4A    	        BIT     1,d             ; Done ?
3073:	1FD7  28E6    	        JR      Z,IP20          ; Repeat bar move
3074:	1FD9  F1      	IP2C:   POP     af              ; Restore registers
3075:	1FDA  DDE1    	        POP     ix
3076:	1FDC  D1      	        POP     de
3077:	1FDD  C1      	        POP     bc
3078:	1FDE  E1      	        POP     hl
3079:	1FDF  C9      	        RET
3080:			
3081:			;***********************************************************
3082:			; BOARD INDEX TO NORM ADDRESS SUBR.
3083:			;***********************************************************
3084:			; FUNCTION:   --  Converts a hexadecimal board index into
3085:			;                 a Norm address for the square.
3086:			;
3087:			; CALLED BY:  --  DSPBRD
3088:			;                 INSPCE
3089:			;                 ANALYS
3090:			;                 MATED
3091:			;
3092:			; CALLS:      --  DIVIDE
3093:			;                 MLTPLY
3094:			;
3095:			; ARGUMENTS:   -- Returns the Norm address in register pair
3096:			;                 HL.
3097:			;***********************************************************
3098:	1FE0  C5      	CONVRT: PUSH    bc              ; Save registers
3099:	1FE1  D5      	        PUSH    de
3100:	1FE2  F5      	        PUSH    af
3101:	1FE3  3A5919  	        LD      a,(BRDPOS)      ; Get board index
3102:	1FE6  57      	        LD      d,a             ; Set up dividend
3103:	1FE7  97      	        SUB     a,a
3104:	1FE8  1E0A    	        LD      e,10            ; Divisor
3105:	1FEA  CD0420  	        CALL    DIVIDE          ; Index into rank and file
3106:			                                ; file (1-8) & rank (2-9)
3107:	1FED  15      	        DEC     d               ; For rank (1-8)
3108:	1FEE  3D      	        DEC     a               ; For file (0-7)
3109:	1FEF  4A      	        LD      c,d             ; Save
3110:	1FF0  1606    	        LD      d,6             ; Multiplier
3111:	1FF2  5F      	        LD      e,a             ; File number is multiplicand
3112:	1FF3  CD1620  	        CALL    MLTPLY          ; Giving file displacement
3113:	1FF6  7A      	        LD      a,d             ; Save
3114:	1FF7  C610    	        ADD     a,10H           ; File norm address
3115:	1FF9  6F      	        LD      l,a             ; Low order address byte
3116:	1FFA  3E08    	        LD      a,8             ; Rank adjust
3117:	1FFC  91      	        SUB     a,c             ; Rank displacement
3118:	1FFD  C6C0    	        ADD     a,0C0H          ; Rank Norm address
3119:	1FFF  67      	        LD      h,a             ; High order addres byte
3120:	2000  F1      	        POP     af              ; Restore registers
3121:	2001  D1      	        POP     de
3122:	2002  C1      	        POP     bc
3123:	2003  C9      	        RET                     ; Return
3124:			
3125:			;***********************************************************
3126:			; POSITIVE INTEGER DIVISION
3127:			;   inputs hi=A lo=D, divide by E
3128:			;   output D, remainder in A
3129:			;***********************************************************
3130:	2004  C5      	DIVIDE: PUSH    bc
3131:	2005  0608    	        LD      b,8
3132:	2007  CB22    	DD04:   SLA     d
3133:	2009  17      	        RLA
3134:	200A  93      	        SUB     a,e
3135:	200B  FA1120  	        JP      M,rel027
3136:	200E  14      	        INC     d
3137:	200F  1801    	        JR      rel024
3138:	2011  83      	rel027: ADD     a,e
3139:	2012  10F3    	rel024: DJNZ    DD04
3140:	2014  C1      	        POP     bc
3141:	2015  C9      	        RET
3142:			
3143:			;***********************************************************
3144:			; POSITIVE INTEGER MULTIPLICATION
3145:			;   inputs D, E
3146:			;   output hi=A lo=D
3147:			;***********************************************************
3148:	2016  C5      	MLTPLY: PUSH    bc
3149:	2017  97      	        SUB     a,a
3150:	2018  0608    	        LD      b,8
3151:	201A  CB42    	ML04:   BIT     0,d
3152:	201C  2801    	        JR      Z,rel025
3153:	201E  83      	        ADD     a,e
3154:	201F  CB2F    	rel025: SRA     a
3155:	2021  CB1A    	        RR      d
3156:	2023  10F5    	        DJNZ    ML04
3157:	2025  C1      	        POP     bc
3158:	2026  C9      	        RET
3159:			
3160:			;***********************************************************
3161:			; SQUARE BLINKER
3162:			;***********************************************************
3163:			;
3164:			; FUNCTION:   --  To blink the graphics board square to signal
3165:			;                 a piece's intention to move, or to high-
3166:			;                 light the square as being alterable
3167:			;                 in ANALYS.
3168:			;
3169:			; CALLED BY:  --  MAKEMV
3170:			;                 ANALYS
3171:			;                 MATED
3172:			;
3173:			; CALLS:      --  None
3174:			;
3175:			; ARGUMENTS:  --  Norm address of desired square passed in register
3176:			;                 pair HL. Number of times to blink passed in
3177:			;                 register B.
3178:			;***********************************************************
3179:	2027  F5      	BLNKER: PUSH    af              ; Save registers
3180:	2028  C5      	        PUSH    bc
3181:	2029  D5      	        PUSH    de
3182:	202A  E5      	        PUSH    hl
3183:	202B  DDE5    	        PUSH    ix
3184:	202D  225D19  	        LD      (NORMAD),hl     ; Save Norm address
3185:	2030  1600    	BL04:   LD      d,0             ; Bar counter
3186:	2032  0E00    	BL08:   LD      c,0             ; Block counter
3187:	2034  7E      	BL0C:   LD      a,(hl)          ; Fetch block
3188:	2035  EE3F    	        XOR     a,3FH           ; Graphics complement
3189:	2037  77      	        LD      (hl),a          ; Replace block
3190:	2038  2C      	        INC     l               ; Next block address
3191:	2039  0C      	        INC     c               ; Increment block counter
3192:	203A  79      	        LD      a,c
3193:	203B  FE06    	        CP      a,6             ; Done ?
3194:	203D  20F5    	        JR      NZ,BL0C         ; No - jump
3195:	203F  7D      	        LD      a,l             ; Address
3196:	2040  C63A    	        ADD     a,3AH           ; Adjust square position
3197:	2042  6F      	        LD      l,a             ; Replace address
3198:	2043  14      	        INC     d               ; Increment bar counter
3199:	2044  CB52    	        BIT     2,d             ; Done ?
3200:	2046  28EA    	        JR      Z,BL08          ; No - jump
3201:	2048  2A5D19  	        LD      hl,(NORMAD)     ; Get Norm address
3202:	204B  C5      	        PUSH    bc              ; Save register
3203:	204C  013030  	        LD      bc,3030H        ; Delay loop, for visibility
3204:	204F  10FE    	BL10:   DJNZ    BL10
3205:	2051  0D      	        DEC     c
3206:	2052  20FB    	        JR      NZ,BL10
3207:	2054  C1      	        POP     bc              ; Restore register
3208:	2055  10D9    	        DJNZ    BL04            ; Done ? No - jump
3209:	2057  DDE1    	        POP     ix              ; Restore registers
3210:	2059  E1      	        POP     hl
3211:	205A  D1      	        POP     de
3212:	205B  C1      	        POP     bc
3213:	205C  F1      	        POP     af
3214:	205D  C9      	        RET                     ; Return
3215:			
3216:			;***********************************************************
3217:			; EXECUTE MOVE SUBROUTINE
3218:			;***********************************************************
3219:			; FUNCTION:   --  This routine is the control routine for
3220:			;                 MAKEMV. It checks for double moves and
3221:			;                 sees that they are properly handled. It
3222:			;                 sets flags in the B register for double
3223:			;                 moves:
3224:			;                       En Passant -- Bit 0
3225:			;                       O-O        -- Bit 1
3226:			;                       O-O-O      -- Bit 2
3227:			;
3228:			; CALLED BY:   -- PLYRMV
3229:			;                 CPTRMV
3230:			;
3231:			; CALLS:       -- MAKEMV
3232:			;
3233:			; ARGUMENTS:   -- Flags set in the B register as described
3234:			;                 above.
3235:			;***********************************************************
3236:	205E  DDE5    	EXECMV: PUSH    ix              ; Save registers
3237:	2060  F5      	        PUSH    af
3238:	2061  DD2A1600	        LD      ix,(MLPTRJ)     ; Index into move list
3239:	2065  DD4E02  	        LD      c,(ix+MLFRP)    ; Move list "from" position
3240:	2068  DD5E03  	        LD      e,(ix+MLTOP)    ; Move list "to" position
3241:	206B  CDA220  	        CALL    MAKEMV          ; Produce move
3242:	206E  DD5604  	        LD      d,(ix+MLFLG)    ; Move list flags
3243:	2071  0600    	        LD      b,0
3244:	2073  CB72    	        BIT     6,d             ; Double move ?
3245:	2075  2827    	        JR      Z,EX14          ; No - jump
3246:	2077  110600  	        LD      de,6            ; Move list entry width
3247:	207A  DD19    	        ADD     ix,de           ; Increment MLPTRJ
3248:	207C  DD4E02  	        LD      c,(ix+MLFRP)    ; Second "from" position
3249:	207F  DD5E03  	        LD      e,(ix+MLTOP)    ; Second "to" position
3250:	2082  7B      	        LD      a,e             ; Get "to" position
3251:	2083  B9      	        CP      a,c             ; Same as "from" position ?
3252:	2084  2003    	        JR      NZ,EX04         ; No - jump
3253:	2086  04      	        INC     b               ; Set en passant flag
3254:	2087  1812    	        JR      EX10            ; Jump
3255:	2089  FE1A    	EX04:   CP      a,1AH           ; White O-O ?
3256:	208B  2004    	        JR      NZ,EX08         ; No - jump
3257:	208D  CBC8    	        SET     1,b             ; Set O-O flag
3258:	208F  180A    	        JR      EX10            ; Jump
3259:	2091  FE60    	EX08:   CP      a,60H           ; Black 0-0 ?
3260:	2093  2004    	        JR      NZ,EX0C         ; No - jump
3261:	2095  CBC8    	        SET     1,b             ; Set 0-0 flag
3262:	2097  1802    	        JR      EX10            ; Jump
3263:	2099  CBD0    	EX0C:   SET     2,b             ; Set 0-0-0 flag
3264:	209B  CDA220  	EX10:   CALL    MAKEMV          ; Make 2nd move on board
3265:	209E  F1      	EX14:   POP     af              ; Restore registers
3266:	209F  DDE1    	        POP     ix
3267:	20A1  C9      	        RET                     ; Return
3268:			
3269:			;***********************************************************
3270:			; MAKE MOVE SUBROUTINE
3271:			;***********************************************************
3272:			; FUNCTION:   --  Moves the piece on the board when a move
3273:			;                 is made. It blinks both the "from" and
3274:			;                 "to" positions to give notice of the move.
3275:			;
3276:			; CALLED BY:  --  EXECMV
3277:			;
3278:			; CALLS:      --  CONVRT
3279:			;                 BLNKER
3280:			;                 INSPCE
3281:			;
3282:			; ARGUMENTS:  --  The "from" position is passed in register
3283:			;                 C, and the "to" position in register E.
3284:			;***********************************************************
3285:	20A2  F5      	MAKEMV: PUSH    af              ; Save register
3286:	20A3  C5      	        PUSH    bc
3287:	20A4  D5      	        PUSH    de
3288:	20A5  E5      	        PUSH    hl
3289:	20A6  79      	        LD      a,c             ; "From" position
3290:	20A7  325919  	        LD      (BRDPOS),a      ; Set up parameter
3291:	20AA  CDE01F  	        CALL    CONVRT          ; Getting Norm address in HL
3292:	20AD  060A    	        LD      b,10            ; Blink parameter
3293:	20AF  CD2720  	        CALL    BLNKER          ; Blink "from" square
3294:	20B2  7E      	        LD      a,(hl)          ; Bring in Norm 1plock
3295:	20B3  2C      	        INC     l               ; First change block
3296:	20B4  1600    	        LD      d,0             ; Bar counter
3297:	20B6  0604    	MM04:   LD      b,4             ; Block counter
3298:	20B8  77      	MM08:   LD      (hl),a          ; Insert blank block
3299:	20B9  2C      	        INC     l               ; Next change block
3300:	20BA  10FC    	        DJNZ    MM08            ; Done ? No - jump
3301:	20BC  4F      	        LD      c,a             ; Saving norm block
3302:	20BD  7D      	        LD      a,l             ; Bar increment
3303:	20BE  C63C    	        ADD     a,3CH
3304:	20C0  6F      	        LD      l,a
3305:	20C1  79      	        LD      a,c             ; Restore Norm block
3306:	20C2  14      	        INC     d
3307:	20C3  CB52    	        BIT     2,d             ; Done ?
3308:	20C5  28EF    	        JR      Z,MM04          ; No - jump
3309:	20C7  7B      	        LD      a,e             ; Get "to" position
3310:	20C8  325919  	        LD      (BRDPOS),a      ; Set up parameter
3311:	20CB  CDE01F  	        CALL    CONVRT          ; Getting Norm address in HL
3312:	20CE  060A    	        LD      b,10            ; Blink parameter
3313:	20D0  CD471F  	        CALL    INSPCE          ; Inserts the piece
3314:	20D3  CD2720  	        CALL    BLNKER          ; Blinks "to" square
3315:	20D6  E1      	        POP     hl              ; Restore registers
3316:	20D7  D1      	        POP     de
3317:	20D8  C1      	        POP     bc
3318:	20D9  F1      	        POP     af
3319:	20DA  C9      	        RET                     ; Return
3320:	20DB          	        .END



Statistics:

     4	passes
     0	jr promotions
   365	symbols
  4893	bytes

    55	macro calls
   363	macro bytes
     0	invented symbols



Symbol Table:

adjptr           c82     
admove           d10     
again           18e0     
am10             d4f     
an04            1dcd     
an08            1dd2     
an0b            1e3b     
an18            1e1f     
an19            1e25     
an1a            1e2f     
an1b            1e3e     
an1c            1e5a     
an20            1e99     
analys          1db8     
anamsg          1822     
anbdps          195a     
as19             ea6     
as20             eaf     
as25             eb4     
ascend          140a     
asntbi          1cc7     
at04            1cea     
at10             dcf     
at12             de3     
at13             de8     
at14             df9     
at14a            dea     
at14b            df3     
at15             e0b     
at16             e17     
at20             e39     
at21             e40     
at25             e47     
at30             e4c     
at31             e5c     
at32             e5f     
at5              dc4     
atklst           12c     
atksav           e6f     
attack           db9     
back01           b05     
back02           f6d     
back03          1007     
back04          1086     
back05          12e9     
back06          1ea9     
bact           = 133     
bc0               31     
bestm             1a     
bishop         =   3     
bitasn          1c62     
bl04            2030     
bl08            2032     
bl0c            2034     
bl10            204f     
black          =  80     
blankr          193c     
blbase         = 200     
blnker          2027     
block          =ffffff80 
bm5             145c     
bm9             1479     
bmoves            34     
board          =ffffffb4 
boarda            b4     
book            143e     
bpawn          =  81     
brdc              2c     
brdpos          1959     
bset04          1f34     
bsetup          1f32     
ca10             cb8     
ca15             cd6     
ca20             d06     
ca5              ca0     
castle           c92     
chartr          1d43     
ckflg             29     
ckmsg           18c0     
clrmsg          1847     
color             21     
convrt          1fe0     
cp0c            1b36     
cp10            1b57     
cp1c            1b78     
cp24            1ba3     
cptrmv          1b21     
crtnes          18f6     
db04            1ef8     
db08            1eff     
dcount         =ffffff9f 
dd04            2007     
direct         =ffffff80 
divide          2004     
dpoint         =ffffff98 
dr08            1a75     
dr0c            1a8f     
dr10            1a9f     
dr14            1ab2     
driv01          1a11     
driv04          1a4c     
driver          1a00     
dspbrd          1edb     
enpsnt           c1d     
ev10            12b4     
ev5             12ae     
eval            129e     
ex04            2089     
ex08            2091     
ex0c            2099     
ex10            209b     
ex14            209e     
execmv          205e     
fcdmat          1baf     
fm04            1bd6     
fm08            1be4     
fm09            1be9     
fm0c            1bfa     
fm15            1320     
fm18            1363     
fm19            1370     
fm25            138d     
fm30            13a6     
fm35            13ba     
fm36            13c6     
fm37            13ce     
fm40            1404     
fm5             1305     
fndmov          12b8     
genmov           d56     
gm10             d8e     
gm5              d71     
grttng          1800     
ib2              b10     
in04            1ae8     
in08            1b03     
inchk            d98     
inchk1           d9b     
indx1              e     
indx2             10     
indxer          195b     
initbd           b00     
inspce          1f47     
interr          1ab9     
inval1          1944     
inval2          1950     
ip04            1f69     
ip08            1f7f     
ip0c            1f83     
ip10            1f85     
ip14            1f8e     
ip18            1fa8     
ip1c            1fac     
ip20            1fbf     
ip24            1fc1     
ip28            1fca     
ip2c            1fd9     
iwin            18db     
kernel         =fffffff0 
king           =   6     
knight         =   2     
kolor             20     
lim10           116f     
limit           1164     
linect          195f     
m1                 0     
m2                 2     
m3                 4     
m4                 6     
ma08            1d8d     
ma0c            1dac     
makemv          20a2     
mated           1d7c     
matef             2a     
ml04            201a     
mlend          = af8     
mlflg          =   4     
mlfrp          =   2     
mlist            300     
mllst             1c     
mlnxt             1e     
mlptr          =   0     
mlptri            14     
mlptrj            16     
mltop          =   3     
mltply          2016     
mlval          =   5     
mm04            20b6     
mm08            20b8     
move            1173     
moveno            26     
mp10             ba1     
mp15             bc2     
mp20             bcf     
mp25             be4     
mp26             be9     
mp30             bf9     
mp31             bfc     
mp35             c02     
mp36             c17     
mp37             c10     
mp5              b98     
mpiece           b7a     
mtmsg           18c5     
mtpl            18cd     
mtrl              30     
mv0               32     
mv1             1178     
mv10            11b8     
mv15            11bb     
mv20            11c0     
mv21            11c3     
mv22            11c8     
mv30            11cf     
mv40            11db     
mv5             1199     
mvemsg          18b1     
mvenum          1886     
nextad           ffc     
normad          195d     
npins             12     
nply              28     
nx6             100f     
o_o             18b6     
o_o_o           18bb     
p1                22     
p2                23     
p3                24     
p_pep           193f     
pa1              b74     
pa2              b77     
path             b4c     
pawn           =   1     
pc1              ec3     
pc3              edb     
pc5              ee0     
pcs             18ce     
pf1              eeb     
pf10             f44     
pf15             f4d     
pf19             f5a     
pf2              f0a     
pf20             f92     
pf25             fa3     
pf26             fa7     
pf27             fab     
pf5              f17     
pgifnd          1d5d     
pieces         =ffffffac 
pinfnd           ee4     
pl08            1ca6     
plist          =  39     
plista           13a     
plistd         =  43     
plydep          1904     
plyix            15f     
plymax            27     
plyrmv          1c71     
pmate             25     
pnck             eb7     
points          1011     
posk             14e     
posq             150     
pt20            10cd     
pt23            10dc     
pt25            10eb     
pt25a           1104     
pt5             102b     
pt6a            1068     
pt6aa           1059     
pt6b            106f     
pt6c            1073     
pt6d            107b     
pt6x            1080     
ptsck             33     
ptsl              2d     
ptsw1             2e     
ptsw2             2f     
pvalue         =ffffffa5 
queen          =   5     
rel001           b82     
rel002           c29     
rel003           c59     
rel004           d32     
rel005           da2     
rel006           e8b     
rel007           e94     
rel008           f87     
rel009           fbd     
rel010           ff4     
rel011          10d5     
rel012          10e6     
rel013          110b     
rel014          111b     
rel015          1125     
rel016          1157     
rel017          134c     
rel018          137f     
rel019          1419     
rel020          1b64     
rel021          1b71     
rel022          1e13     
rel023          1ec2     
rel024          2012     
rel025          201f     
rel026          1144     
rel027          2011     
rel23           1d89     
rook           =   4     
royalt          1ea4     
ry04            1eb0     
ry08            1ece     
ry0c            1ed2     
score            153     
scrix             18     
sortm           1262     
space           187c     
sr10            1274     
sr15            1282     
sr25            1294     
sr30            129a     
sr5             1269     
stack            2ff     
start              0     
t1                 8     
t2                 a     
t3                 c     
tbase          = 100     
tbcpcl          1c26     
tbcpmv          1c4e     
tbplcl          1c12     
tbplmv          1c3a     
title1          1870     
title2          1876     
title3          1889     
title4          191b     
um1             11ea     
um10            122e     
um15            1233     
um16            1238     
um20            123d     
um21            1240     
um22            1245     
um30            124c     
um40            1258     
um5             120b     
um6             120f     
unmove          11e5     
uwin            18d4     
va10            1d3c     
va5             1d0b     
va6             1d1b     
va7             1d2a     
va8             1d37     
va9             1d39     
valm              2b     
valmov          1cec     
wact           = 12c     
white          =   0     
wsmove          192b     
xc10             fd4     
xc15             fe0     
xc18             fec     
xc19             fee     
xchng            fae     


